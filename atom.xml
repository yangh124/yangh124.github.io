<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>yangh&#39;s Blog</title>
  
  
  <link href="https://yangh124.github.io/atom.xml" rel="self"/>
  
  <link href="https://yangh124.github.io/"/>
  <updated>2024-10-06T04:17:44.117Z</updated>
  <id>https://yangh124.github.io/</id>
  
  <author>
    <name>yangh</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Docker安装ImmotalWrt教程</title>
    <link href="https://yangh124.github.io/2024/10/02/Dock%E5%AE%89%E8%A3%85ImmotalWrt/"/>
    <id>https://yangh124.github.io/2024/10/02/Dock%E5%AE%89%E8%A3%85ImmotalWrt/</id>
    <published>2024-10-01T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.117Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><ul><li>服务器：Ubuntu 22.04.5 LTS (GNU&#x2F;Linux 6.8.0-45-generic x86_64)</li><li>Docker版本：24.0.5（snap安装：<code>sudo snap install docker</code>）</li></ul><h2 id="下载ImmortalWrt"><a href="#下载ImmortalWrt" class="headerlink" title="下载ImmortalWrt"></a>下载ImmortalWrt</h2><p>下载地址：<a href="https://downloads.immortalwrt.org/">ImmtoalWrt Downloads</a></p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002080246.png" alt="iShot_2024-10-02_08.02.46"><br>选择最新稳定版本。点击对应版本链接，依次进入目录x86 -&gt; 64（其他架构请自行选择），下载rootfs.tar.gz。我当前版本的地址是：<a href="https://downloads.immortalwrt.org/releases/23.05.4/targets/x86/64/immortalwrt-23.05.4-x86-64-rootfs.tar.gz">rootfs.tar.gz</a>。<br><strong>至此，ImmtoalWrt下载完成。</strong></p><h2 id="制作Docker镜像"><a href="#制作Docker镜像" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h2><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol><li>创建工作目录<br>在当前登录用户下创建，<strong>注意修改为你当前用户名</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/yh/immotalWrt</span><br></pre></td></tr></table></figure></li><li>将下载的ImmtoalWrt上传至该目录，并重命名为openwrt.tar.gz</li><li>创建Dockerfile<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line"></span><br><span class="line"># author info </span><br><span class="line">LABEL author=yh</span><br><span class="line">LABEL email=yh.124@qq.com</span><br><span class="line"></span><br><span class="line">ADD openwrt.tar.gz /</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line">CMD [&quot;/sbin/init&quot;]</span><br></pre></td></tr></table></figure></li><li>文件结构<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yh@yh-ubuntu:~/immotalWrt$ ll</span><br><span class="line">total 11092</span><br><span class="line">drwxrwxr-x  2 yh yh     4096 10月  2 08:37 ./</span><br><span class="line">drwxr-x--- 17 yh yh     4096 10月  2 08:37 ../</span><br><span class="line">-rw-rw-r--  1 yh yh      135 10月  2 08:36 Dockerfile</span><br><span class="line">-rw-r--r--  1 yh yh 11344000 10月  2 08:23 openwrt.tar.gz</span><br></pre></td></tr></table></figure></li></ol><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># sudo docker build $&#123;安装文件所在目录&#125; -t $&#123;镜像名称&#125;</span><br><span class="line">sudo docker build /home/yh/immotalWrt -t openwrt</span><br><span class="line"></span><br><span class="line"># 查看镜像</span><br><span class="line">yh@yh-ubuntu:~/immotalWrt$ sudo docker images</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">openwrt      latest    7d75d3e47dc8   10 hours ago   31.1MB</span><br></pre></td></tr></table></figure><p><strong>至此，immotalwrt镜像构建完成</strong></p><h2 id="设置网络"><a href="#设置网络" class="headerlink" title="设置网络"></a>设置网络</h2><ol><li>打开网卡混杂模式<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 请自行替换自己的网卡名称（修改enp4s0）</span><br><span class="line">sudo ip link set enp4s0 promisc on</span><br></pre></td></tr></table></figure></li><li>创建Docker network<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 我的路由器地址为192.168.3.1。请自行修改相关参数（子网地址、网关地址、网卡）</span><br><span class="line">sudo docker network create -d macvlan --subnet=192.168.3.0/24 --gateway=192.168.3.1 -o parent=enp4s0 openwrt</span><br></pre></td></tr></table></figure><strong>至此，网络配置完成</strong></li></ol><h2 id="启动openwrt"><a href="#启动openwrt" class="headerlink" title="启动openwrt"></a>启动openwrt</h2><h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 自行替换相应参数（容器名称、网络名称、镜像名称）</span><br><span class="line">sudo docker run --restart always --name openwrt -d --network openwrt --privileged openwrt</span><br><span class="line"># 查看容器</span><br><span class="line">yh@yh-ubuntu:~/immotalWrt$ sudo docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND        CREATED         STATUS         PORTS     NAMES</span><br><span class="line">b08428b5b80d   openwrt   &quot;/sbin/init&quot;   8 seconds ago   Up 7 seconds             openwrt</span><br></pre></td></tr></table></figure><h3 id="修改容器内网络"><a href="#修改容器内网络" class="headerlink" title="修改容器内网络"></a>修改容器内网络</h3><ol><li>进入容器<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 进入容器（自行替换容器id）</span><br><span class="line">sudo docker exec -it b08428b5b80d /bin/sh</span><br></pre></td></tr></table></figure></li><li>修改网络，执行<code>vi /etc/config/network</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 修改lan配置（自行参照修改，注意ipaddr要使用未被占用的）,修改完成后保存</span><br><span class="line">config interface &#x27;lan&#x27;</span><br><span class="line">        option device &#x27;br-lan&#x27;</span><br><span class="line">        option proto &#x27;static&#x27;</span><br><span class="line">        option ipaddr &#x27;192.168.3.109&#x27;</span><br><span class="line">        option netmask &#x27;255.255.255.0&#x27;</span><br><span class="line">        option ip6assign &#x27;60&#x27;</span><br><span class="line">        option gateway &#x27;192.168.3.1&#x27;</span><br><span class="line">        option dns &#x27;192.168.3.1&#x27;</span><br></pre></td></tr></table></figure></li><li>重启容器内网络，<code>/etc/init.d/network restart</code>,或者重启容器<code>sudo docker restart b08428b5b80d</code><br><strong>至此容器内网络配置完成</strong></li></ol><h3 id="初始化设置"><a href="#初始化设置" class="headerlink" title="初始化设置"></a>初始化设置</h3><p>访问<a href="192.168.3.109">192.168.3.109</a><br><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002090531.png" alt="iShot_2024-10-02_09.05.31"></p><p>第一次登录无需密码，直接点击登录，进入系统后自行初始化密码。</p><h4 id="软件包初始化"><a href="#软件包初始化" class="headerlink" title="软件包初始化"></a>软件包初始化</h4><p>依次点击进入系统-&gt; 软件包<br><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002091824.png" alt="iShot_2024-10-02_09.18.24"><br>更新软件包会报错，提示未安装wget-ssl，需要手动安装wget-ssl及其依赖。下载仓库地址：<a href="https://pkgs.org/search/?q=wget-ssl">pkgs.org</a>。</p><ol><li>选择x86版本<br><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002092207.png" alt="iShot_2024-10-02_09.22.07"></li><li>找到下载地址，复制地址下载至本地<br><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002092422.png" alt="iShot_2024-10-02_09.24.22"></li><li>上传软件包并安装<br><strong>如安装报错请自行按照提示信息安装相关其他依赖</strong><br><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002092621.png" alt="iShot_2024-10-02_09.26.21"><br>wget-ssl 及其依赖</li></ol><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002092951.png" alt="iShot_2024-10-02_09.29.51"><br>4. 点击更新列表<br>没有报错，代表更新完成</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002093204.png" alt="iShot_2024-10-02_09.32.04"><br><strong>至此，软件包初始化完成</strong></p><h4 id="安装theme-argon-软件包"><a href="#安装theme-argon-软件包" class="headerlink" title="安装theme-argon 软件包"></a>安装theme-argon 软件包</h4><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/10/02/ishot20241002093423.png" alt="iShot_2024-10-02_09.34.23"><br>安装完成刷新浏览器页面<br><strong>至此，immotalwrt安装完成✌️</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;服务器：Ubuntu 22.04.5 LTS (GNU&amp;#x2F;Linux 6.8.0-45-generic </summary>
      
    
    
    
    <category term="其他" scheme="https://yangh124.github.io/categories/%E5%85%B6%E4%BB%96/"/>
    
    
  </entry>
  
  <entry>
    <title>Camunda</title>
    <link href="https://yangh124.github.io/2024/03/27/Camunda/"/>
    <id>https://yangh124.github.io/2024/03/27/Camunda/</id>
    <published>2024-03-26T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.114Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Camunda是一个基于java的框架，支持用于工作流和过程自动化的BPMN、用于案例管理的CMMN和用于商业决策管理的DMN。</p><ul><li>BPMN ： Business Process Management And Notation 业务流程管理和符号</li><li>CMMN ： Case Management Mode And Notation 案例管理模型和符号</li><li>DMN ： Decision Management And Notation 决策管理和符号</li></ul><h2 id="Camunda-组件"><a href="#Camunda-组件" class="headerlink" title="Camunda 组件"></a>Camunda 组件</h2><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164107.png" alt="Camunda 组件"></p><p>)</p><h3 id="Process-Engine-Infrastructure"><a href="#Process-Engine-Infrastructure" class="headerlink" title="Process Engine &amp; Infrastructure"></a>Process Engine &amp; Infrastructure</h3><ul><li>流程引擎 流程引擎是负责执行BPMN 2.0流程、CMMN 1.1案例和DMN 1.3决策的Java库。它有一个轻量级的POJO核心，并使用关系数据库来持久性。 orm映射由mybatis映射框架提供。</li><li>Spring 框架集成</li><li>CDI&#x2F;Java EE 集成</li><li>Runtime 容器集成 (与应用服务器基础架构集成。)</li></ul><h3 id="Modeler"><a href="#Modeler" class="headerlink" title="Modeler"></a>Modeler</h3><ul><li>Camunda Modeler: BPMN 2.0和CMMN 1.1图表以及DMN 1.3决策表的建模工具。</li><li>bpmn.io: 用于建模框架和工具包的开源项目</li></ul><h3 id="Web-Applications"><a href="#Web-Applications" class="headerlink" title="Web Applications"></a>Web Applications</h3><ul><li>REST API：REST API允许您从远程应用程序或JavaScript应用程序中使用流程引擎。</li><li>Camunda Tasklist：一个用于人工管理工作流和用户任务的web应用程序，它允许流程参与者检查他们的工作流任务并导航到任务表单，以便处理任务并提供数据输入。</li><li>Camunda Cockpit：是一个用于流程监视和操作的web应用程序，它允许您搜索流程实例、检查它们的状态并修复损坏的实例。</li><li>Camunda Admin：一个web应用程序，允许您管理用户、组和授权。</li></ul><h2 id="流程引擎集成"><a href="#流程引擎集成" class="headerlink" title="流程引擎集成"></a>流程引擎集成</h2><p>通过提供的 Spring Boot starters，Camunda引擎可以在Spring Boot应用程序中使用。</p><p>文档地址：<a href="https://docs.camunda.org/manual/7.19/user-guide/spring-boot-integration/">Spring Boot Integration | docs.camunda.org</a></p><h2 id="流程引擎概念"><a href="#流程引擎概念" class="headerlink" title="流程引擎概念"></a>流程引擎概念</h2><h3 id="Process-Definitions"><a href="#Process-Definitions" class="headerlink" title="Process Definitions"></a>Process Definitions</h3><p>流程定义定义了流程的结构。你可以说流程定义就是流程。Camunda平台使用BPMN 2.0作为建模流程定义的主要建模语言。</p><h3 id="Process-Instances"><a href="#Process-Instances" class="headerlink" title="Process Instances"></a>Process Instances</h3><p>流程实例是流程定义的单个执行。流程实例与流程定义的关系与面向对象编程中对象与类的关系相同（在这个类比中，流程实例扮演对象的角色，流程定义扮演类的角色）。</p><h3 id="Executions"><a href="#Executions" class="headerlink" title="Executions"></a>Executions</h3><p>如果你的流程实例包含多个执行路径（例如并行网关），你必须能够区分流程实例内当前的活动路径。在下面的例子中，两个用户任务“receive payment”和“ship order”可以同时执行。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164126.png" alt="Executions"></p><p>在内部实现中，流程引擎在流程实例遇到并行网关时会创建两个并发的执行，每个并发的执行都有一个执行路径。 或者“作用域”（scopes）也会创建新的执行，例如，如果流程引擎到达一个嵌入式<strong>子流程</strong>，就会创建执行。 或者<strong>多实例</strong>也会创建新的执行。</p><p>执行是分层次的，一个流程实例内的所有执行组成一棵树，流程实例是树上的根节点。注意：流程实例本身就是一个执行。执行属于变量范围, 意味着动态数据可以与之关联。</p><h3 id="Activity-Instances"><a href="#Activity-Instances" class="headerlink" title="Activity Instances"></a>Activity Instances</h3><p>活动实例的概念与执行的概念相似，但采取了不同的视角。执行可以被想象成在流程中移动的 “token”，而活动实例则代表一个活动（任务、子流程…）的单个实例。因此，活动实例的概念更加倾向“面向状态（state-oriented）”。</p><p>活动实例也构成一棵树，遵循 BPMN 2.0 所提供的范围标准。处于 “同一层次的子流程”（即，同一范围的一部分，包含在同一子流程中）的活动，其活动实例会处于树的同一层次。</p><h3 id="Jobs-and-Job-Definitions"><a href="#Jobs-and-Job-Definitions" class="headerlink" title="Jobs and Job Definitions"></a>Jobs and Job Definitions</h3><p>Camunda流程引擎包括一个名为“Job执行器（Job Executor）”的组件。Job执行器是一个调度组件，负责执行异步的后台Job。</p><p>当一个流程被部署时，流程引擎为流程中的每个活动创建一个Job定义，该定义将在运行时创建Job。这允许你在流程中查询关于计时器和异步延续的信息。</p><h3 id="Process-Variables"><a href="#Process-Variables" class="headerlink" title="Process Variables"></a>Process Variables</h3><p>流程变量可用于向流程运行时状态或更具体地说，变量作用域（scopes）添加数据。一般来说，变量由名称和值组成。例如，如果一个活动设置了一个名为var的变量，后续活动可以使用这个名称来访问它。变量的值是Java对象。</p><h2 id="流程引擎-API"><a href="#流程引擎-API" class="headerlink" title="流程引擎 API"></a>流程引擎 API</h2><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164141.png" alt="image"></p><h3 id="RepositoryService"><a href="#RepositoryService" class="headerlink" title="RepositoryService"></a>RepositoryService</h3><p>这个服务提供了管理和操纵部署和流程定义的操作，包括：</p><ul><li>查询引擎已知的部署和流程定义。</li><li>暂停（Suspend）和激活（activate）流程定义。暂停意味着不能对它们做进一步的操作，而激活则是相反的操作。</li><li>检索各种资源，如部署中包含的文件或由引擎自动生成的流程图</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 部署流程</span><br><span class="line">Deployment deployment = repositoryService.createDeployment()</span><br><span class="line">                    .addModelInstance(name + &quot;.bpmn&quot;, modelInstance)</span><br><span class="line">                    .name(name)</span><br><span class="line">                    .tenantId(tenantId)</span><br><span class="line">                    .deploy();</span><br><span class="line">    </span><br><span class="line"># 查询流程</span><br><span class="line">repositoryService.createProcessDefinitionQuery().tenantIdIn(tenantId).deploymentId(deploymentId).singleResult();</span><br></pre></td></tr></table></figure><h3 id="RuntimeService"><a href="#RuntimeService" class="headerlink" title="RuntimeService"></a>RuntimeService</h3><ul><li>通过流程定义创建的流程实例</li><li>用于检索和存储流程变量的服务</li><li>对流程实例和执行进行查询<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建流程实例（启动一个流程）</span><br><span class="line">runtimeService.startProcessInstanceById(processDefinitionId, businessKey, processVariables);</span><br><span class="line">    </span><br><span class="line"># 设置变量</span><br><span class="line">runtimeService.setVariables(executionId, processVariables);</span><br><span class="line">    </span><br><span class="line"># 删除流程实例</span><br><span class="line">runtimeService.deleteProcessInstance(processInstanceId, deleteReason);</span><br><span class="line">    </span><br></pre></td></tr></table></figure></li></ul><h3 id="TaskService"><a href="#TaskService" class="headerlink" title="TaskService"></a>TaskService</h3><ul><li>查询分配给用户或组的任务。</li><li>创建新的独立任务。这些任务与流程实例无关。 </li><li>操作任务分配给哪个用户，或者哪些用户以某种方式参与了任务。</li><li>声明（claim）并完成（complete）一个任务。声明意味着有人决定成为该任务的受让人（assignee），这意味着该用户将完成该任务。完成意味着“完成任务的工作”。通常这是填写某种表格。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 设置变量</span><br><span class="line">taskService.setVariableLocal(taskId, variableName, value);</span><br><span class="line">    </span><br><span class="line"># 查询任务</span><br><span class="line">taskService.createTaskQuery().processInstanceId(processInstanceId).list();</span><br><span class="line">    </span><br><span class="line"># 完成任务</span><br><span class="line">taskService.complete(taskId);</span><br></pre></td></tr></table></figure></li></ul><h3 id="IdentityService"><a href="#IdentityService" class="headerlink" title="IdentityService"></a>IdentityService</h3><p>对组和用户进行管理（创建、更新、删除、查询…）</p><h3 id="HistoryService"><a href="#HistoryService" class="headerlink" title="HistoryService"></a>HistoryService</h3><p>用于查询引擎收集的所有历史数据。当执行流程时，引擎可以保留很多数据（这是可配置的），如流程实例的开始时间、谁做了哪些任务、完成任务花了多长时间、每个流程实例遵循的路径等。该服务主要暴露了访问这些数据的查询功能。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 分页查询某人发起的流程</span><br><span class="line">historyService.createHistoricProcessInstanceQuery()</span><br><span class="line">      .tenantIdIn(tenantId)</span><br><span class="line">      .startedBy(startUserId)</span><br><span class="line">      .orderByProcessInstanceStartTime()</span><br><span class="line">      .desc()</span><br><span class="line">      .listPage(firstResult, maxResults);</span><br></pre></td></tr></table></figure><h3 id="ManagementService"><a href="#ManagementService" class="headerlink" title="ManagementService"></a>ManagementService</h3><p>它允许检索关于数据库表和表元数据的信息。此外，它暴露了查询功能和Job的管理操作。Job在引擎中被用于各种事情，如定时器、异步延续、延迟暂停&#x2F;激活等。</p><h3 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h3><p>FormService、FilterService、ExternalTaskService、CaseService、DecisionService</p><h2 id="流程变量"><a href="#流程变量" class="headerlink" title="流程变量"></a>流程变量</h2><p>流程变量可用于向流程运行时状态或更具体地说，变量作用域添加数据。一般来说，变量由名称和值组成。例如，如果一个活动设置了一个名为var的变量，后续活动可以使用这个名称来访问它。变量的值是Java对象。</p><h3 id="变量作用域和变量可访问性"><a href="#变量作用域和变量可访问性" class="headerlink" title="变量作用域和变量可访问性"></a>变量作用域和变量可访问性</h3><p>所有可以拥有变量的实体称为变量作用域(<strong>variable scopes</strong>)。包括执行(executions（包括流程实例在内）)和任务（tasks）。参看下面的流程模型，其中红点标志着活动任务。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164152.png" alt="image"></p><p>有一个流程实例有两个子执行，每个子执行都创建了一个任务。所有这五个实体都是变量作用域，箭头标志着父-子关系。<strong>在父作用域上定义的变量可以在每个子作用域中被访问，除非子作用域定义了同名的变量</strong>。反过来说，<strong>子变量不能从父作用域访问</strong>。直接附属于有关作用域的变量被称为 <em>local</em> 变量（Local Variable）。</p><h3 id="设置和查询变量"><a href="#设置和查询变量" class="headerlink" title="设置和查询变量"></a>设置和查询变量</h3><p>使用相关API查询和设置变量</p><h3 id="支持的变量类型"><a href="#支持的变量类型" class="headerlink" title="支持的变量类型"></a>支持的变量类型</h3><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164162.png" alt="image"></p><h2 id="委托代码"><a href="#委托代码" class="headerlink" title="委托代码"></a>委托代码</h2><p>委托代码（Delegation Code）允许你在流程执行期间发生某些事件时执行外部Java代码、脚本或表达式。</p><p>有四种不同类型委托代码：</p><ul><li><strong>Java 代理类（JAVA Delegates）：</strong>可以附加到 BPMN 服务任务（Service Task）。</li><li><strong>变量映射（Delegate Variable Mapping）</strong>：可以附加到发起活动。</li><li><strong>执行监听器（Execution Listeners）：</strong>可以附加到令牌流动的任何事件，例如，启动一个流程实例或进入一个活动。</li><li><strong>任务监听器（Task Listeners）</strong>：可以附加到用户任务生命周期内的任何事件，例如，用户任务的创建或完成。</li></ul><h3 id="Java-Delegate"><a href="#Java-Delegate" class="headerlink" title="Java Delegate"></a>Java Delegate</h3><p>实现可以在流程执行期间调用的类，这个类需要实现org.camunda.bpm.engine.delegate.JavaDelegate接口，并在execute方法中提供所需的逻辑。当流程执行到达这个特定的步骤时，它将执行该方法中定义的逻辑，并以默认的BPMN 2.0方式完成活动。</p><h3 id="Delegate-Variable-Mapping"><a href="#Delegate-Variable-Mapping" class="headerlink" title="Delegate Variable Mapping"></a>Delegate Variable Mapping</h3><p>略</p><h3 id="Execution-Listener"><a href="#Execution-Listener" class="headerlink" title="Execution Listener"></a>Execution Listener</h3><p>执行监听器允许你在流程执行过程中发生某些事件时执行外部Java代码或计算一个表达式。可以捕获的事件有：</p><ul><li>启动或结束一个流程实例。</li><li>进行一个过渡（Transition）。</li><li>启动或结束一个活动。</li><li>启动或结束一个网关。</li><li>启动或结束一个中间事件。</li><li>结束一个 start event 或启动一个 end event.</li></ul><h3 id="Task-Listener"><a href="#Task-Listener" class="headerlink" title="Task Listener"></a>Task Listener</h3><p>任务监听器被用来在某个任务相关事件发生时执行自定义的Java逻辑或表达式。它只能作为用户任务的一个子元素添加到流程定义中。请注意，这也必须作为BPMN 2.0 extensionElements的一个子元素，并在Camunda命名空间中定义，因为任务监听器是Camunda引擎专用的。</p><h2 id="BPMN-2-0"><a href="#BPMN-2-0" class="headerlink" title="BPMN 2.0"></a>BPMN 2.0</h2><p>BPMN(Business Process Model and Notation)，即业务流程模型和符号，是业务流程模型的一种标准图形注解。</p><h3 id="实现范围"><a href="#实现范围" class="headerlink" title="实现范围"></a>实现范围</h3><p>标注为 <strong>橙色</strong> 的部分被实现了</p><h4 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h4><h5 id="参与者"><a href="#参与者" class="headerlink" title="参与者"></a>参与者</h5><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164171.png" alt="image"></p><h5 id="子流程"><a href="#子流程" class="headerlink" title="子流程"></a>子流程</h5><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164183.png" alt="image"></p><h5 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h5><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164200.png" alt="image"></p><h5 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h5><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164218.png" alt="image"></p><h5 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h5><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164235.png" alt="image"></p><h5 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h5><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164252.png" alt="image"></p><h4 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h4><p>在BPMN中有开始事件、中间事件和结束事件。这三种事件类型都可以捕获事件或抛出事件。中间事件可以用作任务的边界事件，在这种情况下，它们可以是中断事件，也可以是非中断事件。这为您在流程中使用事件提供了很大的灵活性。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164269.png" alt="image"></p><h3 id="任务-1"><a href="#任务-1" class="headerlink" title="任务"></a>任务</h3><h4 id="Service-Task"><a href="#Service-Task" class="headerlink" title="Service Task"></a>Service Task</h4><p>服务任务用于调用服务。在Camunda中，这是通过调用Java代码来完成的，或者为外部工作者提供的工作项来完成以异步或直接调用Web服务的形式实现逻辑。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164291.png" alt="image"></p><h4 id="Send-Task"><a href="#Send-Task" class="headerlink" title="Send Task"></a>Send Task</h4><p>发送任务用于发送消息。在Camunda，这是通过调用Java代码来完成的。</p><p>发送任务具有与服务任务相同的行为。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164311.png" alt="image"></p><h4 id="User-Task"><a href="#User-Task" class="headerlink" title="User Task"></a>User Task</h4><p>用户任务用于对需要由人类参与者完成的工作进行建模。当流程执行到达这样的用户任务时，在分配给该任务的用户或组的任务列表中创建一个新任务。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164331.png" alt="image"></p><h4 id="Business-Rule-Task"><a href="#Business-Rule-Task" class="headerlink" title="Business Rule Task"></a>Business Rule Task</h4><p>一个业务规则任务可以同步执行一个或多个规则，可以调用Java代码或外部工作者（external worker）来实现，或者以异步方式调用以Web服务形式实现的逻辑。</p><h4 id="Script-Task"><a href="#Script-Task" class="headerlink" title="Script Task"></a>Script Task</h4><p>脚本任务是自动活动。当流程执行到达脚本任务时，执行相应的脚本。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164350.png" alt="image"></p><h4 id="Receive-Task"><a href="#Receive-Task" class="headerlink" title="Receive Task"></a>Receive Task</h4><p>一个接收任务是一个简单的任务，它等待某个消息的到来。当流程的执行到达一个接收任务时，流程的状态被提交到持久性存储中。这意味着流程将一直处于这种等待状态，直到引擎收到一个特定的消息，从而触发流程继续执行。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164367.png" alt="image"></p><h4 id="Manual-Task"><a href="#Manual-Task" class="headerlink" title="Manual Task"></a>Manual Task</h4><p>手动任务定义了一个对BPM引擎来说是外部的任务。它被用来模拟由引擎不需要知道的人所做的工作，而且没有已知的系统或UI接口。对于引擎来说，手工任务被当作一个传递节点来处理，在流程执行到达的那一刻将自动继续流程。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164385.png" alt="image"></p><h4 id="Task-Markers"><a href="#Task-Markers" class="headerlink" title="Task Markers"></a>Task Markers</h4><p>除了各种类型的任务外，我们还可以将任务标记为循环（loops）、多实例（Multiple Instance）或补偿（compensations）。标记可以与任务类型相结合使用。</p><h5 id="Multiple-Instance"><a href="#Multiple-Instance" class="headerlink" title="Multiple Instance"></a>Multiple Instance</h5><p>多实例活动是为业务流程中的某个步骤定义重复的一种方式。在编程概念中，多实例与 <code>for each</code> 结构相似：它允许对给定集合中的每个项目按顺序或并行地执行某个步骤甚至一个完整的子流程。</p><p>多实例是一个有额外属性（所谓的 “多实例特性”）的常规活动，它将导致该活动在运行时被多次执行。以下活动可以成为多实例活动。</p><ul><li>Service Task 服务任务</li><li>Send Task 发送任务</li><li>User Task 用户任务</li><li>Business Rule Task 业务规则任务</li><li>Script Task 脚本任务</li><li>Receive Task 接收任务</li><li>Manual Task 手动任务</li><li>(Embedded) Sub-Process （嵌入）子流程</li><li>Call Activity 发起活动</li><li>Transaction Subprocess 事务子流程</li></ul><p>网关或事件不能成为多实例。</p><p>如果一个活动是多实例的，这将由活动底部的三条短线表示。三条垂直线表示实例将以<strong>并行</strong>方式执行，而三条水平线表示<strong>顺序</strong>执行。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164403.png" alt="image"></p><p>根据规范的要求，每个创建的执行实例的父执行实例都将具有以下变量：</p><ul><li><strong>nrOfInstances</strong>: 实例的总数量</li><li><strong>nrOfActiveInstances</strong>: 当前活动的，即尚未完成的实例的数量。对于一个连续的多实例，这将永远是1。</li><li><strong>nrOfCompletedInstances</strong>: 已经完成的实例的数量。</li></ul><p>这些值可以通过调用 “execution.getVariable(x) “方法检索。</p><p>此外，每个创建的执行将有一个执行本地变量（即对其他执行不可见，也不存储在流程实例级别）。</p><ul><li><strong>loopCounter</strong>: 表示该特定实例的<code>for each</code>循环中的索引</li></ul><h5 id="compensations（补偿）"><a href="#compensations（补偿）" class="headerlink" title="compensations（补偿）"></a>compensations（补偿）</h5><p>如果一个活动被用来补偿另一个活动的影响，它可以被声明为补偿处理程序。补偿处理程序不包含在常规流程中，并且只在抛出补偿事件时被执行。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164421.png" alt="image"></p><p>注意在 “cancel hotel reservation” 服务任务的底部中心区域的补偿处理程序图标。</p><p>补偿处理程序可能没有传入或传出的序列流。</p><p>补偿处理程序必须使用定向关联与补偿边界事件相关联。</p><p>为了声明一个活动是一个补偿处理程序，我们需要将属性isForCompensation设置为真。</p><h3 id="网关-1"><a href="#网关-1" class="headerlink" title="网关"></a>网关</h3><h4 id="Data-based-Exclusive-Gateway-XOR"><a href="#Data-based-Exclusive-Gateway-XOR" class="headerlink" title="Data-based Exclusive Gateway (XOR)"></a>Data-based Exclusive Gateway (XOR)</h4><p>基于数据的排他网关(XOR)</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164438.png" alt="image"></p><h4 id="Parallel-Gateway"><a href="#Parallel-Gateway" class="headerlink" title="Parallel Gateway"></a>Parallel Gateway</h4><p>并行网关</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164457.png" alt="image"></p><h4 id="Inclusive-Gateway"><a href="#Inclusive-Gateway" class="headerlink" title="Inclusive Gateway"></a>Inclusive Gateway</h4><p>包容网关</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164480.png" alt="image"></p><h4 id="Event-based-Gateway"><a href="#Event-based-Gateway" class="headerlink" title="Event-based Gateway"></a>Event-based Gateway</h4><p>基于事件的网关</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164502.png" alt="image"></p><h3 id="事件-1"><a href="#事件-1" class="headerlink" title="事件"></a>事件</h3><p>BPMN定义了不同的事件类型。Camunda支持以下内容。</p><ul><li><p>Start Events：开始事件定义了流程或子流程的起始位置。</p></li><li><p>None Events：没有指定触发器和行为的事件。</p></li><li><p>Message Events：捕获&#x2F;抛出消息的事件。</p></li><li><p>Timer Events：等待计时器条件的事件。</p></li><li><p>Error Events：捕获&#x2F;抛出错误的事件。</p></li><li><p>Escalation Events：捕获&#x2F;抛出升级的事件。</p></li><li><p>Signal Events：捕获&#x2F;抛出信号的事件。</p></li><li><p>Cancel and Compensation Events：抛出&#x2F;捕获补偿和取消事务事件。</p></li><li><p>Conditional Events：捕获条件事件。</p></li><li><p>Link Events：连接非常长的序列流。</p></li><li><p>Terminate Events：结束一个作用域。</p></li></ul><h3 id="子流程-1"><a href="#子流程-1" class="headerlink" title="子流程"></a>子流程</h3><p>在Camunda中，子流程允许基于可重用性和分组进行建模。以下是Camunda支持的不同类型的子流程：</p><ul><li><p>嵌入式子流程（Embedded Subprocess）：将一组流程节点组合成一个范围。</p></li><li><p>调用活动（Call Activity）：从一个流程调用另一个流程。</p></li><li><p>事件子流程（Event Subprocess）：基于事件驱动的子流程。</p></li><li><p>事务子流程（Transaction Subprocess）：建模业务事务。</p></li></ul><h3 id="Camunda扩展"><a href="#Camunda扩展" class="headerlink" title="Camunda扩展"></a>Camunda扩展</h3><p>Camunda延伸BPMN定义的扩展元素和属性。</p><h2 id="Model-API"><a href="#Model-API" class="headerlink" title="Model API"></a>Model API</h2><p>模型api是用于解析、创建、编辑和编写XML文件的简单轻量级库。模型API基于通用XML模型API，该API对于通用XML处理非常有用。</p><h3 id="BPMN-Model-API"><a href="#BPMN-Model-API" class="headerlink" title="BPMN Model API"></a>BPMN Model API</h3><p>BPMN模型API可以轻松地从现有流程定义中提取信息，编辑现有流程定义或创建一个全新的流程定义，而无需手动进行XML解析。</p><p>注意:目前BPMN模型API不支持整个BPMN 2.0规范。已经支持的BPMN 2.0元素列表可以在源代码包org. camunda.bpmm.model .bpmn.instance中找到。</p><h4 id="Read-a-Model"><a href="#Read-a-Model" class="headerlink" title="Read a Model"></a>Read a Model</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// read a model from a file</span><br><span class="line">File file = new File(&quot;PATH/TO/MODEL.bpmn&quot;);</span><br><span class="line">BpmnModelInstance modelInstance = Bpmn.readModelFromFile(file);</span><br><span class="line"></span><br><span class="line">// read a model from a stream</span><br><span class="line">InputStream stream = [...]</span><br><span class="line">BpmnModelInstance modelInstance = Bpmn.readModelFromStream(stream);</span><br><span class="line">Create a Model</span><br><span class="line">BpmnModelInstance modelInstance = Bpmn.createEmptyModel();</span><br></pre></td></tr></table></figure><h4 id="Fluent-Builder-API"><a href="#Fluent-Builder-API" class="headerlink" title="Fluent Builder API"></a>Fluent Builder API</h4><p>为了构建简洁高效的BPMN流程模型，我们提供了一款流式调用的构建器API。使用此API，您可以在几行代码中轻松创建基本流程。在下面示例中，我们演示了如何在不到50行代码内创建具有5个任务和2个网关的相当复杂的流程。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testBpmn()&#123;</span><br><span class="line">    BpmnModelInstance modelInstance = Bpmn.createExecutableProcess(&quot;invoice&quot;)</span><br><span class="line">            .camundaHistoryTimeToLive(180)</span><br><span class="line">            .name(&quot;BPMN API Invoice Process&quot;)</span><br><span class="line">            .startEvent()</span><br><span class="line">            .name(&quot;Invoice received&quot;)</span><br><span class="line">            .userTask()</span><br><span class="line">            .name(&quot;Assign Approver&quot;)</span><br><span class="line">            .camundaAssignee(&quot;demo&quot;)</span><br><span class="line">            .userTask()</span><br><span class="line">            .id(&quot;approveInvoice&quot;)</span><br><span class="line">            .name(&quot;Approve Invoice&quot;)</span><br><span class="line">            .exclusiveGateway()</span><br><span class="line">            .name(&quot;Invoice approved?&quot;)</span><br><span class="line">            .gatewayDirection(GatewayDirection.Diverging)</span><br><span class="line">            .condition(&quot;yes&quot;, &quot;$&#123;approved&#125;&quot;)</span><br><span class="line">            .userTask()</span><br><span class="line">            .name(&quot;Prepare Bank Transfer&quot;)</span><br><span class="line">            .camundaFormKey(&quot;embedded:app:forms/prepare-bank-transfer.html&quot;)</span><br><span class="line">            .camundaCandidateGroups(&quot;accounting&quot;)</span><br><span class="line">            .serviceTask()</span><br><span class="line">            .name(&quot;Archive Invoice&quot;)</span><br><span class="line">            .camundaClass(&quot;org.camunda.bpm.example.invoice.service.ArchiveInvoiceService&quot;)</span><br><span class="line">            .endEvent()</span><br><span class="line">            .name(&quot;Invoice processed&quot;)</span><br><span class="line">            .moveToLastGateway()</span><br><span class="line">            .condition(&quot;no&quot;, &quot;$&#123;!approved&#125;&quot;)</span><br><span class="line">            .userTask()</span><br><span class="line">            .name(&quot;Review Invoice&quot;)</span><br><span class="line">            .camundaAssignee(&quot;demo&quot;)</span><br><span class="line">            .exclusiveGateway()</span><br><span class="line">            .name(&quot;Review successful?&quot;)</span><br><span class="line">            .gatewayDirection(GatewayDirection.Diverging)</span><br><span class="line">            .condition(&quot;no&quot;, &quot;$&#123;!clarified&#125;&quot;)</span><br><span class="line">            .endEvent()</span><br><span class="line">            .name(&quot;Invoice not processed&quot;)</span><br><span class="line">            .moveToLastGateway()</span><br><span class="line">            .condition(&quot;yes&quot;, &quot;$&#123;clarified&#125;&quot;)</span><br><span class="line">            .connectTo(&quot;approveInvoice&quot;)</span><br><span class="line">            .done();</span><br><span class="line"></span><br><span class="line">    // show the BPMN 2.0 process model XML on the console log</span><br><span class="line">  Bpmn.writeModelToStream(System.out, modelInstance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fluent builder API提供了以下基本元素:</p><ul><li>process</li><li>start event</li><li>exclusive gateway</li><li>parallel gateway</li><li>script task</li><li>service task</li><li>user task</li><li>signal event definition</li><li>end event</li><li>subprocess</li></ul><h2 id="History"><a href="#History" class="headerlink" title="History"></a>History</h2><p>历史事件流提供关于已执行的流程实例的审批信息。</p><h3 id="历史和审批事件"><a href="#历史和审批事件" class="headerlink" title="历史和审批事件"></a>历史和审批事件</h3><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/27/processenginehistory.png" alt="process-engine-history"><br>流程引擎维护数据库内运行的流程实例的状态。这包括在流程实例达到等待状态时将其写(1)到数据库中，并在流程继续执行时读(2)该状态。我们称这个数据库为 运行时数据库（runtime database） 。除了维护运行时状态外，流程引擎还创建了一个审批日志，提供关于已执行流程实例的审批信息。我们称这个事件流为 历史事件流（history event stream） （3）。构成这个事件流的各个事件被称为 历史事件（History Events） ，包含关于已执行的流程实例、活动实例、改变的流程变量等的数据。 在默认配置中，流程引擎将简单地把这个事件流写入（4.）<em>历史数据库</em>。历史服务（HistoryService）的API允许查询（5）这个数据库。历史数据库和历史服务是可选的组件；如果历史事件流没有被记录到历史数据库中，或者如果用户选择将事件记录到不同的数据库，流程引擎仍然能工作，它仍然能够填充历史事件流。这是可能的，因为BPMN 2.0核心引擎组件不从历史数据库读取状态。也可以配置流程引擎的 “historyLevel” 配置项，来配置记录的数据量。</p><p>由于流程引擎不依赖历史数据库的存在来生成历史事件流，因此可以提供不同的后端实现来存储历史事件流。默认的后端实现是 “DbHistoryEventHandler” ，它将事件流记录到历史数据库。可以替换后端实现，为历史事件日志提供一个自定义的存储机制。</p><h3 id="历史记录级别"><a href="#历史记录级别" class="headerlink" title="历史记录级别"></a>历史记录级别</h3><ul><li>NONE: 不会记录历史事件。</li><li>ACTIVITY: 以下事件将被记录：<ul><li>流程实例 START, UPDATE, END, MIGRATE: 当流程实例被 started, updated, ended 和 migrated 时触发。</li><li>案例实例 CREATE, UPDATE, CLOSE: 当案例实例被 created, updated 和 closed 时触发。</li><li>活动实例 START, UPDATE, END, MIGRATE: 当活动实例被 started, updated, ended 和 migrated 时触发。</li><li>案例活动实例 CREATE, UPDATE, END: 当案例活动实例被 created, updated 和 ended 时触发。</li><li>任务实例 CREATE, UPDATE, COMPLETE, DELETE, MIGRATE: 当任务实例被 created, updated (i.e., re-assigned, delegated etc.), completed, deleted 和 migrated 时触发。</li></ul></li><li>AUDIT: 除了ACTIVITY级别提供的事件，还记录了以下事件：<ul><li>流程变量 CREATE, UPDATE, DELETE, MIGRATE: 当流程变量被 created, updated, deleted 和 migrated时触发，默认历史记录后端（DbHistoryEventHandler）将变量实例事件写入历史变量实例数据表中。因为在更新流程变量时，此表中的行会更新，所以只有流程变量的最后一个值将可用。</li></ul></li><li>FULL: 除了AUDIT级别提供的事件，还记录了以下事件：<ul><li>表单属性 UPDATE：当表单属性被 created 或 updated 时被触发。</li><li>默认的历史后端（DbHistoryEventHandler）将历史变量的更新情况写入数据库。这使得使用历史服务查看一个流程变量的中间值成为可能。</li><li>用户操作日志 UPDATE: 当用户执行操作时触发，例如承接（claim）用户任务、委派（delegating）用户任务等。</li><li>事件 CREATE, DELETE, RESOLVE, MIGRATE: 当事件被 created, deleted, resolved 和 migrated 时记录。</li><li>历史Job日志 CREATE, FAILED, SUCCESSFUL, DELETED: 当Job被 created, execution, successful 或 deleted 时记录。</li><li>决策实例评估：当DMN引擎进行决策评估时记录。</li><li>批处理 START, END: 当批处理被 started 或 ended 时触发。</li><li>身份 links ADD, DELETE: 当 身份link 被 added, deleted 以及设置或改变用户任务的受让人、拥有人时被记录。</li><li>历史外部任务日志 CREATED, DELETED, FAILED, SUCCESSFUL: 作为外部任务被 created, deleted 或外部任务执行者报告了成功或失败时会记录。</li></ul></li><li>AUTO: 如果你打算在同一个数据库中运行多个引擎，那么 AUTO 级别是很有用的。在这种情况下，所有的引擎都必须使用相同的历史级别。与其手动保持配置同步，不如使用 auto 级别，引擎会自动确定数据库中已经配置的级别。如果没有找到，则使用默认值 audit 。请记住。如果你打算使用自定义历史级别，你必须为每个配置注册自定义级别，否则会出现异常。</li></ul><p>如果你需要自定义历史事件的记录量，你可以提供一个自定义的 HistoryEventProducer 实现并将其应用到流程引擎配置中。</p><h3 id="设置历史记录级别"><a href="#设置历史记录级别" class="headerlink" title="设置历史记录级别"></a>设置历史记录级别</h3><p>历史记录级别可以通过流程引擎配置中的一个属性设置。默认为FULL（当前版本下7.19）</p><blockquote><p>History levels and Cockpit<br>Camunda Platform Cockpit 应用程序在历史级别设置为 “FULL” 时工作得最好。较低的历史级别将禁用某些与历史有关的功能。</p></blockquote><h3 id="历史实体"><a href="#历史实体" class="headerlink" title="历史实体"></a>历史实体</h3><p>有以下历史实体，与运行时数据相反，它们在流程和案例实例完成后，将留在数据库中。</p><ul><li>HistoricProcessInstances 包含有关当前和过去的流程实例的信息。</li><li>HistoricVariableInstances 包含有关在流程实例中保持的最新状态的信息。</li><li>HistoricCaseInstances 包含有关当前和过去案例实例的信息。</li><li>HistoricActivityInstances 包含有关一项执行活动的信息。</li><li>HistoricCaseActivityInstances 包含关于单个执行案例活动的信息。</li><li>HistoricTaskInstances 包含有关当前和过去（已完成和删除）任务实例的信息。</li><li>HistoricDetails 包含与历史流程实例，活动实例或任务实例相关的各种信息。</li><li>HistoricIncidents 包含有关当前和过去的信息（即，删除或解决的）事件。</li><li>UserOperationLogEntry 日志条目包含有关用户执行操作的信息。例如创建新任务，完成任务等操作。</li><li>HistoricJobLog 包含有关Job执行的信息。日志记录有关Job生命周期的详细信息。</li><li>HistoricDecisionInstance 包含关于决策的单个评估的信息，包括输入和输出值。</li><li>HistoricBatch 包含有关当前和过去批处理的信息。</li><li>HistoricIdentityLinkLog 包含有关当前和过去的identity links变更信息(added, deleted, 受让人、拥有人的设置或改变)。</li><li>HistoricExternalTaskLog 包含有关外部任务执行信息。提供了有关外部任务的生命周期的详细信息。</li></ul><h3 id="历史流程实例"><a href="#历史流程实例" class="headerlink" title="历史流程实例"></a>历史流程实例</h3><p>对于每个流程实例，流程引擎将在历史数据库中创建单个记录，并在流程执行期间继续更新此记录。每个历史流程实例记录都可以获得分配的以下状态：</p><ul><li>ACTIVE - 运行中的流程实例</li><li>SUSPENDED - 暂停的流程实例</li><li>COMPLETED - 通过正常结束事件完成的</li><li>EXTERNALLY_TERMINATED - 外部终止，例如通过REST API</li><li>INTERNALLY_TERMINATED - 内部终止，例如通过终止边界事件</li></ul><p>以下状态可以被例如 REST API 或 Cockpit 的外部行为触发：ACTIVE, SUSPENDED, EXTERNALLY_TERMINATED。</p><h3 id="历史清理"><a href="#历史清理" class="headerlink" title="历史清理"></a>历史清理</h3><p>使用流程引擎进行密集操作时，可能会产生大量的历史数据。历史数据清理是一项功能，根据可配置的存活时间设置来删除这些数据。</p><p>它会删除：</p><ul><li>历史流程实例以及所有相关的历史数据（例如历史变量实例、历史任务实例、历史实例权限、与它们相关的所有评论和附件等）。</li><li>历史决策实例以及所有相关的历史数据（即历史决策输入和输出实例）。</li><li>历史案例实例以及所有相关的历史数据（例如历史变量实例、历史任务实例等）。</li><li>历史批处理以及所有相关的历史数据（历史事务和作业日志）。</li><li>历史数据清理可以手动触发或定期安排。只有 Camunda 管理员有权限手动执行历史数据清理。</li></ul><h3 id="清理策略"><a href="#清理策略" class="headerlink" title="清理策略"></a>清理策略</h3><ul><li>Removal-Time-based Strategy</li><li>End-Time-based Strategy</li></ul><h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="数据库表结构"><a href="#数据库表结构" class="headerlink" title="数据库表结构"></a>数据库表结构</h3><p>流程引擎的数据库由多个表组成。 表的名称都以ACT开头的。后面的是说明表的用途的两个字符标识。这个用途标识也将与服务API大致匹配。</p><ul><li><p><code>ACT_RE_*</code>: <code>RE</code>代表资源库（Repository）。带有这个前缀的表包含“静态”信息，如流程定义和流程资源（图像、规则等）。</p></li><li><p><code>ACT_RU_*</code>: <code>RU</code>代表运行时（Runtime）。包含流程实例、用户任务、变量、Job等的运行时数据。引擎只在流程实例执行期间存储运行时数据，并在流程实例结束时删除记录。这使运行时表保持小而快。</p></li><li><p><code>ACT_ID_*</code>: <code>ID</code>代表身份信息（Identity）。这些表包含身份信息有用户、组等。</p></li><li><p><code>ACT_HI_*</code>: <code>HI</code>代表历史（History）。这些是包含历史数据的表，如过去的流程实例、变量、任务等。</p></li><li><p><code>ACT_GE_*</code>: <code>GE</code>代表一般数据（General），在各种使用情况下使用。</p></li></ul><p>流程引擎的主要表有流程定义、执行、任务、变量和事件订阅。它们的关系显示在下面的UML模型中：</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164525.png" alt="image"></p><h4 id="流程定义-ACT-RE-PROCDEF"><a href="#流程定义-ACT-RE-PROCDEF" class="headerlink" title="流程定义 (ACT_RE_PROCDEF)"></a>流程定义 (ACT_RE_PROCDEF)</h4><p>包含所有已部署的流程定义。它包括有版本详细信息，资源名称或暂停状态等信息。</p><h4 id="执行-ACT-RU-EXECUTION"><a href="#执行-ACT-RU-EXECUTION" class="headerlink" title="执行 (ACT_RU_EXECUTION)"></a>执行 (ACT_RU_EXECUTION)</h4><p>包含所有当前运行中的执行。它包括有流程定义，父执行，业务主键，当前活动和关于执行状态的不同元数据的信息。</p><h4 id="任务-ACT-RU-TASK"><a href="#任务-ACT-RU-TASK" class="headerlink" title="任务(ACT_RU_TASK)"></a>任务(ACT_RU_TASK)</h4><p>包含所有正在运行的流程实例的所有执行中的任务。它包括有相应的流程实例，执行以及元数据等信息，例如创建时间，受让人或截止日期。</p><h4 id="变量-ACT-RU-VARIABLE"><a href="#变量-ACT-RU-VARIABLE" class="headerlink" title="变量 (ACT_RU_VARIABLE)"></a>变量 (ACT_RU_VARIABLE)</h4><p>包含所有当前设置的流程或任务变量。它包括变量的名称、类型和值以及相应流程实例或任务的信息。</p><h4 id="事件订阅-ACT-RU-EVENT-SUBSCR"><a href="#事件订阅-ACT-RU-EVENT-SUBSCR" class="headerlink" title="事件订阅 (ACT_RU_EVENT_SUBSCR)"></a>事件订阅 (ACT_RU_EVENT_SUBSCR)</h4><p>包含所有当前现有的事件订阅。它包括预期事件的类型、名称和配置以及相应的流程实例和执行的信息。</p><h4 id="表结构日志-ACT-GE-SCHEMA-LOG"><a href="#表结构日志-ACT-GE-SCHEMA-LOG" class="headerlink" title="表结构日志 (ACT_GE_SCHEMA_LOG)"></a>表结构日志 (ACT_GE_SCHEMA_LOG)</h4><p>记录数据库表结构版本的历史记录。在进行表结构修改时都会写入记录。在数据库创建时会写入一条初始信息，以后每次修改都会记录id 、版本、数据库更新日期以及时间戳。</p><h4 id="运行时指标日志-ACT-RU-METER-LOG"><a href="#运行时指标日志-ACT-RU-METER-LOG" class="headerlink" title="运行时指标日志 (ACT_RU_METER_LOG)"></a>运行时指标日志 (ACT_RU_METER_LOG)</h4><p>表包含一组运行时指标，可以帮助得出有关Camunda平台使用情况、负载和性能的结论。</p><h4 id="任务指标日志-ACT-RU-TASK-METER-LOG"><a href="#任务指标日志-ACT-RU-TASK-METER-LOG" class="headerlink" title="任务指标日志 (ACT_RU_TASK_METER_LOG)"></a>任务指标日志 (ACT_RU_TASK_METER_LOG)</h4><p>包含一组与任务相关的指标，可以帮助得出关于BPM平台的使用、负载和性能的结论。</p><h3 id="实体关系图"><a href="#实体关系图" class="headerlink" title="实体关系图"></a>实体关系图</h3><p>下面的实体关系图将数据库表和它们的显式外键约束可视化，按照BPMN引擎、DMN引擎、CMMN引擎、历史引擎和身份引擎进行分组。请注意，这些图并没有将表之间的隐性联系可视化。</p><h4 id="BPMN引擎"><a href="#BPMN引擎" class="headerlink" title="BPMN引擎"></a>BPMN引擎</h4><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164547.png" alt="image"></p><h4 id="DMN引擎"><a href="#DMN引擎" class="headerlink" title="DMN引擎"></a>DMN引擎</h4><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164571.png" alt="image"></p><h4 id="CMMN引擎"><a href="#CMMN引擎" class="headerlink" title="CMMN引擎"></a>CMMN引擎</h4><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164595.png" alt="image"></p><h4 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h4><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164622.png" alt="image"></p><h4 id="身份"><a href="#身份" class="headerlink" title="身份"></a>身份</h4><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/02/17093738164652.png" alt="image"></p><h3 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h3><h5 id="为-date-time-类型禁用发送毫秒精度"><a href="#为-date-time-类型禁用发送毫秒精度" class="headerlink" title="为 date&#x2F;time 类型禁用发送毫秒精度"></a>为 date&#x2F;time 类型禁用发送毫秒精度</h5><p>引擎的MySQL数据库模式不支持列类型 <code>TIMESTAMP</code> 和 <code>DATETIME</code> 的毫秒精度。 也就是会四舍五入到下一秒或上一秒，例如，<code>2021-01-01 15:00:46.731</code>被四舍五入到<code>2021-01-01 15:00:47</code></p><p><strong>可以通过设置sendFractionalSeconds&#x3D;false来避免向MySQL服务器发送毫秒。 在你的JDBC连接URL中设置sendFractionalSeconds&#x3D;false。</strong></p><h5 id="隔离级别配置"><a href="#隔离级别配置" class="headerlink" title="隔离级别配置"></a>隔离级别配置</h5><p>大多数数据库管理系统提供了四种不同的隔离级别可供设置。例如，由ANSI&#x2F;USO SQL定义的级别是（从低到高的隔离）有：</p><ul><li>读未提交（READ UNCOMMITTED ）</li><li>不可重复读（READ COMMITTED）</li><li>可重复读（REPEATABLE READS） </li><li>串行化（SERIALIZABLE）</li></ul><p>运行Camunda所需的隔离级别是 <strong>不可重复读（READ COMMITTED）</strong> ，根据你的数据库系统不同，它可能有不同的名称。将隔离级别设置为 REPEATABLE READS 会导致死锁，所以在改变隔离级别时需要谨慎。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;Camunda是一个基于java的框架，支持用于工作流和过程自动化的BPMN、用于案例管理的CMMN和用于商业决策管理的DMN。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="Camunda" scheme="https://yangh124.github.io/tags/Camunda/"/>
    
  </entry>
  
  <entry>
    <title>k8s</title>
    <link href="https://yangh124.github.io/2024/03/09/k8s/"/>
    <id>https://yangh124.github.io/2024/03/09/k8s/</id>
    <published>2024-03-08T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.126Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Kubernetes 是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。 Kubernetes 拥有一个庞大且快速增长的生态，其服务、支持和工具的使用范围相当广泛。</p><p>Kubernetes 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。 Google 在 2014 年开源了 Kubernetes 项目。 Kubernetes 建立在 Google 大规模运行生产工作负载十几年经验的基础上， 结合了社区中最优秀的想法和实践。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/09/containerevolution.svg" alt="Container_Evolution"></p><p>Kubernetes提供：</p><ul><li><p>服务发现和负载均衡<br>Kubernetes 可以使用 DNS 名称或自己的 IP 地址来暴露容器。 如果进入容器的流量很大，Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p></li><li><p>存储编排<br>Kubernetes 允许你自动挂载你选择的存储系统，例如本地存储、公共云提供商等。</p></li><li><p>自动部署和回滚<br>你可以使用 Kubernetes 描述已部署容器的所需状态， 它可以以受控的速率将实际状态更改为期望状态。 例如，你可以自动化 Kubernetes 来为你的部署创建新容器， 删除现有容器并将它们的所有资源用于新容器。</p></li><li><p>自动完成装箱计算<br>你为 Kubernetes 提供许多节点组成的集群，在这个集群上运行容器化的任务。 你告诉 Kubernetes 每个容器需要多少 CPU 和内存 (RAM)。 Kubernetes 可以将这些容器按实际情况调度到你的节点上，以最佳方式利用你的资源。</p></li><li><p>自我修复<br>Kubernetes 将重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器， 并且在准备好服务之前不将其通告给客户端。</p></li><li><p>密钥与配置管理<br>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p></li><li><p>批处理执行<br>除了服务外，Kubernetes 还可以管理你的批处理和 CI（持续集成）工作负载，如有需要，可以替换失败的容器。</p></li><li><p>水平扩缩<br>使用简单的命令、用户界面或根据 CPU 使用率自动对你的应用进行扩缩。</p></li><li><p>IPv4&#x2F;IPv6 双栈<br>为 Pod（容器组）和 Service（服务）分配 IPv4 和 IPv6 地址。</p></li><li><p>为可扩展性设计<br>在不改变上游源代码的情况下为你的 Kubernetes 集群添加功能。</p></li></ul><h2 id="Kubernetes-组件"><a href="#Kubernetes-组件" class="headerlink" title="Kubernetes 组件"></a>Kubernetes 组件</h2><p>当你部署完 Kubernetes，便拥有了一个完整的集群。</p><p>一组工作机器，称为节点， 会运行容器化应用程序。每个集群至少有一个工作节点。</p><p>工作节点会托管 Pod，而 Pod 就是作为应用负载的组件。 控制平面管理集群中的工作节点和 Pod。 在生产环境中，控制平面通常跨多台计算机运行， 一个集群通常运行多个节点，提供容错性和高可用性。</p><p><img src="http://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2024/03/09/componentsofkubernetes.svg" alt="components-of-kubernetes"></p><h3 id="控制平面组件（Control-Plane-Components）"><a href="#控制平面组件（Control-Plane-Components）" class="headerlink" title="控制平面组件（Control Plane Components）"></a>控制平面组件（Control Plane Components）</h3><p>控制平面组件会为集群做出全局决策，比如资源的调度。 以及检测和响应集群事件，例如当不满足部署的 replicas 字段时，要启动新的 Pod）。</p><p>控制平面组件可以在集群中的任何节点上运行。 然而，为了简单起见，设置脚本通常会在同一个计算机上启动所有控制平面组件， 并且不会在此计算机上运行用户容器。 请参阅使用 kubeadm 构建高可用性集群 中关于跨多机器控制平面设置的示例。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;Kubernetes 是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。 Kubernetes 拥有</summary>
      
    
    
    
    <category term="运维" scheme="https://yangh124.github.io/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="k8s" scheme="https://yangh124.github.io/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>k3s实战</title>
    <link href="https://yangh124.github.io/2023/02/28/k3s%E5%AE%9E%E6%88%98/"/>
    <id>https://yangh124.github.io/2023/02/28/k3s%E5%AE%9E%E6%88%98/</id>
    <published>2023-02-27T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.126Z</updated>
    
    <content type="html"><![CDATA[<h2 id="k3s简介"><a href="#k3s简介" class="headerlink" title="k3s简介"></a>k3s简介</h2><p>K3s 是一个轻量级的 Kubernetes 发行版，它针对边缘计算、物联网等场景进行了高度优化。K3s 有以下增强功能：</p><ul><li>打包为单个二进制文件。</li><li>使用基于 sqlite3 的轻量级存储后端作为默认存储机制。同时支持使用 etcd3、MySQL 和 PostgreSQL 作为存储机制。</li><li>封装在简单的启动程序中，通过该启动程序处理很多复杂的 TLS 和选项。</li><li>默认情况下是安全的，对轻量级环境有合理的默认值。</li><li>添加了简单但功能强大的batteries-included功能，例如：本地存储提供程序，服务负载均衡器，Helm controller 和 Traefik Ingress controller。</li><li>所有 Kubernetes control-plane 组件的操作都封装在单个二进制文件和进程中，使 K3s 具有自动化和管理包括证书分发在内的复杂集群操作的能力。</li><li>最大程度减轻了外部依赖性，K3s 仅需要 kernel 和 cgroup 挂载。 K3s 软件包需要的依赖项包括：<ul><li>containerd</li><li>Flannel</li><li>CoreDNS</li><li>CNI</li><li>主机实用程序（iptables、socat 等）</li><li>Ingress controller（Traefik）</li><li>嵌入式服务负载均衡器（service load balancer）</li><li>嵌入式网络策略控制器（network policy controller）</li></ul></li></ul><h3 id="为什么叫k3s"><a href="#为什么叫k3s" class="headerlink" title="为什么叫k3s"></a>为什么叫k3s</h3><p>我们希望安装的 Kubernetes 在内存占用方面只是一半的大小。Kubernetes 是一个 10 个字母的单词，简写为 K8s。所以，有 Kubernetes 一半大的东西就是一个 5 个字母的单词，简写为 K3s。K3s 没有全称，也没有官方的发音。</p><h3 id="安装k3s"><a href="#安装k3s" class="headerlink" title="安装k3s"></a>安装k3s</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -</span><br></pre></td></tr></table></figure><p>运行此安装后：<br>    * K3s 服务将被配置为在节点重启后或进程崩溃或被杀死时自动重启。<br>    * 将安装其他实用程序，包括kubectl、crictl、ctr、k3s-killall.sh 和 k3s-uninstall.sh。<br>    * 将kubeconfig文件写入到&#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;k3s.yaml，由 K3s 安装的 kubectl 将自动使用该文件</p><p><strong>如果要部署集群，使用以下脚本部署：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken sh -</span><br><span class="line"></span><br><span class="line">myserver -&gt; master节点的ip</span><br><span class="line">mynodetoken -&gt; cat /var/lib/rancher/k3s/server/node-token</span><br></pre></td></tr></table></figure><h3 id="查看版本"><a href="#查看版本" class="headerlink" title="查看版本"></a>查看版本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@YH-UBUNTU:~# kubectl version --output=yaml</span><br><span class="line">clientVersion:</span><br><span class="line">  buildDate: &quot;2023-01-26T00:47:47Z&quot;</span><br><span class="line">  compiler: gc</span><br><span class="line">  gitCommit: 9176e03c5788e467420376d10a1da2b6de6ff31f</span><br><span class="line">  gitTreeState: clean</span><br><span class="line">  gitVersion: v1.25.6+k3s1</span><br><span class="line">  goVersion: go1.19.5</span><br><span class="line">  major: &quot;1&quot;</span><br><span class="line">  minor: &quot;25&quot;</span><br><span class="line">  platform: linux/amd64</span><br><span class="line">kustomizeVersion: v4.5.7</span><br><span class="line">serverVersion:</span><br><span class="line">  buildDate: &quot;2023-01-26T00:47:47Z&quot;</span><br><span class="line">  compiler: gc</span><br><span class="line">  gitCommit: 9176e03c5788e467420376d10a1da2b6de6ff31f</span><br><span class="line">  gitTreeState: clean</span><br><span class="line">  gitVersion: v1.25.6+k3s1</span><br><span class="line">  goVersion: go1.19.5</span><br><span class="line">  major: &quot;1&quot;</span><br><span class="line">  minor: &quot;25&quot;</span><br><span class="line">  platform: linux/amd64</span><br></pre></td></tr></table></figure><h3 id="禁用默认traefik"><a href="#禁用默认traefik" class="headerlink" title="禁用默认traefik"></a>禁用默认traefik</h3><h4 id="删除traefik"><a href="#删除traefik" class="headerlink" title="删除traefik"></a>删除traefik</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system delete helmcharts.helm.cattle.io traefik</span><br><span class="line">kubectl -n kube-system delete helmcharts.helm.cattle.io traefik-crd</span><br></pre></td></tr></table></figure><h4 id="关闭开机自动部署traefik"><a href="#关闭开机自动部署traefik" class="headerlink" title="关闭开机自动部署traefik"></a>关闭开机自动部署traefik</h4><ol><li>修改服务文件<code>sudo vim /etc/systemd/system/k3s.service</code>,将以下内容追加至ExecStart：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--disable traefik --disable traefik-crd</span><br></pre></td></tr></table></figure></li><li>清除部署文件中的traefik<br><code>sudo rm /var/lib/rancher/k3s/server/manifests/traefik.yaml</code></li><li>重启服务<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo service k3s restart</span><br></pre></td></tr></table></figure></li></ol><h3 id="配置私有镜像仓库"><a href="#配置私有镜像仓库" class="headerlink" title="配置私有镜像仓库"></a>配置私有镜像仓库</h3><p>可以配置 Containerd 连接到私有镜像仓库，并使用它们在节点上拉取私有镜像。</p><hr><p>启动时，K3s 会检查&#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;中是否存在registries.yaml文件，并指示 containerd 使用文件中定义的镜像仓库。如果你想使用一个私有的镜像仓库，那么你需要在每个使用镜像仓库的节点上以 root 身份创建这个文件。</p><hr><p>配置registries.yaml（这里使用的是阿里云的镜像服务）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mirrors:</span><br><span class="line">  docker.io:</span><br><span class="line">    endpoint:</span><br><span class="line">      - &quot;registry.cn-hangzhou.aliyuncs.com&quot;</span><br><span class="line">configs:</span><br><span class="line">  &quot;registry.cn-hangzhou.aliyuncs.com&quot;:</span><br><span class="line">    auth:</span><br><span class="line">      username: # 这是私有镜像仓库的用户名</span><br><span class="line">      password: # 这是私有镜像仓库的密码</span><br><span class="line">    # 使用tls时需要配置</span><br><span class="line">    tls:</span><br><span class="line">      cert_file: # 镜像仓库中使用的cert文件的路径。</span><br><span class="line">      key_file:  # 镜像仓库中使用的key文件的路径。</span><br><span class="line">      ca_file:   # 镜像仓库中使用的ca文件的路径。</span><br></pre></td></tr></table></figure><h3 id="客户端和服务器证书"><a href="#客户端和服务器证书" class="headerlink" title="客户端和服务器证书"></a>客户端和服务器证书</h3><p>K3s 客户端和服务器证书自颁发日起 365 天内有效。每次启动 K3s 时，已过期或 90 天内过期的证书都会自动更新。<br>要手动轮换客户端和服务器证书，请使用 k3s certificate rotate 子命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 停止 K3s</span><br><span class="line">systemctl stop k3s</span><br><span class="line"></span><br><span class="line"># 轮换证书</span><br><span class="line">k3s certificate rotate</span><br><span class="line"></span><br><span class="line"># 启动 K3s</span><br><span class="line">systemctl start k3s</span><br></pre></td></tr></table></figure><p>你可以通过指定证书名称来轮换单个或多个证书：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k3s certificate rotate --service &lt;SERVICE&gt;,&lt;SERVICE&gt;</span><br></pre></td></tr></table></figure><p>使用 kubectl 从外部访问集群（云效）<br>将 &#x2F;etc&#x2F;rancher&#x2F;k3s&#x2F;k3s.yaml 复制到位于集群外部的主机上的 ~&#x2F;.kube&#x2F;config。然后，将 server 字段的值替换为你 K3s Server 的 IP 或名称。现在，你可以使用 kubectl 来管理 K3s 集群。</p><h2 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h2><h3 id="Helm安装"><a href="#Helm安装" class="headerlink" title="Helm安装"></a>Helm安装</h3><ol><li>下载所需版本【当前3.11.1】，地址：<a href="https://github.com/helm/helm/releases">Helm下载</a></li><li>安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 解压安装包</span><br><span class="line">tar -zxf helm-v3.11.1-linux-amd64.tar.gz</span><br><span class="line"># 移至bin目录</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line"># 安装完成，查看版本</span><br><span class="line">helm version</span><br></pre></td></tr></table></figure></li></ol><h3 id="配置仓库"><a href="#配置仓库" class="headerlink" title="配置仓库"></a>配置仓库</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用于安装mysql,redis</span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure><h3 id="搜索chart"><a href="#搜索chart" class="headerlink" title="搜索chart"></a>搜索chart</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm search repo xxx</span><br></pre></td></tr></table></figure><h3 id="Helm使用"><a href="#Helm使用" class="headerlink" title="Helm使用"></a>Helm使用</h3><ol><li>生成chart部署 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-2-centos ~/mydata/cicd]# helm create test-chart</span><br><span class="line">Creating test-chart</span><br><span class="line">[root@VM-16-2-centos ~/mydata/cicd]# tree test-chart/</span><br><span class="line">test-chart/</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line">3 directories, 10 files</span><br></pre></td></tr></table></figure></li><li>拉取仓库chart部署<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm pull bitnami/mysql</span><br></pre></td></tr></table></figure><strong>部署命令</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 升级或安装</span><br><span class="line">helm upgrade --install [helm-name] [chart-name]</span><br></pre></td></tr></table></figure></li></ol><h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2><p><em><strong>本文介绍使用helm部署，所有部署文件已上传至GitHub，地址：<a href="https://github.com/yangh124/cicd">k3s-cicd</a></strong></em></p><h3 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h3><h4 id="创建StorageClass"><a href="#创建StorageClass" class="headerlink" title="创建StorageClass"></a>创建StorageClass</h4><p>创建mysql-StorageClass.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage-mysql</span><br><span class="line">  namespace: db-system</span><br><span class="line">provisioner: kubernetes.io/no-provisioner</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">reclaimPolicy: Retain</span><br></pre></td></tr></table></figure><p><code>kubectl apply -f mysql-StorageClass.yaml</code></p><h4 id="创建PV"><a href="#创建PV" class="headerlink" title="创建PV"></a>创建PV</h4><p>创建mysql-pv.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pv</span><br><span class="line">  namespace: db-system</span><br><span class="line">  labels:</span><br><span class="line">    type: local</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 2Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: local-storage-mysql</span><br><span class="line">  local:</span><br><span class="line">    path: &quot;/opt/mysql&quot; # 确保机器上有此目录</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key:  kubernetes.io/arch</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - amd64</span><br></pre></td></tr></table></figure><p><code>kubectl apply -f mysql-pv.yaml</code></p><h4 id="创建PVC"><a href="#创建PVC" class="headerlink" title="创建PVC"></a>创建PVC</h4><p>创建mysql-pvc.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pvc</span><br><span class="line">  namespace: db-system</span><br><span class="line">  labels:</span><br><span class="line">    app: mysql-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce #此处需要和pv对应才能匹配</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 2Gi</span><br><span class="line">  storageClassName: local-storage-mysql #此处需要和StorageClass.yaml匹配</span><br></pre></td></tr></table></figure><p><code>kubectl apply -f mysql-pvc.yaml</code></p><h4 id="拉取mysql-chart"><a href="#拉取mysql-chart" class="headerlink" title="拉取mysql chart"></a>拉取mysql chart</h4><p><code>help helm pull bitnami/mysql</code></p><h4 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 设置root账户密码</span><br><span class="line">auth.rootPassword=&quot;root&quot; </span><br><span class="line"># 关闭默认创建database</span><br><span class="line">auth.createDatabase=false</span><br><span class="line"># 配置pvc</span><br><span class="line">primary.persistence.existingClaim=&quot;mysql-pvc&quot;</span><br><span class="line"># 配置storageClass</span><br><span class="line">primary.persistence.storageClass=&quot;local-storage-mysql&quot;</span><br><span class="line"># 修改服务类型为NodePort</span><br><span class="line">primary.service.type=NodePort </span><br><span class="line"># 配置暴露端口</span><br><span class="line">primary.service.nodePorts.mysql=&quot;30306&quot; </span><br><span class="line"># 关闭健康检查</span><br><span class="line">primary.startupProbe.enabled=false </span><br><span class="line">primary.readinessProbe.enabled=false </span><br><span class="line">primary.livenessProbe.enabled=false </span><br><span class="line"># 关闭主从</span><br><span class="line">secondary.replicaCount=0 </span><br><span class="line">secondary.persistence.enable=false</span><br></pre></td></tr></table></figure><h4 id="启动Mysql"><a href="#启动Mysql" class="headerlink" title="启动Mysql"></a>启动Mysql</h4><p><code>helm install mysql8 /root/mydata/cicd/charts/mysql --namespace db-system</code></p><h3 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h3><h4 id="创建StorageClass-1"><a href="#创建StorageClass-1" class="headerlink" title="创建StorageClass"></a>创建StorageClass</h4><p>创建redis-StorageClass.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kind: StorageClass</span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: local-storage-redis</span><br><span class="line">  namespace: db-system</span><br><span class="line">provisioner: kubernetes.io/no-provisioner</span><br><span class="line">volumeBindingMode: WaitForFirstConsumer</span><br><span class="line">reclaimPolicy: Retain</span><br></pre></td></tr></table></figure><p><code>kubectl apply -f redis-StorageClass.yaml</code></p><h4 id="创建PV-1"><a href="#创建PV-1" class="headerlink" title="创建PV"></a>创建PV</h4><p>创建redis-pv.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-pv</span><br><span class="line">  namespace: db-system</span><br><span class="line">  labels:</span><br><span class="line">    type: local</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 1Gi</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce</span><br><span class="line">  persistentVolumeReclaimPolicy: Retain</span><br><span class="line">  storageClassName: local-storage-redis</span><br><span class="line">  local:</span><br><span class="line">    path: &quot;/opt/redis&quot; # 确保目录存在</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key:  kubernetes.io/arch</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - amd64</span><br></pre></td></tr></table></figure><p><code>kubectl apply -f redis-pv.yaml</code></p><h4 id="创建PVC-1"><a href="#创建PVC-1" class="headerlink" title="创建PVC"></a>创建PVC</h4><p>创建redis-pvc.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-pvc</span><br><span class="line">  namespace: db-system</span><br><span class="line">  labels:</span><br><span class="line">    app: redis-pvc</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">  - ReadWriteOnce #此处需要和pv对应才能匹配</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 1Gi</span><br><span class="line">  storageClassName: local-storage-redis #此处需要和StorageClass.yaml匹配</span><br></pre></td></tr></table></figure><p><code>kubectl apply -f redis-pvc.yaml</code></p><h4 id="拉取mysql-chart-1"><a href="#拉取mysql-chart-1" class="headerlink" title="拉取mysql chart"></a>拉取mysql chart</h4><p><code>help helm pull bitnami/redis</code></p><h4 id="修改配置-1"><a href="#修改配置-1" class="headerlink" title="修改配置"></a>修改配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 单机模式</span><br><span class="line">architecture=standalone </span><br><span class="line"># NodoPort</span><br><span class="line">#--set master.service.type=NodePort </span><br><span class="line"># 配置暴露端口</span><br><span class="line">#--set master.service.nodePorts.redis=30919 </span><br><span class="line"># 配置密码</span><br><span class="line">#--set global.redis.password=root</span><br><span class="line"># 配置storageClass</span><br><span class="line">#--set primary.persistence.storageClass=&quot;local-storage-mysql&quot;</span><br><span class="line"># 配置内存</span><br><span class="line">#--set primary.persistence.size=1Gi</span><br><span class="line"># 配置pvc</span><br><span class="line">#--set primary.persistence.existingClaim=&quot;mysql-pvc&quot;</span><br></pre></td></tr></table></figure><h4 id="启动Redis"><a href="#启动Redis" class="headerlink" title="启动Redis"></a>启动Redis</h4><p><code>helm install redis /root/mydata/cicd/charts/redis --namespace db-system</code></p><h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@YH-UBUNTU:~/mydata/cicd# kubectl -n db-system get pv,pvc</span><br><span class="line">NAME                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS          REASON   AGE</span><br><span class="line">persistentvolume/mysql-pv   2Gi        RWO            Retain           Bound    db-system/mysql-pvc   local-storage-mysql            7d</span><br><span class="line">persistentvolume/redis-pv   1Gi        RWO            Retain           Bound    db-system/redis-pvc   local-storage-redis            7d</span><br><span class="line"></span><br><span class="line">NAME                              STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class="line">persistentvolumeclaim/mysql-pvc   Bound    mysql-pv   2Gi        RWO            local-storage-mysql   7d</span><br><span class="line">persistentvolumeclaim/redis-pvc   Bound    redis-pv   1Gi        RWO            local-storage-redis   7d</span><br><span class="line">root@YH-UBUNTU:~/mydata/cicd# kubectl -n db-system get all</span><br><span class="line">NAME                 READY   STATUS    RESTARTS      AGE</span><br><span class="line">pod/mysql8-0         1/1     Running   4 (43m ago)   7d</span><br><span class="line">pod/redis-master-0   1/1     Running   4 (43m ago)   6d23h</span><br><span class="line"></span><br><span class="line">NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/mysql8-headless   ClusterIP   None            &lt;none&gt;        3306/TCP         7d</span><br><span class="line">service/mysql8            NodePort    10.43.201.139   &lt;none&gt;        3306:30306/TCP   7d</span><br><span class="line">service/redis-headless    ClusterIP   None            &lt;none&gt;        6379/TCP         6d23h</span><br><span class="line">service/redis-master      NodePort    10.43.111.113   &lt;none&gt;        6379:30919/TCP   6d23h</span><br><span class="line"></span><br><span class="line">NAME                            READY   AGE</span><br><span class="line">statefulset.apps/mysql8         1/1     7d</span><br><span class="line">statefulset.apps/redis-master   1/1     6d23h</span><br></pre></td></tr></table></figure><h3 id="部署项目"><a href="#部署项目" class="headerlink" title="部署项目"></a>部署项目</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>配置用于访问阿里云镜像仓库的Secret</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># kubectl create secret docker-registry aliyun-docker  --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xxxx --docker-password=xxxx</span><br></pre></td></tr></table></figure><h4 id="后端部署"><a href="#后端部署" class="headerlink" title="后端部署"></a>后端部署</h4><p>项目地址：<a href="https://github.com/yangh124/weather-push">https://github.com/yangh124/weather-push</a></p><h5 id="创建chart"><a href="#创建chart" class="headerlink" title="创建chart"></a>创建chart</h5><p><code>helm create weather-push</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 删除不需要的文件，最终剩下以下文件</span><br><span class="line">root@YH-UBUNTU:~/mydata/cicd/charts# tree weather-push</span><br><span class="line">weather-push</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   └── service.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line">1 directory, 6 files</span><br></pre></td></tr></table></figure><h5 id="修改value-yaml"><a href="#修改value-yaml" class="headerlink" title="修改value.yaml"></a>修改value.yaml</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># Default values for k8s-cicd.</span><br><span class="line"># This is a YAML-formatted file.</span><br><span class="line"># Declare variables to be passed into your templates.</span><br><span class="line"></span><br><span class="line">replicaCount: 1</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: nginx</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  # Overrides the image tag whose default is the chart appVersion.</span><br><span class="line">  tag: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># 配置secret用于拉取镜像</span><br><span class="line">imagePullSecrets: </span><br><span class="line">  - name: aliyun-docker</span><br><span class="line"></span><br><span class="line">nameOverride: &quot;&quot;</span><br><span class="line">fullnameOverride: &quot;&quot;</span><br><span class="line"></span><br><span class="line">podAnnotations: &#123;&#125;</span><br><span class="line"></span><br><span class="line">podSecurityContext: &#123;&#125;</span><br><span class="line">  # fsGroup: 2000</span><br><span class="line"></span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line">  # capabilities:</span><br><span class="line">  #   drop:</span><br><span class="line">  #   - ALL</span><br><span class="line">  # readOnlyRootFilesystem: true</span><br><span class="line">  # runAsNonRoot: true</span><br><span class="line">  # runAsUser: 1000</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: 8080</span><br><span class="line"></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">  # We usually recommend not to specify default resources and to leave this as a conscious</span><br><span class="line">  # choice for the user. This also increases chances charts run on environments with little</span><br><span class="line">  # resources, such as Minikube. If you do want to specify resources, uncomment the following</span><br><span class="line">  # lines, adjust them as necessary, and remove the curly braces after &#x27;resources:&#x27;.</span><br><span class="line">  # limits:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line">  # requests:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br></pre></td></tr></table></figure><h5 id="启动后端项目"><a href="#启动后端项目" class="headerlink" title="启动后端项目"></a>启动后端项目</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install weather-push /root/mydata/cicd/charts/weather-push --set image.repository=xxxx --set image.tag=xxxx</span><br></pre></td></tr></table></figure><h4 id="前端部署"><a href="#前端部署" class="headerlink" title="前端部署"></a>前端部署</h4><p>项目地址：<a href="https://github.com/yangh124/weather-push-admin">https://github.com/yangh124/weather-push-admin</a></p><h5 id="创建chart-1"><a href="#创建chart-1" class="headerlink" title="创建chart"></a>创建chart</h5><p><code>helm create weather-push-admin</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 删除不需要的文件，最终剩下以下文件</span><br><span class="line">root@YH-UBUNTU:~/mydata/cicd/charts# tree weather-push-admin</span><br><span class="line">weather-push-admin</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   └── service.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line">1 directory, 6 files</span><br></pre></td></tr></table></figure><h5 id="修改value-yaml-1"><a href="#修改value-yaml-1" class="headerlink" title="修改value.yaml"></a>修改value.yaml</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># Default values for k8s-cicd.</span><br><span class="line"># This is a YAML-formatted file.</span><br><span class="line"># Declare variables to be passed into your templates.</span><br><span class="line"></span><br><span class="line">replicaCount: 1</span><br><span class="line"></span><br><span class="line">image:</span><br><span class="line">  repository: nginx</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  # Overrides the image tag whose default is the chart appVersion.</span><br><span class="line">  tag: &quot;&quot;</span><br><span class="line"></span><br><span class="line"># 配置secret用于拉取镜像</span><br><span class="line">imagePullSecrets: </span><br><span class="line">  - name: aliyun-docker</span><br><span class="line"></span><br><span class="line">nameOverride: &quot;&quot;</span><br><span class="line">fullnameOverride: &quot;&quot;</span><br><span class="line"></span><br><span class="line">podAnnotations: &#123;&#125;</span><br><span class="line"></span><br><span class="line">podSecurityContext: &#123;&#125;</span><br><span class="line">  # fsGroup: 2000</span><br><span class="line"></span><br><span class="line">securityContext: &#123;&#125;</span><br><span class="line">  # capabilities:</span><br><span class="line">  #   drop:</span><br><span class="line">  #   - ALL</span><br><span class="line">  # readOnlyRootFilesystem: true</span><br><span class="line">  # runAsNonRoot: true</span><br><span class="line">  # runAsUser: 1000</span><br><span class="line"></span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: 80</span><br><span class="line"></span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">  # We usually recommend not to specify default resources and to leave this as a conscious</span><br><span class="line">  # choice for the user. This also increases chances charts run on environments with little</span><br><span class="line">  # resources, such as Minikube. If you do want to specify resources, uncomment the following</span><br><span class="line">  # lines, adjust them as necessary, and remove the curly braces after &#x27;resources:&#x27;.</span><br><span class="line">  # limits:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line">  # requests:</span><br><span class="line">  #   cpu: 100m</span><br><span class="line">  #   memory: 128Mi</span><br><span class="line"></span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line"></span><br><span class="line">tolerations: []</span><br><span class="line"></span><br><span class="line">affinity: &#123;&#125;</span><br></pre></td></tr></table></figure><h5 id="启动前端项目"><a href="#启动前端项目" class="headerlink" title="启动前端项目"></a>启动前端项目</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install weather-push-admin /root/mydata/cicd/charts/weather-push-admin --set image.repository=xxxx --set image.tag=xxxx</span><br></pre></td></tr></table></figure><h4 id="部署完成"><a href="#部署完成" class="headerlink" title="部署完成"></a>部署完成</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@YH-UBUNTU:~/mydata/cicd/helm-script# kubectl get all</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS       AGE</span><br><span class="line">pod/weather-push-admin-75997bd55d-hpn7m   1/1     Running   3 (65m ago)    6d</span><br><span class="line">pod/weather-push-975677b54-q5c5s          1/1     Running   11 (64m ago)   7d</span><br><span class="line"></span><br><span class="line">NAME                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/kubernetes           ClusterIP   10.43.0.1       &lt;none&gt;        443/TCP    25d</span><br><span class="line">service/weather-push         ClusterIP   10.43.152.37    &lt;none&gt;        8080/TCP   7d</span><br><span class="line">service/weather-push-admin   ClusterIP   10.43.188.180   &lt;none&gt;        80/TCP     6d</span><br><span class="line"></span><br><span class="line">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/weather-push-admin   1/1     1            1           6d</span><br><span class="line">deployment.apps/weather-push         1/1     1            1           7d</span><br><span class="line"></span><br><span class="line">NAME                                            DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/weather-push-admin-75997bd55d   1         1         1       6d</span><br><span class="line">replicaset.apps/weather-push-975677b54          1         1         1       7d</span><br></pre></td></tr></table></figure><h3 id="安装ingress-nginx"><a href="#安装ingress-nginx" class="headerlink" title="安装ingress-nginx"></a>安装ingress-nginx</h3><h4 id="添加仓库"><a href="#添加仓库" class="headerlink" title="添加仓库"></a>添加仓库</h4><p><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</code></p><h4 id="拉取chart"><a href="#拉取chart" class="headerlink" title="拉取chart"></a>拉取chart</h4><p><code>helm pull ingress-nginx/ingress-nginx</code></p><h4 id="修改配置value-yaml"><a href="#修改配置value-yaml" class="headerlink" title="修改配置value.yaml"></a>修改配置value.yaml</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">controller.hostNetwork=true</span><br><span class="line">controller.dnsPolicy=ClusterFirstWithHostNet</span><br><span class="line">controller.nodeSelector.ingress=&quot;true&quot;</span><br><span class="line">controller.kind=DaemonSet</span><br></pre></td></tr></table></figure><p><strong>最后修改配置文件中的镜像仓库地址，默认是 k8s.gcr.io 国内无法访问</strong><br>修改后的配置：<a href="https://github.com/yangh124/cicd/blob/master/charts/ingress-nginx/values.yaml">https://github.com/yangh124/cicd/blob/master/charts/ingress-nginx/values.yaml</a></p><h4 id="启动ingress-nginx"><a href="#启动ingress-nginx" class="headerlink" title="启动ingress-nginx"></a>启动ingress-nginx</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install ingress-nginx /root/mydata/cicd/charts/ingress-nginx --namespace ingress-nginx</span><br><span class="line"># 给当前节点打上标签 ingress=ture</span><br><span class="line">root@YH-UBUNTU:~/mydata/cicd/charts# kubectl get node</span><br><span class="line">NAME        STATUS   ROLES                  AGE   VERSION</span><br><span class="line">yh-ubuntu   Ready    control-plane,master   27d   v1.25.6+k3s1</span><br><span class="line">root@YH-UBUNTU:~/mydata/cicd/charts# kubectl label node yh-ubuntu ingress=true </span><br><span class="line">node/yh-ubuntu labeled</span><br></pre></td></tr></table></figure><h4 id="查看-1"><a href="#查看-1" class="headerlink" title="查看"></a>查看</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@YH-UBUNTU:~/mydata/cicd/charts# kubectl -n ingress-nginx get all</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS      AGE</span><br><span class="line">pod/ingress-nginx-controller-7w5ff   1/1     Running   4 (19m ago)   6d23h</span><br><span class="line"></span><br><span class="line">NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">service/ingress-nginx-controller-admission   ClusterIP   10.43.48.154    &lt;none&gt;        443/TCP                      6d23h</span><br><span class="line">service/ingress-nginx-controller             NodePort    10.43.127.201   &lt;none&gt;        80:32080/TCP,443:32443/TCP   6d23h</span><br><span class="line"></span><br><span class="line">NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                         AGE</span><br><span class="line">daemonset.apps/ingress-nginx-controller   1         1         1       1            1           ingress=true,kubernetes.io/os=linux   6d23h</span><br></pre></td></tr></table></figure><h3 id="配置ingress"><a href="#配置ingress" class="headerlink" title="配置ingress"></a>配置ingress</h3><h4 id="配置tls证书"><a href="#配置tls证书" class="headerlink" title="配置tls证书"></a>配置tls证书</h4><p><code>kubectl create secret tls admin-tls --key=/root/ssl/8798465_admin.yh124.space.key --cert=/root/ssl/8798465_admin.yh124.space.pem</code></p><h4 id="前端ingress配置"><a href="#前端ingress配置" class="headerlink" title="前端ingress配置"></a>前端ingress配置</h4><p>ingress-nginx-admin.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">      - admin.yh124.space</span><br><span class="line">    secretName: admin-tls</span><br><span class="line">  rules:</span><br><span class="line">  - host: admin.yh124.space</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: weather-push-admin</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="后端ingress配置"><a href="#后端ingress配置" class="headerlink" title="后端ingress配置"></a>后端ingress配置</h4><p>ingress-nginx-api.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: api-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /$2</span><br><span class="line">spec:</span><br><span class="line">  tls:</span><br><span class="line">  - hosts:</span><br><span class="line">      - admin.yh124.space</span><br><span class="line">    secretName: admin-tls</span><br><span class="line">  rules:</span><br><span class="line">  - host: admin.yh124.space</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /api(/|$)(.*)</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: weather-push</span><br><span class="line">            port: </span><br><span class="line">              number: 8080</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="启用配置"><a href="#启用配置" class="headerlink" title="启用配置"></a>启用配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubelctl apply -f ingress-nginx-admin.yaml</span><br><span class="line">kubelctl apply -f ingress-nginx-api.yaml</span><br></pre></td></tr></table></figure><h4 id="查看ingress"><a href="#查看ingress" class="headerlink" title="查看ingress"></a>查看ingress</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-2-centos ~]# kubectl get ing</span><br><span class="line">NAME            CLASS    HOSTS               ADDRESS         PORTS     AGE</span><br><span class="line">api-ingress     &lt;none&gt;   admin.yh124.space   10.43.198.167   80, 443   6d22h</span><br><span class="line">admin-ingress   &lt;none&gt;   admin.yh124.space   10.43.198.167   80, 443   6d22h</span><br></pre></td></tr></table></figure><h2 id="部署完成-1"><a href="#部署完成-1" class="headerlink" title="部署完成"></a>部署完成</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-2-centos ~]# kubectl get all --all-namespaces</span><br><span class="line">NAMESPACE       NAME                                          READY   STATUS    RESTARTS      AGE</span><br><span class="line">kube-system     pod/local-path-provisioner-6c79684f77-55wlm   1/1     Running   2 (17d ago)   17d</span><br><span class="line">kube-system     pod/coredns-d76bd69b-ctlw9                    1/1     Running   2 (17d ago)   17d</span><br><span class="line">kube-system     pod/metrics-server-7cd5fcb6b7-j62zh           1/1     Running   2 (17d ago)   17d</span><br><span class="line">db-system       pod/mysql8-0                                  1/1     Running   0             8d</span><br><span class="line">db-system       pod/redis-master-0                            1/1     Running   0             8d</span><br><span class="line">default         pod/weather-push-7489dd6bb-zfk76              1/1     Running   1 (8d ago)    8d</span><br><span class="line">default         pod/weather-push-admin-5f48464c7f-ppn7v       1/1     Running   0             6d23h</span><br><span class="line">ingress-nginx   pod/ingress-nginx-controller-pd44l            1/1     Running   0             6d22h</span><br><span class="line"></span><br><span class="line">NAMESPACE       NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">default         service/kubernetes                           ClusterIP   10.43.0.1       &lt;none&gt;        443/TCP                      17d</span><br><span class="line">kube-system     service/kube-dns                             ClusterIP   10.43.0.10      &lt;none&gt;        53/UDP,53/TCP,9153/TCP       17d</span><br><span class="line">kube-system     service/metrics-server                       ClusterIP   10.43.128.65    &lt;none&gt;        443/TCP                      17d</span><br><span class="line">db-system       service/mysql8-headless                      ClusterIP   None            &lt;none&gt;        3306/TCP                     8d</span><br><span class="line">db-system       service/mysql8                               NodePort    10.43.159.214   &lt;none&gt;        3306:30306/TCP               8d</span><br><span class="line">db-system       service/redis-headless                       ClusterIP   None            &lt;none&gt;        6379/TCP                     8d</span><br><span class="line">db-system       service/redis-master                         NodePort    10.43.173.144   &lt;none&gt;        6379:30919/TCP               8d</span><br><span class="line">default         service/weather-push                         ClusterIP   10.43.253.44    &lt;none&gt;        8080/TCP                     8d</span><br><span class="line">ingress-nginx   service/ingress-nginx-controller-admission   ClusterIP   10.43.234.91    &lt;none&gt;        443/TCP                      6d23h</span><br><span class="line">ingress-nginx   service/ingress-nginx-controller             NodePort    10.43.198.167   &lt;none&gt;        80:32080/TCP,443:32443/TCP   6d23h</span><br><span class="line">default         service/weather-push-admin                   NodePort    10.43.64.109    &lt;none&gt;        80:30015/TCP                 6d23h</span><br><span class="line"></span><br><span class="line">NAMESPACE       NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                         AGE</span><br><span class="line">ingress-nginx   daemonset.apps/ingress-nginx-controller   1         1         1       1            1           ingress=true,kubernetes.io/os=linux   6d23h</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kube-system   deployment.apps/coredns                  1/1     1            1           17d</span><br><span class="line">kube-system   deployment.apps/local-path-provisioner   1/1     1            1           17d</span><br><span class="line">kube-system   deployment.apps/metrics-server           1/1     1            1           17d</span><br><span class="line">default       deployment.apps/weather-push             1/1     1            1           8d</span><br><span class="line">default       deployment.apps/weather-push-admin       1/1     1            1           6d23h</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">kube-system   replicaset.apps/coredns-d76bd69b                    1         1         1       17d</span><br><span class="line">kube-system   replicaset.apps/local-path-provisioner-6c79684f77   1         1         1       17d</span><br><span class="line">kube-system   replicaset.apps/metrics-server-7cd5fcb6b7           1         1         1       17d</span><br><span class="line">default       replicaset.apps/weather-push-7489dd6bb              1         1         1       8d</span><br><span class="line">default       replicaset.apps/weather-push-admin-5f48464c7f       1         1         1       6d23h</span><br><span class="line"></span><br><span class="line">NAMESPACE   NAME                            READY   AGE</span><br><span class="line">db-system   statefulset.apps/mysql8         1/1     8d</span><br><span class="line">db-system   statefulset.apps/redis-master   1/1     8d</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;k3s简介&quot;&gt;&lt;a href=&quot;#k3s简介&quot; class=&quot;headerlink&quot; title=&quot;k3s简介&quot;&gt;&lt;/a&gt;k3s简介&lt;/h2&gt;&lt;p&gt;K3s 是一个轻量级的 Kubernetes 发行版，它针对边缘计算、物联网等场景进行了高度优化。K3s 有以下增强</summary>
      
    
    
    
    <category term="运维" scheme="https://yangh124.github.io/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="k8s" scheme="https://yangh124.github.io/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>MySQL性能分析工具的使用</title>
    <link href="https://yangh124.github.io/2022/06/06/MySQL%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://yangh124.github.io/2022/06/06/MySQL%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2022-06-05T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.122Z</updated>
    
    <content type="html"><![CDATA[<p>在数据库调优中，我们的目标就是<strong>响应时间更快，吞吐量更大</strong>。利用宏观的监控工具和微观的日志分析可以帮助我们快速的找到调优的思路和方式。</p><h2 id="数据库服务优化步骤"><a href="#数据库服务优化步骤" class="headerlink" title="数据库服务优化步骤"></a>数据库服务优化步骤</h2><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/06/16545259909755.jpg" alt="16545259909755"><br><strong>小结：</strong></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/07/16546045730301.jpg" alt="16546045730301"></p><h2 id="查看系统性能参数"><a href="#查看系统性能参数" class="headerlink" title="查看系统性能参数"></a>查看系统性能参数</h2><p>在MySQL中，可以使用<strong>show status</strong>语句查询一些MySQL数据库服务器的<strong>性能参数</strong>、<strong>执行频率</strong>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW [GLOBAL | SESSION] STATUS LIKE &#x27;参数&#x27;</span><br></pre></td></tr></table></figure><p>一些常用的性能参数如下：</p><ul><li>Connections：连接MySQL服务器的次数</li><li>Uptime：MySQL服务器的上线时间</li><li>Slow_queries：慢查询的次数</li><li>Innodb_rows_read：select查询返回的行数</li><li>Innodb_rows_inserted：insert操作插入的行数</li><li>Innodb_rows_updated：update操作更新的行数</li><li>Innodb_rows_deleted：delete操作删除的行数</li><li>Com_select：查询操作的次数</li><li>Com_insert：插入操作的次数，对于批量插入的insert操作，只累加一次。</li><li>Com_update：更新操作的次数</li><li>Com_delete：删除操作的次数</li></ul><h2 id="统计SQL的查询成本：last-query-cost"><a href="#统计SQL的查询成本：last-query-cost" class="headerlink" title="统计SQL的查询成本：last_query_cost"></a>统计SQL的查询成本：last_query_cost</h2><p>如果想要查看某条SQL语句的查询成本，可以在执行完这条SQL语句之后，通过查询当前会话的last_query_cost变量值来得到当前查询的成本。它通常也是我们<strong>评价一个查询的执行效率</strong>的一个常用指标。这个查询的成本对应的是<strong>SQL语句所需要读取的页的数量</strong>。</p><h2 id="定位执行慢的SQL：慢查询日志"><a href="#定位执行慢的SQL：慢查询日志" class="headerlink" title="定位执行慢的SQL：慢查询日志"></a>定位执行慢的SQL：慢查询日志</h2><p>默认情况下，MySQL数据库没有开启慢查询日志，需要手动设置这个参数。如果不是调优的需要的话，一般不建议启动该参数，因为开启慢查询日志或多或少会带来一些性能影响。</p><h3 id="开启慢查询日志参数"><a href="#开启慢查询日志参数" class="headerlink" title="开启慢查询日志参数"></a>开启慢查询日志参数</h3><h4 id="开启slow-query-log"><a href="#开启slow-query-log" class="headerlink" title="开启slow_query_log"></a>开启slow_query_log</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 查看是否开启</span><br><span class="line">SHOW VARIABLES LIKE &#x27;%slow_query%&#x27;;</span><br><span class="line"># 开启慢查询日志</span><br><span class="line">SET GLOBAL slow_query_log = on;</span><br></pre></td></tr></table></figure><h4 id="设置long-query-time"><a href="#设置long-query-time" class="headerlink" title="设置long_query_time"></a>设置long_query_time</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看long_query_time</span><br><span class="line">SHOW VARIABLES LIKE &#x27;%long_query_time%&#x27;;</span><br><span class="line"># 修改为1秒</span><br><span class="line">SET SESSION long_query_time = 1;</span><br><span class="line">SET GLOBAL long_query_time = 1;</span><br></pre></td></tr></table></figure><h4 id="永久设置"><a href="#永久设置" class="headerlink" title="永久设置"></a>永久设置</h4><p>配置my.conf<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/07/16546070983974.jpg" alt="16546070983974"></p><h4 id="慢查询日志分析工具：mysqldumpslow"><a href="#慢查询日志分析工具：mysqldumpslow" class="headerlink" title="慢查询日志分析工具：mysqldumpslow"></a>慢查询日志分析工具：mysqldumpslow</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 取出使用最多的10条慢查询</span><br><span class="line">mysqldumpslow -s c -t 10 /data/mysql/xxx-slow.log</span><br><span class="line"> </span><br><span class="line"># 取出查询时间最慢的3条慢查询 </span><br><span class="line">mysqldumpslow -s t -t 3 /data/mysql/xxx-slow.log</span><br><span class="line"> </span><br><span class="line"># 得到按照时间排序的前10条里面含有左连接的查询语句 </span><br><span class="line">mysqldumpslow -s t -t 10 -g “left join” /data/mysql/xxx-slow.log</span><br><span class="line"> </span><br><span class="line"># 按照扫描行数最多的</span><br><span class="line">mysqldumpslow -s r -t 10 -g &#x27;left join&#x27; /data/mysql/xxx-slow.log</span><br></pre></td></tr></table></figure><h2 id="查看SQL执行成本：SHOW-PROFILE"><a href="#查看SQL执行成本：SHOW-PROFILE" class="headerlink" title="查看SQL执行成本：SHOW PROFILE"></a>查看SQL执行成本：SHOW PROFILE</h2><p>SHOW PROFILE是MySQL提供的可以用来分析当前会话中的SQL都做了什么，执行的资源消耗情况，可用于sql调优的测量。<strong>默认情况下是关闭的</strong>。并保存最近15次的运行结果。<br>我们可以在会话级别开启这个功能</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;profiling&#x27;;</span><br><span class="line">SET profiling = ON;</span><br></pre></td></tr></table></figure><p>查看最近的查询</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILES;</span><br></pre></td></tr></table></figure><p>查看某一个查询的详细信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILE ALL FOR QUERY [QUERY_ID];</span><br></pre></td></tr></table></figure><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/07/16546092097996.jpg" alt="16546092097996"></p><h2 id="分析查询语句：EXPLAIN"><a href="#分析查询语句：EXPLAIN" class="headerlink" title="分析查询语句：EXPLAIN"></a>分析查询语句：EXPLAIN</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT|DELETE|UPDATE|INSERT xxxx;</span><br></pre></td></tr></table></figure><h3 id="EXPLAIN语句输出的各个列的作用如下："><a href="#EXPLAIN语句输出的各个列的作用如下：" class="headerlink" title="EXPLAIN语句输出的各个列的作用如下："></a>EXPLAIN语句输出的各个列的作用如下：</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/07/16546100275416.jpg" alt="16546100275416"></p><h2 id="EXPLAIN的进一步使用"><a href="#EXPLAIN的进一步使用" class="headerlink" title="EXPLAIN的进一步使用"></a>EXPLAIN的进一步使用</h2><h3 id="EXPLAIN四种输出格式"><a href="#EXPLAIN四种输出格式" class="headerlink" title="EXPLAIN四种输出格式"></a>EXPLAIN四种输出格式</h3><h4 id="传统格式"><a href="#传统格式" class="headerlink" title="传统格式"></a>传统格式</h4><p>传统格式输出一个表格形式，概要说明查询计划。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN xxxxxx</span><br></pre></td></tr></table></figure><h4 id="JSON格式"><a href="#JSON格式" class="headerlink" title="JSON格式"></a>JSON格式</h4><p>第一种格式中介绍的EXPLAIN语句输出中缺少了一个衡量执行计划好坏的重要属性 – <strong>成本</strong>。而JSON格式是四种格式中输出<strong>信息最详尽</strong>的格式，里面包含了执行的成本信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN FORMAT=JSON xxxxx</span><br></pre></td></tr></table></figure><p>EXPLAIN的Column与JSON的对应关系：（来源于Mysql5.7文档）<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/14/16552108538058.jpg" alt="16552108538058"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;query_block&quot;: &#123;</span><br><span class="line">    &quot;select_id&quot;: 1,</span><br><span class="line">    &quot;cost_info&quot;: &#123;</span><br><span class="line">      &quot;query_cost&quot;: &quot;3.83&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;table&quot;: &#123;</span><br><span class="line">      &quot;table_name&quot;: &quot;sys_user&quot;,</span><br><span class="line">      &quot;access_type&quot;: &quot;range&quot;,</span><br><span class="line">      &quot;possible_keys&quot;: [</span><br><span class="line">        &quot;PRIMARY&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;key&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">      &quot;used_key_parts&quot;: [</span><br><span class="line">        &quot;id&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;key_length&quot;: &quot;4&quot;,</span><br><span class="line">      &quot;rows_examined_per_scan&quot;: 7,</span><br><span class="line">      &quot;rows_produced_per_join&quot;: 7,</span><br><span class="line">      &quot;filtered&quot;: &quot;100.00&quot;,</span><br><span class="line">      &quot;cost_info&quot;: &#123;</span><br><span class="line">        &quot;read_cost&quot;: &quot;2.43&quot;,</span><br><span class="line">        &quot;eval_cost&quot;: &quot;1.40&quot;,</span><br><span class="line">        &quot;prefix_cost&quot;: &quot;3.83&quot;,</span><br><span class="line">        &quot;data_read_per_join&quot;: &quot;80K&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;used_columns&quot;: [</span><br><span class="line">        &quot;id&quot;,</span><br><span class="line">        &quot;login_name&quot;,</span><br><span class="line">        &quot;password&quot;,</span><br><span class="line">        ...</span><br><span class="line">      ],</span><br><span class="line">      &quot;attached_condition&quot;: &quot;(`sys_user`.`id` &gt; 1)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TREE格式"><a href="#TREE格式" class="headerlink" title="TREE格式"></a>TREE格式</h4><p>tree格式是8.0.16版本之后引入的新格式，主要根据查询的<strong>各个部分之间的关系</strong>和<strong>各部分的执行顺序</strong>来描述如何查询。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/14/16552115947740.jpg" alt="16552115947740"></p><h4 id="可视化输出"><a href="#可视化输出" class="headerlink" title="可视化输出"></a>可视化输出</h4><h3 id="SHOW-WARNINGS的使用"><a href="#SHOW-WARNINGS的使用" class="headerlink" title="SHOW WARNINGS的使用"></a>SHOW WARNINGS的使用</h3><p>在使用了EXPLAIN语句查看了某个查询的执行计划后，紧跟着还可以使用SHOW WARNINGS语句查看与这个查询的执行计划有关的一些扩展信息。</p><h2 id="分析优化器执行计划：trace"><a href="#分析优化器执行计划：trace" class="headerlink" title="分析优化器执行计划：trace"></a>分析优化器执行计划：trace</h2><p>OPTIMIZED_TRACE是MySQL5.6引入的一项跟踪功能，他可以跟踪优化器做出的各种决策（比如访问表的方法、各种开销计算、各种转换等），并将跟踪结果记录到<strong>INFORMATION_SCHEMA.OPTIMIZER_TACE</strong>表中。<br>此功能默认是关闭的。开启trace，并设置格式为JSON，同时设置trace最大能够使用的内存的大小，避免解析过程中因为默认内存大小而不能够完整展示。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET optimizer_trace=&quot;enable=on&quot;,end_markers_in_json=on;</span><br><span class="line">SET optimizer_trace_max_mem_size=1000000;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select xxxxxx;</span><br><span class="line"></span><br><span class="line">SELECT * FROM information_schema.OPTIMIZER_TRACE;</span><br></pre></td></tr></table></figure><h2 id="MySQL监控分析视图：sys-schema"><a href="#MySQL监控分析视图：sys-schema" class="headerlink" title="MySQL监控分析视图：sys schema"></a>MySQL监控分析视图：sys schema</h2><h3 id="索引情况"><a href="#索引情况" class="headerlink" title="索引情况"></a>索引情况</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 1.查询冗余的索引</span><br><span class="line">SELECT * FROM sys.schema_redundant_indexes;</span><br><span class="line"># 2.查询未使用过的索引</span><br><span class="line">SELECT * FROM sys.schema_unused_indexes;</span><br><span class="line"># 3.查询索引的使用情况</span><br><span class="line">SELECT * FROM sys.schema_index_statistics WHERE table_schema=&#x27;dbname&#x27;;</span><br></pre></td></tr></table></figure><h3 id="表相关"><a href="#表相关" class="headerlink" title="表相关"></a>表相关</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 4.查询表的访问量</span><br><span class="line">SELECT table_schema,table_name,SUM(io_read_requests+io_write_requests) AS io FROM sys.schema_table_statistics GROUP BY table_schema,table_name ORDER BY io desc;</span><br><span class="line"># 5.查询占用buffer pool较多的表</span><br><span class="line">SELECT object_schema,object_name,allocated,data FROM sys.innodb_buffer_stats_by_table ORDER BY allocated LIMIT 10;</span><br><span class="line"># 6.查看表的全表扫描情况</span><br><span class="line">SELECT * FROM sys.statements_with_full_table_scans WHERE db=&#x27;dbname&#x27;;</span><br></pre></td></tr></table></figure><h3 id="语句相关"><a href="#语句相关" class="headerlink" title="语句相关"></a>语句相关</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 7.监控SQL执行的频率</span><br><span class="line">SELECT db,exec_count,query FROM sys.statement_analysis ORDER BY exec_count desc;</span><br><span class="line"># 8.监控使用了排序的SQL</span><br><span class="line">SELECT db,exec_count,first_seen,last_seen,query FROM sys.statements_with_sorting LIMIT 1;</span><br><span class="line"># 9.监控使用了临时表或者磁盘临时表的SQL</span><br><span class="line">SELECT db,exec_count,tmp_tables,tmp_disk_tables,query FROM sys.statement_analysis WHERE tmp_tables&gt;0 OR tmp_disk_tables &gt; 0 ORDER BY (tmp_tables+tmp_disk_tables) DESC;</span><br></pre></td></tr></table></figure><h3 id="IO相关"><a href="#IO相关" class="headerlink" title="IO相关"></a>IO相关</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 10.查看消耗的磁盘IO文件</span><br><span class="line">SELECT file,avg_read,avg_write,avg_read+avg_write as avg_io FROM sys.io_global_by_file_by_bytes ORDER BY avg_read limit 10;</span><br></pre></td></tr></table></figure><h3 id="innodb相关"><a href="#innodb相关" class="headerlink" title="innodb相关"></a>innodb相关</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM sys.innodb_lock_waits;</span><br></pre></td></tr></table></figure><blockquote><p><strong>风险提示：</strong><br>通过sys库去查询时，MySQL会消耗大量资源去收集相关信息，严重的可能会导致业务请求被阻塞，从而引起故障。建议生产环境不要频繁去查询sys或performance_schema、information_schema来完成监控、巡检等工作。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在数据库调优中，我们的目标就是&lt;strong&gt;响应时间更快，吞吐量更大&lt;/strong&gt;。利用宏观的监控工具和微观的日志分析可以帮助我们快速的找到调优的思路和方式。&lt;/p&gt;
&lt;h2 id=&quot;数据库服务优化步骤&quot;&gt;&lt;a href=&quot;#数据库服务优化步骤&quot; class=&quot;hea</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="MySQL" scheme="https://yangh124.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Redisson分布式锁（使用注解方式）</title>
    <link href="https://yangh124.github.io/2022/05/30/Redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%88%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%EF%BC%89/"/>
    <id>https://yangh124.github.io/2022/05/30/Redisson%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%EF%BC%88%E4%BD%BF%E7%94%A8%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%EF%BC%89/</id>
    <published>2022-05-29T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.124Z</updated>
    
    <content type="html"><![CDATA[<h2 id="引入pom依赖"><a href="#引入pom依赖" class="headerlink" title="引入pom依赖"></a>引入pom依赖</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.redisson&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.13.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h2 id="配置RedissonClient"><a href="#配置RedissonClient" class="headerlink" title="配置RedissonClient"></a>配置RedissonClient</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import org.redisson.Redisson;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.redisson.config.Config;</span><br><span class="line">import org.redisson.config.SingleServerConfig;</span><br><span class="line">import org.redisson.config.TransportMode;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/11/29 14:03</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class RedissonConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span><br><span class="line">    private String host;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span><br><span class="line">    private int port;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span><br><span class="line">    private String password;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public RedissonClient redissonClient() &#123;</span><br><span class="line">        Config config = new Config();</span><br><span class="line">        // 这里使用最简单的单机模式</span><br><span class="line">        SingleServerConfig singleServerConfig = config.useSingleServer();</span><br><span class="line">        singleServerConfig.setAddress(&quot;redis://&quot; + host + &quot;:&quot; + port);</span><br><span class="line">        singleServerConfig.setPassword(password);</span><br><span class="line">        return Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义RedissonLock注解"><a href="#自定义RedissonLock注解" class="headerlink" title="自定义RedissonLock注解"></a>自定义RedissonLock注解</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import java.lang.annotation.*;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2022/5/27 16:05</span><br><span class="line"> */</span><br><span class="line">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">public @interface RedissonLock &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 锁的key</span><br><span class="line">     */</span><br><span class="line">    String value();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 锁的key SpEL 表达式</span><br><span class="line">     * </span><br><span class="line">     */</span><br><span class="line">    String key() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 加锁时间</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    long time() default -1;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 时间单位</span><br><span class="line">     *</span><br><span class="line">     */</span><br><span class="line">    TimeUnit timeUnit() default TimeUnit.SECONDS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="定义Aspect"><a href="#定义Aspect" class="headerlink" title="定义Aspect"></a>定义Aspect</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">import java.util.Objects;</span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">import org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line">import org.aspectj.lang.annotation.AfterThrowing;</span><br><span class="line">import org.aspectj.lang.annotation.Around;</span><br><span class="line">import org.aspectj.lang.annotation.Aspect;</span><br><span class="line">import org.aspectj.lang.annotation.Pointcut;</span><br><span class="line">import org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line">import org.redisson.api.RLock;</span><br><span class="line">import org.redisson.api.RedissonClient;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.core.DefaultParameterNameDiscoverer;</span><br><span class="line">import org.springframework.expression.EvaluationContext;</span><br><span class="line">import org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line">import org.springframework.expression.spel.support.StandardEvaluationContext;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2022/5/27 16:07</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Aspect</span><br><span class="line">public class RedissonLockAspect &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedissonClient redissonClient;</span><br><span class="line">    </span><br><span class="line">    // redis key全局前缀</span><br><span class="line">    @Value(&quot;$&#123;spring.redis.prefix&#125;&quot;)</span><br><span class="line">    private String redisPrefix;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 用于SpEL表达式解析</span><br><span class="line">     */</span><br><span class="line">    private final SpelExpressionParser spelExpressionParser = new SpelExpressionParser();</span><br><span class="line">    /**</span><br><span class="line">     * 用于获取方法参数定义名字</span><br><span class="line">     */</span><br><span class="line">    private final DefaultParameterNameDiscoverer defaultParameterNameDiscoverer = new DefaultParameterNameDiscoverer();</span><br><span class="line"></span><br><span class="line">    @Pointcut(&quot;@annotation(com.xxx.annotation.RedissonLock)&quot;)</span><br><span class="line">    public void LockAspect() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    @Around(&quot;LockAspect()&quot;)</span><br><span class="line">    public Object around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123;</span><br><span class="line">        Object object;</span><br><span class="line">        RLock lock = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 获取注解实体信息</span><br><span class="line">            RedissonLock lockEntity =</span><br><span class="line">                (((MethodSignature)proceedingJoinPoint.getSignature()).getMethod()).getAnnotation(RedissonLock.class);</span><br><span class="line">            String key = lockEntity.key();</span><br><span class="line">            String cacheName = lockEntity.value();</span><br><span class="line">            long time = lockEntity.time();</span><br><span class="line">            TimeUnit timeUnit = lockEntity.timeUnit();</span><br><span class="line">            // 根据名字获取锁实例</span><br><span class="line">            lock = redissonClient.getLock(getKey(cacheName, key, proceedingJoinPoint));</span><br><span class="line">            // 这里加锁失败会阻塞等待；也可以使用tryLock，不阻塞，加锁失败返回flase，自行处理后续逻辑（比如抛异常）</span><br><span class="line">            lock.lock(time, timeUnit);</span><br><span class="line">            object = proceedingJoinPoint.proceed();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (Objects.nonNull(lock) &amp;&amp; lock.isHeldByCurrentThread()) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @AfterThrowing(value = &quot;LockAspect()&quot;, throwing = &quot;ex&quot;)</span><br><span class="line">    public void afterThrowing(Throwable ex) &#123;</span><br><span class="line">        throw new RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取缓存的key</span><br><span class="line">     *</span><br><span class="line">     * key 定义在注解上，支持SPEL表达式 cacheName 为缓存的名称</span><br><span class="line">     * </span><br><span class="line">     *</span><br><span class="line">     * @return 缓存的key -&gt; redisPrefix:cacheName:SpELVal</span><br><span class="line">     */</span><br><span class="line">    public String getKey(String cacheName, String spel, ProceedingJoinPoint proceedingJoinPoint) &#123;</span><br><span class="line">        MethodSignature methodSignature = (MethodSignature)proceedingJoinPoint.getSignature();</span><br><span class="line">        String[] paramNames = defaultParameterNameDiscoverer.getParameterNames(methodSignature.getMethod());</span><br><span class="line">        if (!&quot;&quot;.equals(spel) &amp;&amp; null != paramNames &amp;&amp; paramNames.length &gt; 0) &#123;</span><br><span class="line">            EvaluationContext context = new StandardEvaluationContext();</span><br><span class="line">            Object[] args = proceedingJoinPoint.getArgs();</span><br><span class="line">            for (int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">                context.setVariable(paramNames[i], args[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            Object value = spelExpressionParser.parseExpression(spel).getValue(context);</span><br><span class="line">            if (null != value) &#123;</span><br><span class="line">                return redisPrefix + &quot;:&quot; + cacheName + &quot;:&quot; + value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return redisPrefix + &quot;:&quot; + cacheName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 也可以指定加锁时间 time设值</span><br><span class="line">@RedissonLock(value = &quot;test:lock&quot;, key = &quot;#id&quot;)</span><br><span class="line">public void testLock(Long id) &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="查看redis中的锁"><a href="#查看redis中的锁" class="headerlink" title="查看redis中的锁"></a>查看redis中的锁</h2><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/05/30/16539146066735.jpg" alt="16539146066735"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;引入pom依赖&quot;&gt;&lt;a href=&quot;#引入pom依赖&quot; class=&quot;headerlink&quot; title=&quot;引入pom依赖&quot;&gt;&lt;/a&gt;引入pom依赖&lt;/h2&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td cl</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="分布式" scheme="https://yangh124.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Docker实战</title>
    <link href="https://yangh124.github.io/2022/05/20/Docker%E5%AE%9E%E6%88%98/"/>
    <id>https://yangh124.github.io/2022/05/20/Docker%E5%AE%9E%E6%88%98/</id>
    <published>2022-05-19T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.115Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Docker-部署springboot项目"><a href="#Docker-部署springboot项目" class="headerlink" title="Docker 部署springboot项目"></a>Docker 部署springboot项目</h2><pre><code>使用docker-maven-plugin maven插件</code></pre><h3 id="服务器安装docker"><a href="#服务器安装docker" class="headerlink" title="服务器安装docker"></a>服务器安装docker</h3><pre><code>略</code></pre><h3 id="Docker开启远程访问"><a href="#Docker开启远程访问" class="headerlink" title="Docker开启远程访问"></a>Docker开启远程访问</h3><ol><li>查看docker服务状态（查看docker.service位置）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pi@raspberrypi:~ $ service docker status</span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)</span><br><span class="line">     Active: active (running) since Sun 2022-04-17 17:28:04 CST; 1 months 2 days ago</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>编辑docker.service<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure></li><li>修改[Service]下的ExecStart，添加-H tcp:&#x2F;&#x2F;0.0.0.0:2375；对外开放docker服务（建议不要使用默认端口2375）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure></li><li>重新加载Docker配置生效 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload </span><br><span class="line">systemctl restart docker </span><br></pre></td></tr></table></figure></li><li>服务器防火墙开放端口</li><li>浏览器访问<a href="http://ip:2375/version%EF%BC%8C%E6%B5%8B%E8%AF%95%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F">http://ip:2375/version，测试是否成功</a></li></ol><h3 id="使用TLS-HTTPS-保证Docker服务安全"><a href="#使用TLS-HTTPS-保证Docker服务安全" class="headerlink" title="使用TLS(HTTPS)保证Docker服务安全"></a>使用TLS(HTTPS)保证Docker服务安全</h3><h4 id="1-服务器端生成CA共钥和私钥"><a href="#1-服务器端生成CA共钥和私钥" class="headerlink" title="1. 服务器端生成CA共钥和私钥"></a>1. 服务器端生成CA共钥和私钥</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 创建目录存放CA证书</span><br><span class="line">pi@raspberrypi:~ $ mkdir ca</span><br><span class="line"></span><br><span class="line"># 进入目录</span><br><span class="line">pi@raspberrypi:~ $ cd ca</span><br><span class="line"></span><br><span class="line"># 生成私钥（会提示输入密码）</span><br><span class="line">pi@raspberrypi:~/ca $ openssl genrsa -aes256 -out ca-key.pem 4096</span><br><span class="line">Generating RSA private key, 4096 bit long modulus (2 primes)</span><br><span class="line">..........................++++</span><br><span class="line">.......++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line">Enter pass phrase for ca-key.pem:</span><br><span class="line"></span><br><span class="line"># 生成证书信息（需要输入上面的密码以及一些其他信息【注意Common Name填写服务器外网IP】）</span><br><span class="line">pi@raspberrypi:~/ca $ openssl req -new -x509 -days 3650 -key ca-key.pem -sha256 -out ca.pem</span><br><span class="line">Enter pass phrase for ca-key.pem:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:CN</span><br><span class="line">State or Province Name (full name) [Some-State]:ZheJiang</span><br><span class="line">Locality Name (eg, city) []:HangZhou</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:yanghao </span><br><span class="line">Organizational Unit Name (eg, section) []:yanghao</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:192.168.3.3</span><br><span class="line">Email Address []:yh.124@qq.com</span><br></pre></td></tr></table></figure><p><strong>有了CA之后，就可以创建服务器密钥和证书签名请求(CSR)了。确保“Common Name”与你连接Docker时使用的主机名匹配</strong></p><h4 id="2-创建服务器密钥和证书签名请求"><a href="#2-创建服务器密钥和证书签名请求" class="headerlink" title="2. 创建服务器密钥和证书签名请求"></a>2. 创建服务器密钥和证书签名请求</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建服务器密钥</span><br><span class="line">pi@raspberrypi:~/ca $ openssl genrsa -out server-key.pem 4096</span><br><span class="line">Generating RSA private key, 4096 bit long modulus (2 primes)</span><br><span class="line">................................................................++++</span><br><span class="line">.........++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line"># 证书签名请求（注意修改为你的服务器IP）</span><br><span class="line">openssl req -subj &quot;/CN=192.168.3.3&quot; -sha256 -new -key server-key.pem -out server.csr</span><br></pre></td></tr></table></figure><h4 id="3-配置白名单"><a href="#3-配置白名单" class="headerlink" title="3. 配置白名单"></a>3. 配置白名单</h4><p>配置白名单，允许连接的ip（通过证书）;IP可以配置多个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo subjectAltName = IP:192.168.3.3,IP::192.168.3.5 &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure><h4 id="4-设置Docker守护进程密钥的扩展使用属性，仅用于服务器身份验证"><a href="#4-设置Docker守护进程密钥的扩展使用属性，仅用于服务器身份验证" class="headerlink" title="4. 设置Docker守护进程密钥的扩展使用属性，仅用于服务器身份验证"></a>4. 设置Docker守护进程密钥的扩展使用属性，仅用于服务器身份验证</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo extendedKeyUsage = serverAuth &gt;&gt; extfile.cnf</span><br></pre></td></tr></table></figure><h4 id="5-生成签名证书（需要输入密码）"><a href="#5-生成签名证书（需要输入密码）" class="headerlink" title="5. 生成签名证书（需要输入密码）"></a>5. 生成签名证书（需要输入密码）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -days 3650 -sha256 -in server.csr -CA ca.pem -CAkey ca-key.pem \</span><br><span class="line">  -CAcreateserial -out server-cert.pem -extfile extfile.cnf</span><br></pre></td></tr></table></figure><h4 id="6-对于客户端身份验证，创建一个客户端密钥和证书签名请求"><a href="#6-对于客户端身份验证，创建一个客户端密钥和证书签名请求" class="headerlink" title="6. 对于客户端身份验证，创建一个客户端密钥和证书签名请求"></a>6. 对于客户端身份验证，创建一个客户端密钥和证书签名请求</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 生成 key.pem</span><br><span class="line">openssl genrsa -out key.pem 4096</span><br><span class="line"></span><br><span class="line"># 生成 csr</span><br><span class="line">openssl req -subj &#x27;/CN=client&#x27; -new -key key.pem -out client.csr</span><br><span class="line"></span><br><span class="line"># 创建配置文件</span><br><span class="line">echo extendedKeyUsage = clientAuth &gt; extfile-client.cnf</span><br><span class="line"></span><br><span class="line"># 生成签名证书</span><br><span class="line">openssl x509 -req -days 3650 -sha256 -in client.csr -CA ca.pem -CAkey ca-key.pem \</span><br><span class="line">  -CAcreateserial -out cert.pem -extfile extfile-client.cnf</span><br><span class="line">  </span><br><span class="line"># 将服务器端的ca.pem cert.pem key.pem复制到本地</span><br><span class="line">scp ca.pem cert.pem key.pem yh@192.168.3.5:/Users/yh/ca</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="7-删除不需要的文件"><a href="#7-删除不需要的文件" class="headerlink" title="7. 删除不需要的文件"></a>7. 删除不需要的文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 服务器（服务端）</span><br><span class="line">rm -rf server.csr extfile.cnf client.csr extfile-client.cnf</span><br></pre></td></tr></table></figure><h4 id="8-修改文件权限，防止误删"><a href="#8-修改文件权限，防止误删" class="headerlink" title="8. 修改文件权限，防止误删"></a>8. 修改文件权限，防止误删</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 服务端</span><br><span class="line">chmod -v 0400 ca-key.pem server-key.pem</span><br><span class="line">chmod -v 0444 ca.pem server-cert.pem</span><br><span class="line"># 客户端</span><br><span class="line">chmod -v 0400 key.pem</span><br><span class="line">chmod -v 0444 ca.pem cert.pem</span><br></pre></td></tr></table></figure><h4 id="9-再次修改服务器docker-service"><a href="#9-再次修改服务器docker-service" class="headerlink" title="9. 再次修改服务器docker.service"></a>9. 再次修改服务器docker.service</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /lib/systemd/system/docker.service</span><br><span class="line"># 修改ExecStart（添加证书的路径）</span><br><span class="line">ExecStart=/usr/bin/dockerd --tlsverify --tlscacert=/home/pi/ca/ca.pem --tlscert=/home/pi/ca/server-cert.pem --tlskey=/home/pi/ca/server-key.pem -H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock</span><br></pre></td></tr></table></figure><h4 id="10-重新加载daemon并重启docker"><a href="#10-重新加载daemon并重启docker" class="headerlink" title="10. 重新加载daemon并重启docker"></a>10. 重新加载daemon并重启docker</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart docker</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="11-配置本地环境变量"><a href="#11-配置本地环境变量" class="headerlink" title="11. 配置本地环境变量"></a>11. 配置本地环境变量</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv ~/.docker</span><br><span class="line"># 将证书copy到.docker下</span><br><span class="line">cp -v &#123;ca,cert,key&#125;.pem ~/.docker</span><br><span class="line">chmod -v 0400 key.pem</span><br><span class="line">chmod -v 0444 ca.pem cert.pem</span><br><span class="line"># 配置环境变量</span><br><span class="line">export DOCKER_HOST=tcp://0.0.0.0:2376 DOCKER_TLS_VERIFY=1</span><br></pre></td></tr></table></figure><h4 id="12-客户端测试"><a href="#12-客户端测试" class="headerlink" title="12. 客户端测试"></a>12. 客户端测试</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 配置了环境变量后就可以访问服务器docker服务</span><br><span class="line">docker ps</span><br><span class="line"># 没有配置环境变量</span><br><span class="line">docker --tlsverify --tlscacert=/Users/yh/.docker/ca.pem --tlscert=/Users/yh/.docker/cert.pem --tlskey=/Users/yh/.docker/key.pem -H=tcp://192.168.3.3:2376 version</span><br></pre></td></tr></table></figure><h3 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h3><h4 id="配置docker-file-maven-plugin插件"><a href="#配置docker-file-maven-plugin插件" class="headerlink" title="配置docker-file-maven-plugin插件"></a>配置docker-file-maven-plugin插件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;!-- dockerfile maven --&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;com.spotify&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;dockerfile-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;executions&gt;</span><br><span class="line">                &lt;execution&gt;</span><br><span class="line">                    &lt;id&gt;default&lt;/id&gt;</span><br><span class="line">                    &lt;goals&gt;</span><br><span class="line">                        &lt;goal&gt;build&lt;/goal&gt;</span><br><span class="line">                        &lt;goal&gt;push&lt;/goal&gt;</span><br><span class="line">                    &lt;/goals&gt;</span><br><span class="line">                    &lt;configuration&gt;</span><br><span class="line">                    &lt;/configuration&gt;</span><br><span class="line">                &lt;/execution&gt;</span><br><span class="line">            &lt;/executions&gt;</span><br><span class="line">            &lt;!--docker镜像相关的配置信息--&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;contextDirectory&gt;$&#123;project.basedir&#125;&lt;/contextDirectory&gt;</span><br><span class="line">                &lt;dockerfile&gt;$&#123;project.basedir&#125;/Dockerfile&lt;/dockerfile&gt;</span><br><span class="line">                &lt;!--使用username和password标签，也可以使用useMavenSettingsForAuth，在settings.xml文件中的配置 servers--&gt;</span><br><span class="line">                &lt;useMavenSettingsForAuth&gt;false&lt;/useMavenSettingsForAuth&gt;</span><br><span class="line">                &lt;username&gt;xxx&lt;/username&gt;</span><br><span class="line">                &lt;password&gt;xxx&lt;/password&gt;</span><br><span class="line">                &lt;!--远程仓库地址--&gt;</span><br><span class="line">                &lt;repository&gt;$&#123;docker.repository.registry&#125;/$&#123;docker.repository.namespace&#125;/$&#123;project.artifactId&#125;&lt;/repository&gt;</span><br><span class="line">                &lt;tag&gt;$&#123;project.version&#125;&lt;/tag&gt;</span><br><span class="line">                &lt;buildArgs&gt;</span><br><span class="line">                    &lt;JAR_FILE&gt;$&#123;project.build.finalName&#125;.jar&lt;/JAR_FILE&gt;</span><br><span class="line">                &lt;/buildArgs&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br></pre></td></tr></table></figure><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">FROM houwm/jdk8:arm64</span><br><span class="line"></span><br><span class="line">MAINTAINER yanghao&lt;yh.124@qq.com&gt;</span><br><span class="line"></span><br><span class="line"># 参数</span><br><span class="line">ARG JAR_FILE</span><br><span class="line"></span><br><span class="line"># 环境变量</span><br><span class="line">ENV TZ=Asia/Shanghai LANG=C.UTF-8</span><br><span class="line">ENV PARAMS=&quot;--server.port=8080 --spring.profiles.active=prod -Xms512m -Xmx512m&quot;</span><br><span class="line"></span><br><span class="line"># 设置时区</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line"># 复制jar包</span><br><span class="line">COPY target/$&#123;JAR_FILE&#125; /app.jar</span><br><span class="line"></span><br><span class="line"># 暴露端口</span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line"># 工作目录</span><br><span class="line">WORKDIR /</span><br><span class="line"></span><br><span class="line"># 执行命令</span><br><span class="line">ENTRYPOINT [&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;java -jar /app.jar $&#123;PARAMS&#125;&quot;]</span><br></pre></td></tr></table></figure><h4 id="部署项目"><a href="#部署项目" class="headerlink" title="部署项目"></a>部署项目</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 会自动在远程服务器构建镜像</span><br><span class="line">mvn package</span><br><span class="line"># 就可以省略这个步骤</span><br><span class="line">mvn dockerfile:build</span><br><span class="line"># 会自动推送镜像到远程仓库</span><br><span class="line">mvn deploy</span><br><span class="line"># 就可以省略这个步骤</span><br><span class="line">mvn dockerfile:push</span><br><span class="line"># 如果要临时跳过所有的Dockerfile相关的目标，执行如下Maven命令</span><br><span class="line">mvn clean install -Ddockerfile.skip</span><br><span class="line"># 想跳过某一个goal</span><br><span class="line">mvn clean package -Ddockerfile.build.skip</span><br><span class="line">mvn clean package -Ddockerfile.tag.skip</span><br><span class="line">mvn clean deploy -Ddockerfile.push.skip</span><br><span class="line"> </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Docker-部署springboot项目&quot;&gt;&lt;a href=&quot;#Docker-部署springboot项目&quot; class=&quot;headerlink&quot; title=&quot;Docker 部署springboot项目&quot;&gt;&lt;/a&gt;Docker 部署springboot项目&lt;/</summary>
      
    
    
    
    <category term="运维" scheme="https://yangh124.github.io/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="Docker" scheme="https://yangh124.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>InnoDB数据存储结构</title>
    <link href="https://yangh124.github.io/2022/01/15/InnoDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/"/>
    <id>https://yangh124.github.io/2022/01/15/InnoDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/</id>
    <published>2022-01-14T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.119Z</updated>
    
    <content type="html"><![CDATA[<h2 id="数据库的存储结构：页"><a href="#数据库的存储结构：页" class="headerlink" title="数据库的存储结构：页"></a>数据库的存储结构：页</h2><p>MySQL服务器上的存储引擎负责对表中的数据的读取和写入工作，不同存储引擎中存放的格式一般不同。此处只剖析InnoDB存储引擎的数据存储结构。</p><h3 id="磁盘与内存交互的基本单位：页"><a href="#磁盘与内存交互的基本单位：页" class="headerlink" title="磁盘与内存交互的基本单位：页"></a>磁盘与内存交互的基本单位：页</h3><p>InnoDB将数据划分为若干个页，InnoDB中页的大小默认为<strong>16KB</strong>。</p><p><strong>在数据库中，不论读一行，还是读多行，都是将这些行所在的页进行加载，也就是说，数据库管理存储空间的基本单位是页（Page），数据库I&#x2F;O操作的最小单位为页。</strong></p><h3 id="页结构概述"><a href="#页结构概述" class="headerlink" title="页结构概述"></a>页结构概述</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/15/16422446514180.jpg" alt="页结构"><br>页a、页b、页c…页n，这些页可以<strong>不在物理结构上相连</strong>，只要通过<strong>双向链表</strong>相关联即可。每个数据页中的记录会按照主键值从小到大的顺序组成一个<strong>单向链表</strong>，每个数据页都会为存储在它里面的记录生成一个<strong>页目录</strong>，在通过主键查找时就可以在页目录中<strong>使用二分法</strong>快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定记录。</p><h3 id="页的上层结构"><a href="#页的上层结构" class="headerlink" title="页的上层结构"></a>页的上层结构</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/15/16422451759284.jpg" alt="页的上层结构"></p><ul><li>区（Extent）是比页大一级的存储结构，在InnoDB存储引擎中，一个区会分配64个连续的页。因为InnoDB中页的默认大小是16KB，所以一个区的大小是 64 * 16KB &#x3D; 1M。</li><li>段（Segment）由一个或多个区组成，区在文件系统是一个连续分配的空间（在InnoDB中是连续的64个页），不过在段中不要求区与区之间是相邻的。<strong>段是数据库中的分配单位，不同类型的数据库对象以不同的段形式存在</strong>。当我们创建数据表、索引的时候，就会相应创建对应的段，比如创建一张表时会创建一个表段，创建一个索引时会创建一个索引段。</li><li>表空间（TableSpace）是一个逻辑容器，表空间存储的对象是段，在一个表空间中可以有一个或多个段，但是一个段只能属于一个表空间。数据库由一个或多个表空间组成。表空间从管理上可以分为<strong>系统表空间、用户表空间、撤销表空间、临时表空间</strong>等。</li></ul><h2 id="页的内部结构"><a href="#页的内部结构" class="headerlink" title="页的内部结构"></a>页的内部结构</h2><p>页如果按类来划分的话，常见的有数据页（保存B+树节点）、系统页、Undo页和事务数据页等。数据页是我们最常使用的页。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/16/16423369880923.jpg" alt="页的内部结构"><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/16/16423371212785.jpg" alt="页的内部结构"></p><h2 id="InnoDB行格式（或记录格式）"><a href="#InnoDB行格式（或记录格式）" class="headerlink" title="InnoDB行格式（或记录格式）"></a>InnoDB行格式（或记录格式）</h2><h3 id="COMPACT行格式"><a href="#COMPACT行格式" class="headerlink" title="COMPACT行格式"></a>COMPACT行格式</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/19/16425967631225.jpg" alt="16425967631225"></p><h4 id="变长字段长度列表"><a href="#变长字段长度列表" class="headerlink" title="变长字段长度列表"></a>变长字段长度列表</h4><p>MySQL支持一些变长的数据类型，比如VARCHAR(M)、VARBINARY(M)、TEXT类型，BOLB类型，这些数据类型修饰列称为变长字段。<br><strong>注意：</strong> 这里面存储的变长长度和字段顺序是<strong>反过来</strong>的。比如在表中字段是a(10),b(15)，那么在变长字段列表中存储的长度顺序就是15，10。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/19/16425971738917.jpg" alt="16425971738917"></p><h4 id="NULL值列表"><a href="#NULL值列表" class="headerlink" title="NULL值列表"></a>NULL值列表</h4><ol><li>二进制位的值为1时，代表该列的值为NULL。</li><li>二进制位的值为0时，代表该列的值不为NULL。</li><li>NOT NULL的字段没有。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/19/16425973039144.jpg" alt="16425973039144"></li></ol><h4 id="记录头信息（5字节）"><a href="#记录头信息（5字节）" class="headerlink" title="记录头信息（5字节）"></a>记录头信息（5字节）</h4><h4 id="记录真实数据"><a href="#记录真实数据" class="headerlink" title="记录真实数据"></a>记录真实数据</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/19/16425974458867.jpg" alt="16425974458867"></p><h3 id="Dynamic和Compressed行格式"><a href="#Dynamic和Compressed行格式" class="headerlink" title="Dynamic和Compressed行格式"></a>Dynamic和Compressed行格式</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/19/16425990444803.jpg" alt="16425990444803"><br>一个页的大小一般是16KB，也就是16384字节，而VARCHAR(M)最多可储存65533个字节。这样就出现了一个页存放不了一条记录，这种现象称为行溢出。<br>Dynamic和Compressed行格式和Compact行格式挺像，只不过在处理行溢出数据时有分歧：</p><ul><li>Dynamic和Compressed两种行格式对于存放在BLOB中的数据采用了完全的行溢出方式，如图，在数据页中只存放20个字节的指针（溢出页的地址），实际的数据都存放在Off Page（溢出页）中。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/02/10/16445002427093.jpg" alt="16445002427093"></li><li>Compact和Redundant两种格式会在记录的真实数据处存储一部分数据（存放768个前缀字节）。<br><strong>Compressed行记录格式的另一个功能就是，存储在其中的行数据会以zlib的算法进行非常压缩。因此对于BLOL，TEXT，VARCHAR这类大长度类型的数据能够进行非常有效的存储。</strong></li></ul><h3 id="Redundant行格式"><a href="#Redundant行格式" class="headerlink" title="Redundant行格式"></a>Redundant行格式</h3><p>Redundant行格式是MySQL5.0版本及之前InnoDB的行记录存储方式。</p><h2 id="区、段与碎片区"><a href="#区、段与碎片区" class="headerlink" title="区、段与碎片区"></a>区、段与碎片区</h2><h3 id="为什么要有区？"><a href="#为什么要有区？" class="headerlink" title="为什么要有区？"></a>为什么要有区？</h3><p><code>B+</code>树的每一层中的页都会形成一个双向链表如果<strong>以页为单位</strong>来分配存储空间的话，双向链表相邻的两个页之间的<strong>物理位置可能离的非常远</strong>。 扫描页就会是<strong>随机IO</strong>。随机IO是非常慢的，所以我们应该尽量的让链表中页的<strong>物理位置也相邻</strong>，这样进行范围查询的时候时候才可以使用所谓的<strong>顺序IO</strong>。<br>一个区就是在物理位置上连续的<strong>64个页</strong>。因为InnoDB中的页大小。默认是<strong>16kb</strong>，所以一个区的大小是<strong>64*16&#x3D;1M</strong>。在表中数据量大的时候，为某个索引分配空间的时候就不再按照页为单位分配了，而是按照<strong>区为单位分配</strong>，甚至在表中数据特别多的时候，可以一次性分配多个连续的区。虽然可能造成<strong>一点点空间的浪费</strong>（数据不足以填满整个区），但是从性能角度看，可以消除很多随机IO，<strong>利大于弊</strong>。</p><h3 id="为什么要有段？"><a href="#为什么要有段？" class="headerlink" title="为什么要有段？"></a>为什么要有段？</h3><p>对于范围查询，其实是对B+树叶子节点的记录进行顺序扫描，而如果不区分叶子节点和非叶子节点，统统把节点代表的页面放到申请到的区中的话，进行范围扫描的效果就可能会比较差。所以InnoDB对B+树的<strong>叶子节点</strong>和<strong>非叶子节点</strong>进行区别对待，也就是说叶子节点有自己独有的区，非叶子节点也有自己独特的区。存放叶子节点的区的集合就是一个<strong>段（segment）</strong>，存放非叶子节点的区的集合也是一个段。也就是说一个索引会生成2个段，一个<strong>叶子节点段</strong>，一个<strong>非叶子节点段</strong>。</p><p>除了索引的叶子节点段和非叶子节点段之外，InnoDB中还有为储存一些特殊的数据定义的段，比如回滚段。所以常见的段有<strong>数据段</strong>，<strong>索引段</strong>，<strong>回滚段</strong>。数据段即为B+树的叶子节点，索引段即为非叶子节点段。</p><p>段其实不对应表空间中某一个连续的物理区域，而是一个逻辑上的概念，由若干个零散的页面以及一些完整的区组成。</p><h3 id="为什么要有碎片区？"><a href="#为什么要有碎片区？" class="headerlink" title="为什么要有碎片区？"></a>为什么要有碎片区？</h3><p>一个区默认占用1M（64*16K）存储空间，所以默认情况下一个只存了几条记录的小表也需要2M存储空间吗？</p><p>为了考虑以完整的区为单位分配给某个段，对于<strong>数量较小的</strong>表太浪费存储空间的这种情况，InnoDB提出了一个<strong>碎片区（fragment）</strong> 的概念。在一个碎片区中，并不是所有的页都是为了存储同一个段的数据而存在的，而是碎片区中的页可以用于不同的目的，比如有些页用于段A，有些页用于段B，有些页用于段C，有些页甚至哪个段都不属于。<strong>碎片区直属于表空间</strong>，并不属于任何一个段。</p><p>所以此后为某个段分配存储空间的策略是这样的：</p><ul><li>在刚开始向表中插入数据的时候，段是从某个碎片区以单个页面为单位来分配存储空间的。</li><li>当某个段已经占用了<strong>32个碎片</strong>区页面之后，就会申请以完整的区为单位来分配存储空间的。</li></ul><h3 id="区的分类"><a href="#区的分类" class="headerlink" title="区的分类"></a>区的分类</h3><ul><li>空闲的区（free）：现在还没有用到这个区中的任何页面。</li><li>有剩余空间的碎片区（free_frag）：表示碎片区中还有可用页面。</li><li>没有剩余空间的碎片区（full_frag）：表示碎片区的所有页面都被使用，没有空闲的页面。</li><li>附属于某个段的区（fseg）：每一个索引都可以分为叶子节点段和非叶子节点段。<br>处于free、free_frag、full_frag都是碎片区，fseg为属于某个段的区。</li></ul><h2 id="表空间"><a href="#表空间" class="headerlink" title="表空间"></a>表空间</h2><p>表空间可以看作是InnoDB存储引擎逻辑结构的最高层，所有的数据都存放在表空间中。</p><p>表空间是一个<strong>逻辑容器</strong>，表空间存储的对象是段，在一个表空间中可以有一个或多个段，但是一个段只能属于一个表空间。数据库由一个或多个表空间组成，表空间从管理上可以划分为<strong>系统表空间</strong>（system Tablespace），<strong>独立表空间</strong>（File-per-table Tablespace）、<strong>撤销表空间</strong>（Undo-tablesapce）和<strong>临时表空间</strong>（Temporary Tablespace）等。</p><h3 id="独立表空间"><a href="#独立表空间" class="headerlink" title="独立表空间"></a>独立表空间</h3><h4 id="独立表空间结构"><a href="#独立表空间结构" class="headerlink" title="独立表空间结构"></a>独立表空间结构</h4><p>独立表空间由段、区、页组成。</p><h4 id="表空间对应的文件"><a href="#表空间对应的文件" class="headerlink" title="表空间对应的文件"></a>表空间对应的文件</h4><p>一个新建的表对应的 <strong>.idb</strong> 文件文件只占用了<strong>96k</strong>，才6个页面的大小（MySQL5.7），这是因为一开始表中没有数据。随着表中的数据增加，表空间对应的文件也逐渐增大。</p><h3 id="系统表空间"><a href="#系统表空间" class="headerlink" title="系统表空间"></a>系统表空间</h3><p>系统表空间和独立表空间基本类似，只不过MySQL只有一个系统表空间，在系统表空间中会额外记录一些有关整个系统信息的页面，这部分是独立表空间没有的。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/02/13/16447536181188.jpg" alt="16447536181188"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;数据库的存储结构：页&quot;&gt;&lt;a href=&quot;#数据库的存储结构：页&quot; class=&quot;headerlink&quot; title=&quot;数据库的存储结构：页&quot;&gt;&lt;/a&gt;数据库的存储结构：页&lt;/h2&gt;&lt;p&gt;MySQL服务器上的存储引擎负责对表中的数据的读取和写入工作，不同存储引擎中</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="MySQL" scheme="https://yangh124.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>索引的创建与设计原则</title>
    <link href="https://yangh124.github.io/2022/01/15/%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"/>
    <id>https://yangh124.github.io/2022/01/15/%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%9B%E5%BB%BA%E4%B8%8E%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/</id>
    <published>2022-01-14T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.127Z</updated>
    
    <content type="html"><![CDATA[<h2 id="索引的声明与使用"><a href="#索引的声明与使用" class="headerlink" title="索引的声明与使用"></a>索引的声明与使用</h2><h3 id="索引的分类"><a href="#索引的分类" class="headerlink" title="索引的分类"></a>索引的分类</h3><ul><li>从<strong>功能逻辑</strong>上说，索引主要有四种，分别为普通索引、唯一索引、主键索引、全文索引。</li><li>按照<strong>物理实现方式</strong>，索引可以分为两种：聚簇索引和非聚簇索引。</li><li>按照<strong>作用字段个数</strong>进行划分，分成单列索引和联合索引。</li></ul><h2 id="MySQL8-0索引新特性"><a href="#MySQL8-0索引新特性" class="headerlink" title="MySQL8.0索引新特性"></a>MySQL8.0索引新特性</h2><h3 id="支持降序索引"><a href="#支持降序索引" class="headerlink" title="支持降序索引"></a>支持降序索引</h3><p>降序索引以降序存储键值。虽然在语法上，从MySQL4版本开始就支持降序索引语法了。但实际上该DESC定义是被忽略的，直到MySQL8才开始真正支持降序索引（仅限于InnoDB存储引擎）。<br>MySQL在8.0之前创建仍然是升序索引，使用时进行反向扫描，这大大降低了数据库的效率。<br><code> CREATE TABLE ts1(a int,b int,index idx_a_b(a ASC,b DESC))</code></p><h3 id="隐藏索引"><a href="#隐藏索引" class="headerlink" title="隐藏索引"></a>隐藏索引</h3><p><code> ALTER TABLE tablename ALTER INDEX index_name INVISIBLE; #隐藏索引</code><br><code> ALTER TABLE tablename ALTER INDEX index_name VISIBLE; #显示索引</code><br><strong>隐藏显示索引可用与查看使用索引的效率提升</strong></p><h2 id="索引的设计原则"><a href="#索引的设计原则" class="headerlink" title="索引的设计原则"></a>索引的设计原则</h2><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><p>创建表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 课程表</span><br><span class="line">CREATE TABLE `course` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `course_id` int NOT NULL,</span><br><span class="line">  `course_name` varchar(50) COLLATE utf8mb4_unicode_ci DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=101 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;</span><br><span class="line"></span><br><span class="line"># 学生表</span><br><span class="line">CREATE TABLE `student_info` (</span><br><span class="line">  `id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `student_id` int NOT NULL,</span><br><span class="line">  `name` varchar(50) COLLATE utf8mb4_unicode_ci DEFAULT NULL,</span><br><span class="line">  `course_id` int NOT NULL,</span><br><span class="line">  `class_id` int DEFAULT NULL,</span><br><span class="line">  `create_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1000001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>生成随机数函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 生成随机数函数</span><br><span class="line">CREATE DEFINER=`root`@`%` FUNCTION `rand_num`( from_num INT,to_num INT) RETURNS int</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE</span><br><span class="line">i INT DEFAULT 0;</span><br><span class="line">SET i = FLOOR(from_num+RAND()*(to_num-from_num +1));</span><br><span class="line">RETURN i;</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>生成随机字符串函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">## 生成随机字符串</span><br><span class="line">CREATE DEFINER=`root`@`%` FUNCTION `rand_string`(n INT) RETURNS varchar(255) CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE chars_str varchar(100) DEFAULT &#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;;</span><br><span class="line">    DECLARE return_str varchar(255) DEFAULT &#x27;&#x27;;</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    WHILE i &lt; n DO</span><br><span class="line">        SET return_str = concat(return_str,substring(chars_str , FLOOR(1 + RAND()*62 ),1));</span><br><span class="line">        SET i = i +1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    RETURN return_str;</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>生成课程表数据储存过程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 生成课程表数据储存过程</span><br><span class="line">CREATE DEFINER=`root`@`%` PROCEDURE `insert_course`( max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE</span><br><span class="line">i INT DEFAULT 0;</span><br><span class="line"></span><br><span class="line">SET autocommit = 0;</span><br><span class="line">REPEAT</span><br><span class="line"></span><br><span class="line">SET i = i + 1;</span><br><span class="line">INSERT INTO course ( course_id, course_name )</span><br><span class="line">VALUES</span><br><span class="line">(</span><br><span class="line">rand_num ( 10000, 10100 ),</span><br><span class="line">rand_string ( 6 ));</span><br><span class="line">UNTIL i = max_num </span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>生成学生表数据存储过程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 生成学生表存储过程</span><br><span class="line">CREATE DEFINER=`root`@`%` PROCEDURE `insert_stu`( max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE</span><br><span class="line">i INT DEFAULT 0;</span><br><span class="line"></span><br><span class="line">SET autocommit = 0;</span><br><span class="line">REPEAT</span><br><span class="line"></span><br><span class="line">SET i = i + 1;</span><br><span class="line">INSERT INTO student_info ( course_id, class_id,student_id,name ) VALUES(</span><br><span class="line">rand_num(10000,10100),rand_num(10000,10200),rand_num(10000,20000),rand_string(6)</span><br><span class="line">);</span><br><span class="line">UNTIL i = max_num </span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>调用存储过程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_stu(1000000);</span><br><span class="line">CALL insert_course(100);</span><br></pre></td></tr></table></figure><h3 id="哪些情况适合创建索引"><a href="#哪些情况适合创建索引" class="headerlink" title="哪些情况适合创建索引"></a>哪些情况适合创建索引</h3><ol><li>字段的数值有唯一性限制：<blockquote><p>业务上具有唯一特性的字段，即使是组合字段，也必须创建组合索引（来源：Alibaba）</p></blockquote></li><li>频繁作为where查询条件的字段</li><li>经常 group by 和 order by 的字段</li><li>update、delete的where条件</li><li>distinct字段需要创建索引</li><li>多表join连接操作时，创建索引的注意事项<blockquote><p>连接表尽量不超过3张；对where条件创建索引，并且该字段在多张表中的类型必须一致（隐式转换（使用了函数，索引失效））；</p></blockquote></li><li>使用列的类型小的创建索引</li><li>使用字符串前缀创建索引</li><li>区分度高（散列性高）的列适合创建索引</li><li>使用最频繁的列放到联合索引的左侧</li><li>在多个列都要创建索引时，联合索引优于单值索引</li></ol><h3 id="哪些情况不适合创建索引"><a href="#哪些情况不适合创建索引" class="headerlink" title="哪些情况不适合创建索引"></a>哪些情况不适合创建索引</h3><ol><li>在where中使用不到的字段不要创建索引</li><li>数据量小的表最好不要创建索引</li><li>有大量重复数据的列不要建立索引</li><li>避免对经常更新的表创建过多的索引</li><li>不建议用无序的值作为索引</li><li>删除不再使用的或者很少使用的索引</li><li>不要定义冗余或重复的索引</li></ol><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>索引是一把双刃剑，可以提高查询效率，但是也会降低插入和更新的速度并占用磁盘空间。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;索引的声明与使用&quot;&gt;&lt;a href=&quot;#索引的声明与使用&quot; class=&quot;headerlink&quot; title=&quot;索引的声明与使用&quot;&gt;&lt;/a&gt;索引的声明与使用&lt;/h2&gt;&lt;h3 id=&quot;索引的分类&quot;&gt;&lt;a href=&quot;#索引的分类&quot; class=&quot;headerlink</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="MySQL" scheme="https://yangh124.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>InnoDB中的索引</title>
    <link href="https://yangh124.github.io/2022/01/12/InnoDB%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95/"/>
    <id>https://yangh124.github.io/2022/01/12/InnoDB%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95/</id>
    <published>2022-01-11T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.119Z</updated>
    
    <content type="html"><![CDATA[<h2 id="InnoDB中的索引设计方案"><a href="#InnoDB中的索引设计方案" class="headerlink" title="InnoDB中的索引设计方案"></a>InnoDB中的索引设计方案</h2><ul><li>0:普通的用户记录</li><li>1:目录项记录</li><li>2:最小记录</li><li>3:最大记录<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/12/16419950340539.jpg" alt="聚簇索引"><br><strong>一般情况下，我们用到的B+树都不会超过4层。（减少磁盘I&#x2F;O）</strong><br>一个B+树的节点其实可以分成好多层，规定最下边的那层，也就是存放用户记录的那层为第0层，之后依次往上加。一个数据页可以存放16k的数据。假设所有存放用户记录的叶子节点代表的数据页可以存放100条用户记录，所有存放目录项记录的内节点代表的数据页可以存放1000条数据，那么：</li><li>如果B+树只有1层，也就是只有一个用于存放记录的节点，最多能存放100条记录。</li><li>如果B+树有2层，最多能存放1000 * 100 &#x3D; 10万条记录。</li><li>如果B+树有3层，最多能存放1000 * 1000 * 100 &#x3D; 1亿条记录</li><li>如果b+树有4层，做多能存放1000 * 1000 * 1000 * 100 &#x3D; 1000亿条记录</li></ul><h2 id="常见索引概念"><a href="#常见索引概念" class="headerlink" title="常见索引概念"></a>常见索引概念</h2><h3 id="聚簇索引"><a href="#聚簇索引" class="headerlink" title="聚簇索引"></a>聚簇索引</h3><h3 id="二级索引（辅助索引、非聚簇索引）"><a href="#二级索引（辅助索引、非聚簇索引）" class="headerlink" title="二级索引（辅助索引、非聚簇索引）"></a>二级索引（辅助索引、非聚簇索引）</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/12/16419967282458.jpg" alt="非聚簇索引"></p><h4 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/12/16419972009034.jpg" alt="联合索引"></p><h3 id="InnoDB的B-树索引的注意事项"><a href="#InnoDB的B-树索引的注意事项" class="headerlink" title="InnoDB的B+树索引的注意事项"></a>InnoDB的B+树索引的注意事项</h3><h4 id="根页面位置万年不变"><a href="#根页面位置万年不变" class="headerlink" title="根页面位置万年不变"></a>根页面位置万年不变</h4><ul><li>每当某个表创建一个B+树索引（聚簇索引）的时候，都会为这个索引创建一个根节点页，最开始表中没有数据的时候，每个B+树索引对应的根节点中，既没有用户记录，也没有目录项记录。</li><li>随后向表中插入用户记录时，先把用户记录存储到这个根节点中。</li><li>当根节点中的可用空间用完时，继续插入记录，此时会将根节点中的所有记录复制到新分配的页，比如页a中，然后后对这个新页进行页分裂的操作，得到另一个新页，比如页b，这时新插入的记录根据键值（也就是索引值）的大小就会被分配到页a或者页b中，而根节点便升级为存储目录项记录的页<br><strong>这个过程特别注意的是：</strong> 一个B+树索引的根节点自诞生之日起，便不会再移动。这样只要我们对某个表建立一个索引，那么它的根节点的页号便会被记录到某个地方，然后凡事InnoDB存储引擎需要用到这个索引的时候，都会从哪个固定的地方取出根节点的页，从而来访问这个索引。</li></ul><h3 id="非叶子节点中的目录项记录的唯一性"><a href="#非叶子节点中的目录项记录的唯一性" class="headerlink" title="非叶子节点中的目录项记录的唯一性"></a>非叶子节点中的目录项记录的唯一性</h3><p>即非叶子节点的索引唯一（创建的索引默认后面会跟主键）</p><h3 id="一个数据页最少存储2条数据"><a href="#一个数据页最少存储2条数据" class="headerlink" title="一个数据页最少存储2条数据"></a>一个数据页最少存储2条数据</h3><h3 id="MySQL数据结构选择的合理性"><a href="#MySQL数据结构选择的合理性" class="headerlink" title="MySQL数据结构选择的合理性"></a>MySQL数据结构选择的合理性</h3><h4 id="Hash结构"><a href="#Hash结构" class="headerlink" title="Hash结构"></a>Hash结构</h4><pre><code>1. Hash索引仅能满足（=）（&lt;&gt;）和in查询。范围查询效率很差。2. Hash索引数据存储是没有顺序的。3. 对于联合索引的情况，Hash值是将联合索引合并后一起来计算的，无法对单独的一个键或者几个索引键进行查询。4. 对于等值查询来说，通常Hash索引的效率很高，不过存在一种情况，就是索引列的重复值很多，效率就会降低。</code></pre><p>另外，InnoDB本身不支持Hash索引，但是提供了自适应hash索引（adaptive_hash_index）。如果某个数据经常被访问，当满足一定条件的时候，就会将这个数据页的地址存放到Hash表中。这样下次查询的时候，就可以直接找到这个页面的所在位置。这样让B+树也具备了Hash索引的优点。</p><h4 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h4><p>二叉树特征：<br>    * 一个节点只能有两个子节点，也就是一个节点度不能超过2<br>    * 左子节点 &lt; 本节点 &lt;&#x3D; 右子节点<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/13/16420811937219.jpg" alt="二叉搜索树"><br> <strong>在极端情况下会变成一个线性链表</strong></p><h4 id="AVL树"><a href="#AVL树" class="headerlink" title="AVL树"></a>AVL树</h4><p> 平衡二叉树特征：<br>    <strong>它是一棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树。</strong><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/13/16420812487954.jpg" alt="AVL树"><br><strong>树的层数过多，访问一个节点相当于做一次磁盘IO</strong></p><h4 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B-Tree"></a>B-Tree</h4><p>Balance Tree，也就是多路平衡查找树。</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/01/13/16420815935861.jpg" alt="16420815935861"></p><ol><li>B树在插入和删除节点的时候如果导致树不平衡，就通过自动调节节点的位置保持树的自平衡。</li><li>关键字集合分布在整棵树中，即叶子节点和非叶子节点都存放数据。搜索有可能在非叶子节点结束</li><li>其搜索性能等价于在关键字全集内做一次二分查找。</li></ol><h4 id="B-Tree-1"><a href="#B-Tree-1" class="headerlink" title="B+Tree"></a>B+Tree</h4><p>B+树也是一种多路搜索树，基于B-Tree做了改进。B+树适合文件索引系统。<br><strong>B+树和B树的差异：</strong></p><ol><li>有k个子节点就有k个关键字。也就是子节点数量&#x3D;关键字数量。而B树中，子节点数量&#x3D;关键字数量+1。</li><li>非叶子节点的关键字会同时存在在子节点中，并且是在子节点中所有关键字的最大（或最小）。</li><li>非叶子节点仅用于索引，不保存数据记录，跟记录相关的信息都存放在叶子节点中。而B树中，非叶子节点即保存索引也保存数据记录。</li><li>所有关键字都在叶子节点出现，叶子节点构成一个有序链表，而且叶子节点本身按照关键字的大小从小到大顺序链接。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;InnoDB中的索引设计方案&quot;&gt;&lt;a href=&quot;#InnoDB中的索引设计方案&quot; class=&quot;headerlink&quot; title=&quot;InnoDB中的索引设计方案&quot;&gt;&lt;/a&gt;InnoDB中的索引设计方案&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;0:普通的用户记录&lt;/li&gt;
&lt;</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="MySQL" scheme="https://yangh124.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Shell脚本</title>
    <link href="https://yangh124.github.io/2021/12/04/Shell%E8%84%9A%E6%9C%AC/"/>
    <id>https://yangh124.github.io/2021/12/04/Shell%E8%84%9A%E6%9C%AC/</id>
    <published>2021-12-03T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.124Z</updated>
    
    <content type="html"><![CDATA[<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><p>第一个Shell脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!bin/bash</span><br><span class="line">echo &quot;Hello World!&quot;</span><br></pre></td></tr></table></figure><p>输出结果:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello World!</span><br></pre></td></tr></table></figure><h2 id="Shell变量"><a href="#Shell变量" class="headerlink" title="Shell变量"></a>Shell变量</h2><ol><li>定义变量时，变量名不加美元符号：<code>your_name=&quot;yanghap&quot;</code></li><li>变量名和等号之间不能有空格，同时，变量名的命名须遵循如下规则：<ol><li>命名只能使用英文字母，数字和下划线，首个字符不能以数字开头。</li><li>中间不能有空格，可以使用下划线 _。</li><li>不能使用标点符号。</li><li>不能使用bash里的关键字（可用help命令查看保留关键字）。</li></ol></li></ol><h2 id="Shell传递参数"><a href="#Shell传递参数" class="headerlink" title="Shell传递参数"></a>Shell传递参数</h2><p>我们可以在Shell脚本中传递参数，脚本传递参数的格式为：<code>$n</code>（n为一个数字）,1为第一个参数，2为第二个参数…<br><strong>$0代表执行时文件的文件路径</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!bin/bash</span><br><span class="line">echo &quot;执行的文件名：$0&quot;;</span><br><span class="line">echo &quot;第一个参数为：$1&quot;;</span><br><span class="line">echo &quot;第二个参数为：$2&quot;;</span><br><span class="line">echo &quot;第三个参数为：$3&quot;;</span><br></pre></td></tr></table></figure><p><code>sh /Users/yh/Downloads/test.sh 1 2 3</code><br>输出结果:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">执行的文件名：/Users/yh/Downloads/test.sh</span><br><span class="line">第一个参数为：1</span><br><span class="line">第二个参数为：2</span><br><span class="line">第三个参数为：3</span><br></pre></td></tr></table></figure><h3 id="几个特殊的参数处理"><a href="#几个特殊的参数处理" class="headerlink" title="几个特殊的参数处理"></a>几个特殊的参数处理</h3><ul><li><code>$#</code> 传递到脚本的参数个数</li><li><code>$*</code> 以一个单字符串显示所有向脚本传递的参数。如”$*”用「”」括起来的情况、以”$1 $2 … $n”的形式输出所有参数。</li><li><code>$$</code> 脚本运行的当前进程ID号</li><li><code>$!</code> 后台运行的最后一个进程的ID号</li><li><code>$@</code> 与<code>$*</code>相同，但是使用时加引号，并在引号中返回每个参数。如”<code>$@</code>“用「”」括起来的情况、以”<code>$1</code>“ “<code>$2</code>“ … “<code>$n</code>“ 的形式输出所有参数。</li><li><code>$-</code> 显示Shell使用的当前选项，与set命令功能相同。</li><li><code>$?</code> 显示最后命令的退出状态。0表示没有错误，其他任何值表明有错误。</li></ul><h2 id="Shell数组"><a href="#Shell数组" class="headerlink" title="Shell数组"></a>Shell数组</h2><ol><li>Shell数组用括号来表示，元素用空格分隔开<br><code>array_name=(value1 value2 ... valuen)</code></li><li>读取数组：<code>$&#123;array_name[index]&#125;</code><br>实例:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">my_array=(A B &quot;C&quot; D)</span><br><span class="line"></span><br><span class="line">echo &quot;第一个元素为: $&#123;my_array[0]&#125;&quot;</span><br><span class="line">echo &quot;第二个元素为: $&#123;my_array[1]&#125;&quot;</span><br><span class="line">echo &quot;第三个元素为: $&#123;my_array[2]&#125;&quot;</span><br><span class="line">echo &quot;第四个元素为: $&#123;my_array[3]&#125;&quot;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Shell运算符"><a href="#Shell运算符" class="headerlink" title="Shell运算符"></a>Shell运算符</h2><h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><p>+、-、*、&#x2F;、%、&#x3D;（赋值）、&#x3D;&#x3D;（相等）、!&#x3D;(不相等)<br><strong>注意</strong>：<strong>条件表达式</strong>要放在方括号内，并且要有空格，例如: <code>[$a==$b]</code> 是错误的，必须写成 <code>[ $a == $b ]</code>。</p><h3 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h3><p>关系运算符只支持数字，不支持字符串，除非字符串的值是数字。</p><ul><li><code>-eq</code>：检测两个数是否相等，相等返回 true。</li><li><code>-ne</code>：!&#x3D;</li><li><code>-gt</code>：&gt;</li><li><code>-lt</code>：&lt;</li><li><code>-ge</code>：&gt;&#x3D;</li><li><code>-le</code>：&lt;&#x3D;</li></ul><h3 id="布尔运算符"><a href="#布尔运算符" class="headerlink" title="布尔运算符"></a>布尔运算符</h3><ul><li><code>!</code>：非运算，表达式为 true 则返回 false，否则返回 true。</li><li><code>-o</code>：或运算，有一个表达式为 true 则返回 true。（or）</li><li><code>-a</code>：与运算，两个表达式都为 true 才返回 true。（and）</li></ul><h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h3><ul><li><code>&amp;&amp;</code>：逻辑的 AND</li><li><code>||</code>：逻辑的 OR</li></ul><h3 id="字符串运算符"><a href="#字符串运算符" class="headerlink" title="字符串运算符"></a>字符串运算符</h3><ul><li><code>=</code>：检测两个字符串是否相等，相等返回 true。</li><li><code>!=</code>：检测两个字符串是否不相等，不相等返回 true。</li><li><code>-z</code>：检测字符串长度是否为0，为0返回 true。</li><li><code>-n</code>：检测字符串长度是否不为 0，不为 0 返回 true。</li><li><code>$</code>：检测字符串是否不为空，不为空返回 true。</li></ul><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><a href="https://www.runoob.com/linux/linux-shell-basic-operators.html">文件测试运算符</a></p><h2 id="Shell-echo命令"><a href="#Shell-echo命令" class="headerlink" title="Shell echo命令"></a>Shell echo命令</h2><h3 id="显示普通字符串"><a href="#显示普通字符串" class="headerlink" title="显示普通字符串"></a>显示普通字符串</h3><p><code>echo &quot;It is a test&quot;</code></p><h3 id="显示转义字符"><a href="#显示转义字符" class="headerlink" title="显示转义字符"></a>显示转义字符</h3><p><code>echo &quot;\&quot;It is a test\&quot;&quot;</code><br>结果:<br><code>&quot;It is a test&quot;</code></p><h3 id="显示变量"><a href="#显示变量" class="headerlink" title="显示变量"></a>显示变量</h3><p><code>echo &quot;$1&quot;</code></p><h3 id="显示换行"><a href="#显示换行" class="headerlink" title="显示换行"></a>显示换行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;OK! \n&quot; # -e 开启转义</span><br><span class="line">echo &quot;It is a test&quot;</span><br></pre></td></tr></table></figure><p>结果:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OK!</span><br><span class="line"></span><br><span class="line">It is a test</span><br></pre></td></tr></table></figure><h3 id="显示不换行"><a href="#显示不换行" class="headerlink" title="显示不换行"></a>显示不换行</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo -e &quot;OK! \c&quot; # -e 开启转义 \c 不换行</span><br><span class="line">echo &quot;It is a test&quot;</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OK! It is a test</span><br></pre></td></tr></table></figure><h3 id="显示结果定向至文件"><a href="#显示结果定向至文件" class="headerlink" title="显示结果定向至文件"></a>显示结果定向至文件</h3><p><code>echo &quot;It is a test&quot; &gt; myfile</code></p><h3 id="原样输出字符串，不进行转义或取变量-用单引号"><a href="#原样输出字符串，不进行转义或取变量-用单引号" class="headerlink" title="原样输出字符串，不进行转义或取变量(用单引号)"></a>原样输出字符串，不进行转义或取变量(用单引号)</h3><p><code>echo &#39;$name\&quot;&#39;</code><br>结果:<code>$name\&quot;</code></p><h3 id="显示命令执行结果，使用反引号"><a href="#显示命令执行结果，使用反引号" class="headerlink" title="显示命令执行结果，使用反引号"></a>显示命令执行结果，使用反引号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo `date`</span><br></pre></td></tr></table></figure><h2 id="Shell-printf命令"><a href="#Shell-printf命令" class="headerlink" title="Shell printf命令"></a>Shell printf命令</h2><h2 id="Shell-test命令"><a href="#Shell-test命令" class="headerlink" title="Shell test命令"></a>Shell test命令</h2><p>Shell中的 test 命令用于检查某个条件是否成立，它可以进行数值、字符和文件三个方面的测试。</p><h3 id="数值测试"><a href="#数值测试" class="headerlink" title="数值测试"></a>数值测试</h3><p>实例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">num1=100</span><br><span class="line">num2=100</span><br><span class="line">if test $[num1] -eq $[num2]</span><br><span class="line">then</span><br><span class="line">    echo &#x27;两个数相等！&#x27;</span><br><span class="line">else</span><br><span class="line">    echo &#x27;两个数不相等！&#x27;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="字符串测试"><a href="#字符串测试" class="headerlink" title="字符串测试"></a>字符串测试</h3><h3 id="文件测试"><a href="#文件测试" class="headerlink" title="文件测试"></a>文件测试</h3><h2 id="Shell流程控制"><a href="#Shell流程控制" class="headerlink" title="Shell流程控制"></a>Shell流程控制</h2><h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if condition</span><br><span class="line">then</span><br><span class="line">    command1 </span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN </span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="if-else"><a href="#if-else" class="headerlink" title="if else"></a>if else</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if condition</span><br><span class="line">then</span><br><span class="line">    command1 </span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line">else</span><br><span class="line">    command</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="if-else-if-else"><a href="#if-else-if-else" class="headerlink" title="if else-if else"></a>if else-if else</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if condition1</span><br><span class="line">then</span><br><span class="line">    command1</span><br><span class="line">elif condition2 </span><br><span class="line">then </span><br><span class="line">    command2</span><br><span class="line">else</span><br><span class="line">    commandN</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for var in item1 item2 ... itemN</span><br><span class="line">do</span><br><span class="line">    command1</span><br><span class="line">    command2</span><br><span class="line">    ...</span><br><span class="line">    commandN</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>实例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for loop in 1 2 3 4 5</span><br><span class="line">do</span><br><span class="line">    echo &quot;The value is: $loop&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h2 id="Shell输入-输出重定向"><a href="#Shell输入-输出重定向" class="headerlink" title="Shell输入&#x2F;输出重定向"></a>Shell输入&#x2F;输出重定向</h2><ul><li><code>command &gt; file</code>：将输出重定向到 file。</li><li><code>command &lt; file</code>：将输入重定向到 file。</li><li><code>command &gt;&gt; file</code>：将输出以追加的方式重定向到 file。</li><li><code>n &gt; file</code>：将文件描述符为 n 的文件重定向到 file。</li><li><code>n &gt;&gt; file</code>：将文件描述符为 n 的文件以追加的方式重定向到 file。</li><li><code>n &gt;&amp; m</code>：将输出文件 m 和 n 合并。</li><li><code>n &lt;&amp; m</code>：将输入文件 m 和 n 合并。</li><li><code>&lt;&lt; tag</code>：将开始标记 tag 和结束标记 tag 之间的内容作为输入。<br><strong>注意：</strong> 文件描述符 0 通常是标准输入（STDIN），1 是标准输出（STDOUT），2 是标准错误输出（STDERR）。</li></ul><p>如果希望屏蔽STDOUT和STDERR，可以这样写：<br><code>command &gt; /dev/null 2&gt;&amp;1</code><br><strong>注意：</strong> 这里的 2 和 &gt; 之间不可以有空格，2&gt; 是一体的时候才表示错误输出。</p><h2 id="Shell-文件包含"><a href="#Shell-文件包含" class="headerlink" title="Shell 文件包含"></a>Shell 文件包含</h2><p>和其他语言一样，Shell 也可以包含外部脚本。这样可以很方便的封装一些公用的代码作为一个独立的文件。<br>语法格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">. filename   # 注意点号(.)和文件名中间有一空格</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">source filename</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;HelloWorld&quot;&gt;&lt;a href=&quot;#HelloWorld&quot; class=&quot;headerlink&quot; title=&quot;HelloWorld&quot;&gt;&lt;/a&gt;HelloWorld&lt;/h2&gt;&lt;p&gt;第一个Shell脚本&lt;/p&gt;
&lt;figure class=&quot;highligh</summary>
      
    
    
    
    <category term="脚本语言" scheme="https://yangh124.github.io/categories/%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80/"/>
    
    
  </entry>
  
  <entry>
    <title>通过企业微信（微信插件）实现每日天气推送</title>
    <link href="https://yangh124.github.io/2021/11/06/%E9%80%9A%E8%BF%87%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%EF%BC%88%E5%BE%AE%E4%BF%A1%E6%8F%92%E4%BB%B6%EF%BC%89%E5%AE%9E%E7%8E%B0%E6%AF%8F%E6%97%A5%E5%A4%A9%E6%B0%94%E6%8E%A8%E9%80%81/"/>
    <id>https://yangh124.github.io/2021/11/06/%E9%80%9A%E8%BF%87%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%EF%BC%88%E5%BE%AE%E4%BF%A1%E6%8F%92%E4%BB%B6%EF%BC%89%E5%AE%9E%E7%8E%B0%E6%AF%8F%E6%97%A5%E5%A4%A9%E6%B0%94%E6%8E%A8%E9%80%81/</id>
    <published>2021-11-05T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.128Z</updated>
    
    <content type="html"><![CDATA[<h2 id="企业微信配置"><a href="#企业微信配置" class="headerlink" title="企业微信配置"></a>企业微信配置</h2><h3 id="进入企业微信官网，点击立即注册"><a href="#进入企业微信官网，点击立即注册" class="headerlink" title="进入企业微信官网，点击立即注册"></a>进入<a href="https://work.weixin.qq.com/">企业微信官网</a>，点击立即注册</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/06/16361632863091.jpg" alt="16361632863091"><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/06/16361633233327.jpg" alt="16361633233327"></p><h3 id="登录企业微信管理后台，找到应用管理，点击创建自建应用（例如这里我创建了一个名称为天气推送的应用）"><a href="#登录企业微信管理后台，找到应用管理，点击创建自建应用（例如这里我创建了一个名称为天气推送的应用）" class="headerlink" title="登录企业微信管理后台，找到应用管理，点击创建自建应用（例如这里我创建了一个名称为天气推送的应用）"></a>登录企业微信管理后台，找到应用管理，点击创建自建应用（例如这里我创建了一个名称为天气推送的应用）</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/06/16361635628391.jpg" alt="16361635628391"></p><h3 id="点击打开创建的应用，获取开发相关的配置信息（AgentId-Secret）"><a href="#点击打开创建的应用，获取开发相关的配置信息（AgentId-Secret）" class="headerlink" title="点击打开创建的应用，获取开发相关的配置信息（AgentId,Secret）"></a>点击打开创建的应用，获取开发相关的配置信息（AgentId,Secret）</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/06/16361637536484.jpg" alt="16361637536484"><br> AgentId：这个应用的唯一标识<br> Secret：密钥（需要发送到企业微信app才能查看）</p><h3 id="到此所有企业微信配置结束"><a href="#到此所有企业微信配置结束" class="headerlink" title="到此所有企业微信配置结束"></a>到此所有企业微信配置结束</h3><h2 id="天气开放平台配置"><a href="#天气开放平台配置" class="headerlink" title="天气开放平台配置"></a>天气开放平台配置</h2><h3 id="进入和风天气开放平台，点击注册"><a href="#进入和风天气开放平台，点击注册" class="headerlink" title="进入和风天气开放平台，点击注册"></a>进入<a href="https://dev.qweather.com/">和风天气开放平台</a>，点击注册</h3><p> <em><strong>注册完成后建议申请认证个人开发者</strong></em>（支持更多接口）<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/06/16361640883550.jpg" alt="16361640883550"></p><h3 id="登录控制台，点击应用管理，创建应用，获取到应用的KEY"><a href="#登录控制台，点击应用管理，创建应用，获取到应用的KEY" class="headerlink" title="登录控制台，点击应用管理，创建应用，获取到应用的KEY"></a>登录控制台，点击应用管理，创建应用，获取到应用的KEY</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/06/16361644923902.jpg" alt="16361644923902"></p><h2 id="项目开发"><a href="#项目开发" class="headerlink" title="项目开发"></a>项目开发</h2><p>前端项目：<a href="https://github.com/yangh124/weather-push-admin">weather-push-admin</a><br>后台项目：<a href="https://github.com/yangh124/weather-push">weather-push</a></p><h2 id="定时任务配置配置"><a href="#定时任务配置配置" class="headerlink" title="定时任务配置配置"></a>定时任务配置配置</h2><h3 id="执行执行初始化sql"><a href="#执行执行初始化sql" class="headerlink" title="执行执行初始化sql"></a>执行执行初始化sql</h3><p>在后台项目resources&#x2F;sql&#x2F;init.sql</p><h3 id="运行前后端项目"><a href="#运行前后端项目" class="headerlink" title="运行前后端项目"></a>运行前后端项目</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561503716829.jpg" alt="16561503716829"></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561503961795.jpg" alt="16561503961795"></p><h3 id="登录后台"><a href="#登录后台" class="headerlink" title="登录后台"></a>登录后台</h3><p>使用默认账号密码登录：admin 123456<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561505074675.jpg" alt="16561505074675"></p><h3 id="配置地区"><a href="#配置地区" class="headerlink" title="配置地区"></a>配置地区</h3><p>即配置需要发送天气预报的地区<br><strong>注：这里的地区对应企业微信通讯录中的标签</strong></p><blockquote><p>地区管理 -&gt; 添加<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561506595631.jpg" alt="16561506595631"></p></blockquote><h3 id="地区绑定成员"><a href="#地区绑定成员" class="headerlink" title="地区绑定成员"></a>地区绑定成员</h3><blockquote><p>成员管理 -&gt; 选择左边的地区 -&gt; 点击添加成员<br><strong>注：这里的成员对应企业微信通讯录中的成员</strong><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561508273991.jpg" alt="16561508273991"></p></blockquote><h3 id="创建定时任务"><a href="#创建定时任务" class="headerlink" title="创建定时任务"></a>创建定时任务</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561517473902.jpg" alt="16561517473902"></p><h2 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h2><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2022/06/25/16561520350860.jpg" alt="16561520350860"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;企业微信配置&quot;&gt;&lt;a href=&quot;#企业微信配置&quot; class=&quot;headerlink&quot; title=&quot;企业微信配置&quot;&gt;&lt;/a&gt;企业微信配置&lt;/h2&gt;&lt;h3 id=&quot;进入企业微信官网，点击立即注册&quot;&gt;&lt;a href=&quot;#进入企业微信官网，点击立即注册&quot; class</summary>
      
    
    
    
    <category term="项目" scheme="https://yangh124.github.io/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="实战" scheme="https://yangh124.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot+RabbitMQ实战</title>
    <link href="https://yangh124.github.io/2021/10/29/SpringBoot%20RabbitMQ%E5%AE%9E%E6%88%98/"/>
    <id>https://yangh124.github.io/2021/10/29/SpringBoot%20RabbitMQ%E5%AE%9E%E6%88%98/</id>
    <published>2021-10-28T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.125Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、引入依赖"><a href="#一、引入依赖" class="headerlink" title="一、引入依赖"></a>一、引入依赖</h2><p>本文使用的SpringBoot版本为2.5.4</p><h3 id="1-pom文件"><a href="#1-pom文件" class="headerlink" title="1.pom文件"></a>1.pom文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.4&lt;/version&gt;</span><br><span class="line">        &lt;relativePath /&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.yh&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rabbitmq-demo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;rabbitmq-demo&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;rabbitmq-demo&lt;/description&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.amqp&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-rabbit-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.78&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;excludes&gt;</span><br><span class="line">                        &lt;exclude&gt;</span><br><span class="line">                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                        &lt;/exclude&gt;</span><br><span class="line">                    &lt;/excludes&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure><h3 id="2-application-yml文件"><a href="#2-application-yml文件" class="headerlink" title="2.application.yml文件"></a>2.application.yml文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: 192.168.2.9</span><br><span class="line">    port: 5672</span><br><span class="line">    username: yh</span><br><span class="line">    password: yh</span><br></pre></td></tr></table></figure><h2 id="二、RabbitMQ-SpringBoot配置"><a href="#二、RabbitMQ-SpringBoot配置" class="headerlink" title="二、RabbitMQ SpringBoot配置"></a>二、RabbitMQ SpringBoot配置</h2><h3 id="1-配置RabbitTemplate"><a href="#1-配置RabbitTemplate" class="headerlink" title="1.配置RabbitTemplate"></a>1.配置RabbitTemplate</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.yh.rabbitmqdemo.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line">import org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line">import org.springframework.amqp.support.converter.Jackson2JsonMessageConverter;</span><br><span class="line">import org.springframework.amqp.support.converter.MessageConverter;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.DependsOn;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * rabbitmq 配置</span><br><span class="line"> *</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/9/9 20:12</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">@Configuration</span><br><span class="line">public class RabbitMqConfig &#123;</span><br><span class="line"></span><br><span class="line">    @DependsOn(&quot;messageConverter&quot;)</span><br><span class="line">    @Bean(&quot;rabbitTemplate&quot;)</span><br><span class="line">    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) &#123;</span><br><span class="line">        RabbitTemplate rabbitTemplate = new RabbitTemplate(connectionFactory);</span><br><span class="line">        rabbitTemplate.setMessageConverter(messageConverter());</span><br><span class="line">        return rabbitTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 配置消息转换器</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public MessageConverter messageConverter() &#123;</span><br><span class="line">        return new Jackson2JsonMessageConverter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-定义交换机（Exchange）"><a href="#2-定义交换机（Exchange）" class="headerlink" title="2.定义交换机（Exchange）"></a>2.定义交换机（Exchange）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package com.yh.rabbitmqdemo.rabbitmq;</span><br><span class="line"></span><br><span class="line">import org.springframework.amqp.core.Exchange;</span><br><span class="line">import org.springframework.amqp.core.ExchangeBuilder;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 定义交换机</span><br><span class="line"> * 这里定义了所有类型的交换机（四种）</span><br><span class="line"> * 方便学习测试</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * durable  消息持久化</span><br><span class="line"> *</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/9/9 20:38</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class ExchangeConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Bean(&quot;myDirectExchange&quot;)</span><br><span class="line">    public Exchange myDirectExchange() &#123;</span><br><span class="line">        return ExchangeBuilder.directExchange(&quot;my-direct-exchange&quot;).durable(true).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean(&quot;myTopicExchange&quot;)</span><br><span class="line">    public Exchange myTopicExchange() &#123;</span><br><span class="line">        return ExchangeBuilder.topicExchange(&quot;my-topic-exchange&quot;).durable(true).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean(&quot;myFanoutExchange&quot;)</span><br><span class="line">    public Exchange myFanoutExchange() &#123;</span><br><span class="line">        return ExchangeBuilder.fanoutExchange(&quot;my-fanout-exchange&quot;).durable(true).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean(&quot;myHeadsExchange&quot;)</span><br><span class="line">    public Exchange myHeadersExchange() &#123;</span><br><span class="line">        return ExchangeBuilder.headersExchange(&quot;my-headers-exchange&quot;).durable(true).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-定义队列（Queue）"><a href="#3-定义队列（Queue）" class="headerlink" title="3.定义队列（Queue）"></a>3.定义队列（Queue）</h3>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;一、引入依赖&quot;&gt;&lt;a href=&quot;#一、引入依赖&quot; class=&quot;headerlink&quot; title=&quot;一、引入依赖&quot;&gt;&lt;/a&gt;一、引入依赖&lt;/h2&gt;&lt;p&gt;本文使用的SpringBoot版本为2.5.4&lt;/p&gt;
&lt;h3 id=&quot;1-pom文件&quot;&gt;&lt;a href=&quot;</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="实战" scheme="https://yangh124.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot+Elasticsearch实战</title>
    <link href="https://yangh124.github.io/2021/10/26/SpringBoot%20ES%E5%AE%9E%E6%88%98/"/>
    <id>https://yangh124.github.io/2021/10/26/SpringBoot%20ES%E5%AE%9E%E6%88%98/</id>
    <published>2021-10-25T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.125Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、引入依赖"><a href="#一、引入依赖" class="headerlink" title="一、引入依赖"></a>一、引入依赖</h2><p>本文使用的SpringBoot版本为2.5.4，elasticsearch版本为7.15.0</p><span id="more"></span><h3 id="1-pom文件如下"><a href="#1-pom文件如下" class="headerlink" title="1. pom文件如下"></a>1. pom文件如下</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.5.4&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.yh&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;es-demo&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;es-demo&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;es-demo&lt;/description&gt;</span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;elasticsearch.version&gt;7.15.0&lt;/elasticsearch.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--使用的rest-high-level-client--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;elasticsearch.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;elasticsearch.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.70&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;excludes&gt;</span><br><span class="line">                        &lt;exclude&gt;</span><br><span class="line">                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">                        &lt;/exclude&gt;</span><br><span class="line">                    &lt;/excludes&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-application-yml配置如下"><a href="#2-application-yml配置如下" class="headerlink" title="2. application.yml配置如下"></a>2. application.yml配置如下</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch:</span><br><span class="line">  host-arr:</span><br><span class="line">    - 127.0.0.1:9200</span><br></pre></td></tr></table></figure><h2 id="二、ES-SpringBoot配置"><a href="#二、ES-SpringBoot配置" class="headerlink" title="二、ES SpringBoot配置"></a>二、ES SpringBoot配置</h2><h3 id="1-配置ES服务器地址"><a href="#1-配置ES服务器地址" class="headerlink" title="1. 配置ES服务器地址"></a>1. 配置ES服务器地址</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.yh.esdemo.config;</span><br><span class="line"></span><br><span class="line">import lombok.Getter;</span><br><span class="line">import lombok.Setter;</span><br><span class="line">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/8/30 20:35</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">@ConfigurationProperties(prefix = &quot;elasticsearch&quot;)</span><br><span class="line">public class EsHostConfig &#123;</span><br><span class="line"></span><br><span class="line">    private String[] hostArr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-配置RestHighLevelClient"><a href="#2-配置RestHighLevelClient" class="headerlink" title="2. 配置RestHighLevelClient"></a>2. 配置RestHighLevelClient</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package com.yh.esdemo.config;</span><br><span class="line"></span><br><span class="line">import org.apache.http.HttpHost;</span><br><span class="line">import org.elasticsearch.client.RestClient;</span><br><span class="line">import org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 定义RestClient Bean</span><br><span class="line"> *</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/8/30 20:32</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class EsRestClientConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private EsHostConfig esHostConfig;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public RestHighLevelClient restHighLevelClient() &#123;</span><br><span class="line">        String[] hostArr = esHostConfig.getHostArr();</span><br><span class="line">        int size = hostArr.length;</span><br><span class="line">        HttpHost[] httpHostArr = new HttpHost[size];</span><br><span class="line">        for (int i = 0; i &lt; size; i++) &#123;</span><br><span class="line">            String[] split = hostArr[i].split(&quot;:&quot;);</span><br><span class="line">            httpHostArr[i] = new HttpHost(split[0], Integer.parseInt(split[1]), &quot;http&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return new RestHighLevelClient(RestClient.builder(httpHostArr));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>配置完成后只需在相关业务中注入RestHighLevelClient即可使用</strong></em></p><h2 id="三、ES基本使用"><a href="#三、ES基本使用" class="headerlink" title="三、ES基本使用"></a>三、ES基本使用</h2><h3 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h3><h4 id="1-创建索引"><a href="#1-创建索引" class="headerlink" title="1. 创建索引"></a>1. 创建索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void addIndex() throws Exception &#123;</span><br><span class="line">    //获取 IndicesClient ，用于创建 Index</span><br><span class="line">    IndicesClient indices = restHighLevelClient.indices();</span><br><span class="line">    //定义一个 CreateIndexRequest ，参数为索引的名称</span><br><span class="line">    CreateIndexRequest createIndexRequest = new CreateIndexRequest(&quot;yh_customer&quot;);</span><br><span class="line">    //CreateIndexRequest配置相关参数 number_of_shards：分片数  number_of_replicas：每个分片的副本数</span><br><span class="line">    createIndexRequest.settings(</span><br><span class="line">            Settings.builder()</span><br><span class="line">                    .put(&quot;index.number_of_shards&quot;, 1)</span><br><span class="line">                    .put(&quot;index.number_of_replicas&quot;, 0)</span><br><span class="line">    );</span><br><span class="line">    Map&lt;String, Object&gt; name = new HashMap&lt;&gt;();</span><br><span class="line">    name.put(&quot;type&quot;, &quot;text&quot;);</span><br><span class="line">    name.put(&quot;analyzer&quot;, &quot;ik_max_word&quot;);//指定分词器</span><br><span class="line">    name.put(&quot;search_analyzer&quot;, &quot;ik_smart&quot;);</span><br><span class="line">    Map&lt;String, Object&gt; timestamp = new HashMap&lt;&gt;();</span><br><span class="line">    timestamp.put(&quot;type&quot;, &quot;date&quot;);</span><br><span class="line">    timestamp.put(&quot;format&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;);//指定时间格式</span><br><span class="line">    Map&lt;String, Object&gt; uuid = new HashMap&lt;&gt;();</span><br><span class="line">    uuid.put(&quot;type&quot;, &quot;keyword&quot;);</span><br><span class="line">    Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span><br><span class="line">    properties.put(&quot;name&quot;, name);</span><br><span class="line">    properties.put(&quot;timestamp&quot;, timestamp);</span><br><span class="line">    properties.put(&quot;uuid&quot;, uuid);</span><br><span class="line">    Map&lt;String, Object&gt; mapping = new HashMap&lt;&gt;();</span><br><span class="line">    mapping.put(&quot;properties&quot;, properties);</span><br><span class="line">    //创建mapping  mapping可以理解为此索引中数据的数据结构</span><br><span class="line">    createIndexRequest.mapping(mapping);</span><br><span class="line">    //创建索引 此方法同步返回结果  异步使用 createAsync</span><br><span class="line">    CreateIndexResponse createIndexResponse = indices.create(createIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    //创建结果（true/false）</span><br><span class="line">    System.out.println(createIndexResponse.isAcknowledged());</span><br><span class="line">    //输出创建成功的索引名称</span><br><span class="line">    System.out.println(createIndexResponse.index());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出:<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352546351035.jpg" alt="16352546351035"></p><h4 id="2-删除索引"><a href="#2-删除索引" class="headerlink" title="2. 删除索引"></a>2. 删除索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void delIndex() throws Exception &#123;</span><br><span class="line">    IndicesClient indices = restHighLevelClient.indices();</span><br><span class="line">    DeleteIndexRequest deleteIndexRequest = new DeleteIndexRequest(&quot;yh_customer&quot;);</span><br><span class="line">    AcknowledgedResponse deleteIndexResponse = indices.delete(deleteIndexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(deleteIndexResponse.isAcknowledged());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h3><h4 id="1-添加数据（单个）"><a href="#1-添加数据（单个）" class="headerlink" title="1. 添加数据（单个）"></a>1. 添加数据（单个）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void addDoc() throws Exception &#123;</span><br><span class="line">    SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">    String timestamp = simpleDateFormat.format(new Date());</span><br><span class="line">    Map&lt;String, Object&gt; jsonMap = new HashMap&lt;&gt;();</span><br><span class="line">    jsonMap.put(&quot;uuid&quot;, &quot;534523dqw4qweq24324&quot;);</span><br><span class="line">    jsonMap.put(&quot;name&quot;, &quot;张三&quot;);</span><br><span class="line">    jsonMap.put(&quot;timestamp&quot;, timestamp);</span><br><span class="line">    //创建 IndexRequest 指定id</span><br><span class="line">    IndexRequest indexRequest = new IndexRequest(&quot;yh_customer&quot;).id(&quot;1&quot;).source(jsonMap);</span><br><span class="line">    IndexResponse indexResponse = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(indexResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352570339401.jpg" alt="16352570339401"></p><h4 id="2-批量添加数据"><a href="#2-批量添加数据" class="headerlink" title="2. 批量添加数据"></a>2. 批量添加数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    @Test</span><br><span class="line">    public void bulkTest() &#123;</span><br><span class="line">        //批量添加使用 BulkRequest</span><br><span class="line">        BulkRequest bulkRequest = new BulkRequest();</span><br><span class="line">        for (int i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">            Customer customer = new Customer(UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;), i + &quot;号客户&quot;, LocalDateTime.now());</span><br><span class="line">            //String data = JSONObject.toJSONString(customer);</span><br><span class="line">            String data = JSONObject.toJSONStringWithDateFormat(customer, &quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">            IndexRequest request = new IndexRequest(&quot;yh_customer&quot;).source(data, XContentType.JSON);</span><br><span class="line">            bulkRequest.add(request);</span><br><span class="line">        &#125;</span><br><span class="line">        //同步</span><br><span class="line">//        try &#123;</span><br><span class="line">//            BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">//            boolean hasFailures = bulk.hasFailures();</span><br><span class="line">//            if (hasFailures) &#123;</span><br><span class="line">//                List&lt;BulkItemResponse&gt; collect = Arrays.stream(bulk.getItems()).filter(BulkItemResponse::isFailed).collect(Collectors.toList());</span><br><span class="line">//                System.out.println(collect.size());</span><br><span class="line">//                String msg = bulk.buildFailureMessage();</span><br><span class="line">//                System.out.println(msg);</span><br><span class="line">//            &#125;</span><br><span class="line">//        &#125; catch (IOException e) &#123;</span><br><span class="line">//            e.printStackTrace();</span><br><span class="line">//        &#125;</span><br><span class="line"></span><br><span class="line">        //异步</span><br><span class="line">        restHighLevelClient.bulkAsync(bulkRequest, RequestOptions.DEFAULT, new ActionListener&lt;BulkResponse&gt;() &#123;</span><br><span class="line">            //成功回调</span><br><span class="line">            @Override</span><br><span class="line">            public void onResponse(BulkResponse bulkItemResponses) &#123;</span><br><span class="line">                System.out.println(&quot;success&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            //失败回调</span><br><span class="line">            @Override</span><br><span class="line">            public void onFailure(Exception e) &#123;</span><br><span class="line">                System.out.println(&quot;failure&quot;);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            TimeUnit.MINUTES.sleep(5);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最终输出：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352575817746.jpg" alt="16352575817746"></p><h4 id="3-修改数据"><a href="#3-修改数据" class="headerlink" title="3. 修改数据"></a>3. 修改数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void updateDoc() throws Exception &#123;</span><br><span class="line">    UpdateRequest updateRequest = new UpdateRequest(&quot;yh_customer&quot;, &quot;1&quot;);</span><br><span class="line">    Map&lt;String, Object&gt; jsonMap = new HashMap&lt;&gt;();</span><br><span class="line">    jsonMap.put(&quot;name&quot;, &quot;李四&quot;);</span><br><span class="line">    updateRequest.doc(jsonMap);</span><br><span class="line">    UpdateResponse update = restHighLevelClient.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出:<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352577179296.jpg" alt="16352577179296"></p><h4 id="4-获取数据"><a href="#4-获取数据" class="headerlink" title="4. 获取数据"></a>4. 获取数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void get() throws Exception &#123;</span><br><span class="line">    GetRequest getRequest = new GetRequest(&quot;yh_customer&quot;);</span><br><span class="line">    getRequest.id(&quot;1&quot;);</span><br><span class="line">    GetResponse getResponse = restHighLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(getResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352579192385.jpg" alt="16352579192385"></p><h4 id="5-直接获取source"><a href="#5-直接获取source" class="headerlink" title="5. 直接获取source"></a>5. 直接获取source</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void getSource() throws Exception &#123;</span><br><span class="line">    GetSourceRequest getRequest = new GetSourceRequest(&quot;yh_customer&quot;, &quot;1&quot;);</span><br><span class="line">    GetSourceResponse source = restHighLevelClient.getSource(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352580418359.jpg" alt="16352580418359"></p><h3 id="判断是否存在"><a href="#判断是否存在" class="headerlink" title="判断是否存在"></a>判断是否存在</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void exists() throws Exception &#123;</span><br><span class="line">    GetRequest getRequest = new GetRequest(&quot;yh_customer&quot;);</span><br><span class="line">    getRequest.id(&quot;1&quot;);</span><br><span class="line">    boolean exists = restHighLevelClient.exists(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(exists);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出:<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352578138427.jpg" alt="16352578138427"></p><h2 id="四、ES简单搜索"><a href="#四、ES简单搜索" class="headerlink" title="四、ES简单搜索"></a>四、ES简单搜索</h2><h3 id="根据条件搜索"><a href="#根据条件搜索" class="headerlink" title="根据条件搜索"></a>根据条件搜索</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void search() throws Exception &#123;</span><br><span class="line">    SearchRequest searchRequest = new SearchRequest(&quot;yh_customer&quot;);//没有参数，查询所有索引</span><br><span class="line">    //构建搜索条件</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">    //根据name字段搜索</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchQuery(&quot;name&quot;, &quot;1&quot;));</span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    SearchResponse search = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    //返回命中数据</span><br><span class="line">    SearchHits hits = search.getHits();</span><br><span class="line">    for (SearchHit hit : hits.getHits()) &#123;</span><br><span class="line">        String sourceAsString = hit.getSourceAsString();</span><br><span class="line">        Customer customer = JSONObject.parseObject(sourceAsString, Customer.class);</span><br><span class="line">        System.out.println(customer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出:<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/26/16352583920483.jpg" alt="16352583920483"></p><h3 id="查询所有"><a href="#查询所有" class="headerlink" title="查询所有"></a>查询所有</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void simpleSearch() throws Exception &#123;</span><br><span class="line">    //创建搜索request</span><br><span class="line">    SearchRequest searchRequest = new SearchRequest(&quot;bank&quot;);</span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">    searchSourceBuilder.query(QueryBuilders.matchAllQuery());//检索所有字段</span><br><span class="line">    SearchRequest request = searchRequest.source(searchSourceBuilder);</span><br><span class="line">    SearchResponse search = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    SearchHits hits = search.getHits();//命中条数</span><br><span class="line">    System.out.println(&quot;总条数：&quot; + hits.getTotalHits().value);</span><br><span class="line">    for (SearchHit hit : hits) &#123;//默认只检索出10条</span><br><span class="line">        Staff staff = JSONObject.parseObject(hit.getSourceAsString(), Staff.class);</span><br><span class="line">        System.out.println(staff);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终输出：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/27/16353396396063.jpg" alt="16353396396063"></p><h2 id="五、ES聚合搜索"><a href="#五、ES聚合搜索" class="headerlink" title="五、ES聚合搜索"></a>五、ES聚合搜索</h2><p><em><strong>需要先导入官方提供的测试数据（使用kibana）</strong></em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    @Test</span><br><span class="line">    public void aggSearch() throws Exception &#123;</span><br><span class="line">        //创建搜索request</span><br><span class="line">        SearchRequest searchRequest = new SearchRequest(&quot;bank&quot;);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        //查询条件</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        //统计各个年龄的平均工资</span><br><span class="line">        searchSourceBuilder.aggregation(AggregationBuilders.terms(&quot;ageAgg&quot;).field(&quot;age&quot;).subAggregation(AggregationBuilders.avg(&quot;balanceAvgAgg&quot;).field(&quot;balance&quot;)));</span><br><span class="line">        //所有人平均工资</span><br><span class="line">        searchSourceBuilder.aggregation(AggregationBuilders.avg(&quot;allBalanceAvgAgg&quot;).field(&quot;balance&quot;));</span><br><span class="line">        //构建request</span><br><span class="line">        SearchRequest request = searchRequest.source(searchSourceBuilder);</span><br><span class="line">        //search</span><br><span class="line">        SearchResponse searchResponse = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        //Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        //Aggregation接口有很多实现类  Avg（平均值）</span><br><span class="line">//        Avg avg = aggregations.get(&quot;balanceAgg&quot;);</span><br><span class="line">//        System.out.println(avg.getValue());</span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Terms ageAgg = aggregations.get(&quot;ageAgg&quot;);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = ageAgg.getBuckets();</span><br><span class="line">        for (Terms.Bucket bucket : buckets) &#123;//只查出了10条数据</span><br><span class="line">            System.out.println(&quot;年龄:&quot; + bucket.getKey());</span><br><span class="line">            System.out.println(&quot;人数:&quot; + bucket.getDocCount());</span><br><span class="line">            Avg avg = bucket.getAggregations().get(&quot;balanceAvgAgg&quot;);</span><br><span class="line">            System.out.println(&quot;平均工资:&quot; + avg.getValue());</span><br><span class="line">            System.out.println(&quot;=================================&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Avg avg = aggregations.get(&quot;allBalanceAvgAgg&quot;);</span><br><span class="line">        System.out.println(&quot;所有人平均工资:&quot; + avg.getValue());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最终输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">年龄:31</span><br><span class="line">人数:61</span><br><span class="line">平均工资:28312.918032786885</span><br><span class="line">=================================</span><br><span class="line">年龄:39</span><br><span class="line">人数:60</span><br><span class="line">平均工资:25269.583333333332</span><br><span class="line">=================================</span><br><span class="line">年龄:26</span><br><span class="line">人数:59</span><br><span class="line">平均工资:23194.813559322032</span><br><span class="line">=================================</span><br><span class="line">年龄:32</span><br><span class="line">人数:52</span><br><span class="line">平均工资:23951.346153846152</span><br><span class="line">=================================</span><br><span class="line">年龄:35</span><br><span class="line">人数:52</span><br><span class="line">平均工资:22136.69230769231</span><br><span class="line">=================================</span><br><span class="line">年龄:36</span><br><span class="line">人数:52</span><br><span class="line">平均工资:22174.71153846154</span><br><span class="line">=================================</span><br><span class="line">年龄:22</span><br><span class="line">人数:51</span><br><span class="line">平均工资:24731.07843137255</span><br><span class="line">=================================</span><br><span class="line">年龄:28</span><br><span class="line">人数:51</span><br><span class="line">平均工资:28273.882352941175</span><br><span class="line">=================================</span><br><span class="line">年龄:33</span><br><span class="line">人数:50</span><br><span class="line">平均工资:25093.94</span><br><span class="line">=================================</span><br><span class="line">年龄:34</span><br><span class="line">人数:49</span><br><span class="line">平均工资:26809.95918367347</span><br><span class="line">=================================</span><br><span class="line">所有人平均工资:25714.837</span><br></pre></td></tr></table></figure><p>demo地址：<a href="https://github.com/yangh124/es-demo">https://github.com/yangh124/es-demo</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;一、引入依赖&quot;&gt;&lt;a href=&quot;#一、引入依赖&quot; class=&quot;headerlink&quot; title=&quot;一、引入依赖&quot;&gt;&lt;/a&gt;一、引入依赖&lt;/h2&gt;&lt;p&gt;本文使用的SpringBoot版本为2.5.4，elasticsearch版本为7.15.0&lt;/p&gt;</summary>
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="elastic search" scheme="https://yangh124.github.io/tags/elastic-search/"/>
    
    <category term="实战" scheme="https://yangh124.github.io/tags/%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>Netty</title>
    <link href="https://yangh124.github.io/2021/09/14/Netty/"/>
    <id>https://yangh124.github.io/2021/09/14/Netty/</id>
    <published>2021-09-13T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h2><h3 id="Netty介绍应用场景"><a href="#Netty介绍应用场景" class="headerlink" title="Netty介绍应用场景"></a>Netty介绍应用场景</h3><h4 id="Netty介绍"><a href="#Netty介绍" class="headerlink" title="Netty介绍"></a>Netty介绍</h4><ol><li>Netty是Jboss提供的一个开源框架，现为GitHub上的独立项目。</li><li>Netty是异步的、基于事件驱动的网络应用框架，用以快速开发高性能、高可靠性的网络IO程序。</li><li>Netty主要针对在TCP协议下，面向Clients端的高并发应用，或者Peer to Peer场景下的大量数据持续传输的应用。</li><li>Netty本质是NIO框架，适用于服务器通讯相关的多种应用场景。</li><li>要透彻理解Netty，需要先学习NIO，这样我们才能阅读Netty源码。<span id="more"></span><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/14/16316233529799.jpg" alt="16316233529799"></li></ol><h4 id="Netty的应用场景"><a href="#Netty的应用场景" class="headerlink" title="Netty的应用场景"></a>Netty的应用场景</h4><ol><li>互联网行业<ul><li>在分布式系统中，各个节点之间需要远程服务调用，高性能的RPC框架必不可少，Netty作为异步高性能通信框架，往往作为基础通信组件被这些RPC框架使用。</li><li>典型应用：阿里分布式服务框架Dubbo的RPC框架使用Dubbo协议进行节点间通信，Dubbo协议默认使用Netty作为基础通信组件，用与实现各进程节点之间的内部通信。</li></ul></li><li>游戏行业<ul><li>无论是手游服务端还是大型的网络游戏，Java语言得到了越来越广泛的应用。</li><li>Netty作为高性能的基础通信组件，提供了TCP&#x2F;UDP和HTTP协议栈，方便定制和开发私有协议，账号登录服务器。</li><li>地图服务器之间可以方便的通过Netty进行高性能的通信。</li></ul></li><li>大数据领域<ul><li>经典的Hadoop的高性能通信和序列化组件（AVRO 实现数据文件共享）的RPC框架，默认采用Netty进行跨界点通信。</li><li>它的Netty Service基于Netty框架二次封装实现的。</li></ul></li></ol><h3 id="Java-IO编程"><a href="#Java-IO编程" class="headerlink" title="Java IO编程"></a>Java IO编程</h3><h4 id="IO模型"><a href="#IO模型" class="headerlink" title="IO模型"></a>IO模型</h4><h5 id="IO模型基本说明"><a href="#IO模型基本说明" class="headerlink" title="IO模型基本说明"></a>IO模型基本说明</h5><ol><li>IO模型简单的理解：就是用什么样的通道进行数据的发送和接收，很大程度上决定了程序通信的性能。</li><li>java共支持3种网络编程模型IO模式：NIO、BIO、AIO<ol><li>BIO：同步并阻塞（传统阻塞型），服务器实现模式为一个连接一个线程，即客户端有连接请求时服务器端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/14/16316252775663.jpg" alt="16316252775663"></li><li>NIO：同步非阻塞，服务器实现模式为一个线程处理多个请求（连接），即客户端发送连接请求都会注册到多路复用器上， 多路复用器轮询到连接有IO请求就进行处理。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/14/16316256732370.jpg" alt="16316256732370"></li><li>AIO（NIO.2）：异步非阻塞，AIO引入异步通道的概念，采用了Proactor模式，简化了程序编写，有效的请求才启动线程，它的特点是先由操作系统完成后才通知服务端程序启动线程取处理，一般适用于连接数多且连接时间较长的应用。</li></ol></li></ol><h5 id="适用场景分析"><a href="#适用场景分析" class="headerlink" title="适用场景分析"></a>适用场景分析</h5><ol><li>BIO方式适用于连接数目较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4以前的唯一选择，但程序简单易理解。</li><li>NIO方式适用于连接数目多且连接时间比较短（轻操作）的架构，比如聊天服务器，弹幕系统，服务间通讯等。编程比较复杂，JDK1.4开始支持。</li><li>AIO方式适用于连接数目多且连接比较长（重操作）的架构，比如相册服务器，充分调用OS参与并发操作，编程比较复杂，JDk7开始支持。</li></ol><h4 id="Java-BIO"><a href="#Java-BIO" class="headerlink" title="Java BIO"></a>Java BIO</h4><ol><li>Java BIO就是传统的java io编程，其相关的类和接口在java.io </li><li>BIO（block IO）：同步阻塞，服务器实现模式为一个连接一个线程，即客户端有连接请求是服务端就需要启动一个线程进行处理，如果连接不做任何事情会造成不必要的线程开销，可以通过线程池机制改善（实现多个客户端连接服务器）。</li><li>BIO方式适用于连接数目比较小且固定的架构，这种方式对服务器资源的要求比较高，并发局限于应用中，JDK1.4以前唯一的选择程序简单易理解</li><li>对BIO流程的梳理<ol><li>服务端启动一个ServerSocket</li><li>客户端启动Socket对服务器进行通信，默认情况下服务器端需要对每一个客户建立一个线程与之通讯</li><li>客户端发出请求后，先咨询服务器是否有线程响应，如果没有则会等待，或者拒绝</li><li>如果有响应，客户端线程会等待请求结束后，再继续执行</li></ol></li><li>Java BIO应用实例<ol><li>使用BIO模型编写一个服务端，监听6666端口，当有客户端连接时，就启动一个线程与之通信。</li><li>要求使用线程池机制改善，可以连接多个客户端。</li><li>服务端可以接收客户端发送的数据（telnet方式即可）</li><li>demo见netty-study</li></ol></li></ol><h4 id="Java-NIO"><a href="#Java-NIO" class="headerlink" title="Java NIO"></a>Java NIO</h4><ol><li>Java NIO全称 java non-blocking IO，是指JDK提供的新API。从JDK1.4开始，Java提供了一系列改进的输入&#x2F;输出的新特性，被统称为NIO（New IO），是同步非阻塞的</li><li>NIO相关类都被放在java.nio包及子包下，并且对原java.nio包中的很多类进行改写。</li><li>NIO有三大核心部分：Channel（通道），Buffer（缓冲区），Selector（选择器）。</li><li>NIO是面向缓冲区，或者面向块编程的。数据读取到一个它稍后处理的缓冲区，需要时可在缓冲区中前后移动，这就增加了处理过程中的灵活性，使用它可以提供非阻塞的高伸缩性网络</li><li>Java NIO的非阻塞模式，使一个线程从某通道发送请求或者读取数据，但是它仅能得到目前可用的数据，如果目前没有可用的数据，就什么都不会获取，而不是保持线程阻塞，所以直至数据变得可以读之前，该线程可以继续做其他的事情。非阻塞写也是如此，一个线程请求写入一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情。</li><li>通俗理解：NIO是可以做到用一个线程来处理多个操作的。假设有10000个请求过来，根据实际情况，可以分配50或者100个线程来处理。不像之前的阻塞IO那样，非得分配10000个线程。</li><li>http2.0使用了多路复用的技术，做到同一个连接并发处理多个请求，而且并发请求的数量比http1.1大了好几个数量级。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/22/16323168494091.jpg" alt="16323168494091"></li></ol><h4 id="NIO和BIO的比较"><a href="#NIO和BIO的比较" class="headerlink" title="NIO和BIO的比较"></a>NIO和BIO的比较</h4><ol><li>BIO以流的方式处理数据，而NIO以块的方式处理数据，块IO的效率比流IO高很多</li><li>BIO是阻塞的，NIO则是非阻塞的</li><li>BIO基于字节流和字符流进行操作，而NIO基于Channel（通道）和Buffer（缓冲区）进行操作，数据总是从通道读取到缓冲区中，或者从缓冲区写入到通道中。Selector（选择器）用于监听多个通道的事件（比如：连接请求，数据到达等），因此使用当个线程就可以监听多个客户端通道</li></ol><h4 id="NIO三大核心"><a href="#NIO三大核心" class="headerlink" title="NIO三大核心"></a>NIO三大核心</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/22/16323190875807.jpg" alt="16323190875807"></p><ol><li>每个Channel都会对应一个Buffer</li><li>Selector会对应一个线程，一个线程对应多个Channel（连接）</li><li>该图反映了有三个Channel注册到该Selector上</li><li>程序切换到哪个Channel是由事件决定的，Event就是一个重要的概念</li><li>Selector会根据不同的事件，在各个通道上切换</li><li>Buffer就是一个内存块，底层是一个数组</li><li>数据的读取写入都是通过Buffer，这个和BIO有很大区别（BIO要么是输入流，要么是输出流，不能双向）</li><li>Channel是双向的，可以反映操作系统底层的情况，比如Linux，底层的通道就是双向的</li></ol><h5 id="缓冲区（Buffer）"><a href="#缓冲区（Buffer）" class="headerlink" title="缓冲区（Buffer）"></a>缓冲区（Buffer）</h5><p> 基本介绍：    </p><ol><li>缓冲区本质上是一个可以读写数据的内存块，可以理解为是一个容器对象（数组），该对象提供一组方法，可以轻松跟踪和记录缓存区的状态变换情况。Channel提供从文件、网络读取数据的渠道，但是读取或写入的数据都必须经由Buffer。如图：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327501871455.jpg" alt="16327501871455"></li><li>Buffer类定义了所有的缓冲区都具有4个属性来提供关于其所包含的数据元素的信息：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327501702766.jpg" alt="16327501702766"></li><li>Buffer类相关方法<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327503987878.jpg" alt="16327503987878"><br><strong>ByteBuffer</strong>：<br> 对于Java中的基本数据类型（boolean）除外，都有一个Buffer类型与之相对应，最常用的自然是ByteBuffer类（二进制数据），该类的主要方法：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327506868826.jpg" alt="16327506868826"></li></ol><h5 id="通道（Channel）"><a href="#通道（Channel）" class="headerlink" title="通道（Channel）"></a>通道（Channel）</h5><p>基本介绍：</p><ol><li>NIO的通道类似于流，但是有些区别：<ol><li>通道可以同时进行读写，而流只能读或者只能写</li><li>通道可以实现异步读写数据</li><li>通道可以从缓冲读数据，也可以写数据到缓冲</li></ol></li><li>BIO的stream是单向的，例如FileInputStream对象只能进行读取数据的操作，而NIO中的通道（Channel）是双向的，可以读操作，也可以写操作。</li><li>Channel在NIO中是一个接口</li><li>常用的Channel类有：FileChannel、DatagramChannel、ServerSocketChannel和SocketChannel（ServerSocketChannel -&gt; Java ServerSocket；SocketChannel -&gt; Java Socket）</li><li>FileChannel用于文件读写，DatagramChannel用于udp的数据读写，ServerSocketChannel和SocketChannel用于tcp数据读写<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327523590487.jpg" alt="16327523590487"></li></ol><p><strong>FileChannel类</strong><br>FileChannel主要用于对本地文件进行IO操作，常见的方法有<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327525043113.jpg" alt="16327525043113"><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/09/27/16327537673560.jpg" alt="16327537673560"></p><p><strong>关于Buffer和Channel的注意事项和细节</strong></p><ol><li>Buffer支持类型化的put和get，put放入的是什么数据类型，get就应该使用相应的数据类型来取出，否则可能有BufferUnderflowException。</li><li>可以将一个普通Buffer转成只读Buffer。</li><li>NIO还提供了MappedByteBuffer，可以让文件直接在内存（堆外内存）中进行修改，而如何同步到文件由NIO来完成。</li><li>前面我们讲的读写操作，都是通过一个Buffer来完成的，NIO还支持通过多个Buffer（即Buffer数组）完成读写操作，即Scattering（分散）和Gathering（合并）。</li></ol><h5 id="选择器（Selector）"><a href="#选择器（Selector）" class="headerlink" title="选择器（Selector）"></a>选择器（Selector）</h5><ol><li>Java的NIO，用非阻塞的IO方式。可以用一个线程，处理多个的客户端连接，就会使用到Selector（选择器）。</li><li><strong>Selector能够检测多个注册的通道上是否有事件发生（注意：多个Channel以事件的方式可以注册到同一个Selector）</strong>，如果有事件发生，便获取事件然后针对每个事件进行相应的处理。这样就可以只用一个单线程去管理多个通道，也就是管理多个连接和请求。</li><li>只有连接真正有读写事件发生时，才会进行读写，就大大地减少了系统开销，并且不必为每个连接都创建一个线程，不用去维护多个线程</li><li>避免了多线程之间的上下文切换导致的开销。<br><strong>特点再说明：</strong><ol><li>Netty的IO线程NioEventLoop聚合了Selector（选择器，也叫多路复用器），可以同时并发处理成百上千个客户端连接。</li><li>当线程从某个客户端Socket通道进行读写数据时，若没有数据可用时，该线程可以进行其他任务。</li><li>线程通常将非阻塞IO的空闲时间用于在其他通道上执行IO操作，所以单独的线程可以管理多个输入和输出通道。</li><li>由于读写操作时非阻塞的，这就可以充分提升IO线程的运行效率，避免由于频繁的IO阻塞导致线程挂起。</li><li>一个IO线程可以并发的处理N个客户端连接和读写操作，这从根本上解决传统同步阻塞IO一连接一线程模型，架构的性能、弹性伸缩能力和可靠性都得到了极大的提升。</li><li>Selector相关方法说明： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">selector.select();// 阻塞</span><br><span class="line">selector.select(1000);// 阻塞1秒，在1秒后返回</span><br><span class="line">selector.wakeup();// 唤醒selector</span><br><span class="line">selector.selectNow();// 不阻塞，立即返回</span><br></pre></td></tr></table></figure></li></ol></li></ol><p><strong>NIO非阻塞网络编程原理分析图</strong></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/08/16336985904631.jpg" alt="16336985904631"><br>    说明：<br>        1. 当客户端连接时，会通过ServerSocketChannel得到SocketChannel。<br>        2. 将socketChannel注册到Selector上（register(Selector selector, int ops)），一个selector上可以注册多个SocketChannel。<br>        3. 注册后返回一个selectionKey，会和该Selector关联（集合）。<br>        4. Selector进行监听（select方法），返回有时间发生的通道个数,得到各个SelectionKey<br>        5. 通过SelectionKey反向获取SocketChannel（channel方法）<br>        6. 最后可以通过得到channel，完成业务处理</p><h6 id="SelectionKey"><a href="#SelectionKey" class="headerlink" title="SelectionKey"></a>SelectionKey</h6><p>SelectionKey,表示Selector和网络通道的注册关系，共4种：<br>    * OP_ACCEPT：有新的网络连接可以accept，值为16<br>    * OP_CONNECT：代表连接已经建立，值为8<br>    * OP_READ：代表读操作，值为1<br>    * OP_WRITE：代表写操作，值为4<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/13/16341300676869.jpg" alt="16341300676869"></p><h6 id="ServerSocketChannel"><a href="#ServerSocketChannel" class="headerlink" title="ServerSocketChannel"></a>ServerSocketChannel</h6><ol><li>ServerSocketChannel在服务器端监听新的客户端Socket连接</li><li>相关方法<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/13/16341310234601.jpg" alt="16341310234601"></li></ol><h6 id="SocketChannel"><a href="#SocketChannel" class="headerlink" title="SocketChannel"></a>SocketChannel</h6><ol><li>SocketChannel，网络IO通道，具体负责进行读写操作。NIO把缓冲区的数据写入通道，或者把通道里的数据读到缓冲区。</li><li>相关方法<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/13/16341315034228.jpg" alt="16341315034228"></li></ol><h4 id="NIO网络编程应用实例-群聊系统"><a href="#NIO网络编程应用实例-群聊系统" class="headerlink" title="NIO网络编程应用实例-群聊系统"></a>NIO网络编程应用实例-群聊系统</h4><ol><li>编写一个NIO群聊系统，实现服务器和客户端之间的数据简单通讯（非阻塞）</li><li>实现多人群聊</li><li>服务端：可以监测用户上下线，并实现消息转发功能</li><li>客户端：通过Channel可以无阻塞发送消息给其它所有用户，同时可以接受其它用户发送的消息（由服务器转发得到）</li><li>目的：进一步理解NIO非阻塞网络编程</li></ol><h4 id="NIO于零拷贝"><a href="#NIO于零拷贝" class="headerlink" title="NIO于零拷贝"></a>NIO于零拷贝</h4><ol><li>零拷贝（没有CPU拷贝）是网络编程的关键，很多性能优化都离不开。</li><li>在Java程序中，常用的零拷贝有mmap（内存映射）和sendFile。</li></ol><h5 id="传统IO"><a href="#传统IO" class="headerlink" title="传统IO"></a>传统IO</h5><p><strong>4次拷贝，3次切换状态</strong><br>DMA：direct memory access（直接内存访问）<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/16/16343550358155.jpg" alt="16343550358155"></p><h5 id="mmap优化"><a href="#mmap优化" class="headerlink" title="mmap优化"></a>mmap优化</h5><p><strong>3次拷贝，3次切换状态</strong><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/16/16343550554506.jpg" alt="16343550554506"></p><h5 id="sendFile优化"><a href="#sendFile优化" class="headerlink" title="sendFile优化"></a>sendFile优化</h5><ol><li>Linux2.1版本提供了sendFile函数，其基本原理如下：数据根本不用经过用户态，直接从内核缓冲区进入到Socket Buffer，同时，由于和用户态完全无关，就减少了一次上下文切换。<br><strong>3次拷贝，2次切换状态</strong><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/16/16343554344704.jpg" alt="16343554344704"></li><li>Linux2.4版本中，做了一些修改，避免从内核缓冲区拷贝到Socket Buffer的操作，直接拷贝到协议栈，从而又一次减少了数据拷贝。<br><strong>2次拷贝*，2次切换状态</strong><br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/16/16343557877424.jpg" alt="16343557877424"><br>*这里其实是有一次cpu拷贝的，但是拷贝的信息很少，拷贝一些元数据（length，offset..）,消耗很低，可以忽略</li></ol><h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ol><li>我们说零拷贝，是从操作系统的角度来说的。因为内核缓冲区之间，没有数据重复的（只有Kernel buffer中有一份数据）。</li><li>零拷贝不仅仅带来更少的数据复制，还能带来其他的性能优势，例如更少的上下文切换，更少的CPU缓存伪共享以及无CPU校验和计算。</li></ol><h4 id="Java-AIO"><a href="#Java-AIO" class="headerlink" title="Java AIO"></a>Java AIO</h4><ol><li>JDK7引入了Asynchronous IO，即AIO。在进行IO编程中，常用到两种模式：Reactor和Proactor。Java的NIO就是Reactor，当有事件触发时，服务端得到通知，进行相应的处理</li><li>AIO及NIO2.0，叫做异步不阻塞的IO。AIO引入异步通道的概念，采用了Proactor模式，简化了程序编写，有效的请求才启动线程，它的特点是先由操作系统完成后才通知服务端程序启动线程去处理，一般适用于连接数较多且连接事件较长的应用</li><li>目前AIO还没有广泛应用，Netty也是基于NIO的</li></ol><h3 id="Netty-1"><a href="#Netty-1" class="headerlink" title="Netty"></a>Netty</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/17/16344771397316.jpg" alt="16344771397316"></p><h4 id="原生NIO存在的问题"><a href="#原生NIO存在的问题" class="headerlink" title="原生NIO存在的问题"></a>原生NIO存在的问题</h4><ol><li>NIO的类库和API繁杂，使用麻烦：需要熟练掌握Selector、ServerSocketChannel、SocketChannel、ByteBuffer等。</li><li>需要具备其他额外的技能：要熟悉java多线程编程，因为NIO编程涉及到Reactor模式，你必须对多线程网络编程非常熟悉，才能编写出高质量的NIO程序。</li><li>开发工作量和难度非常大：例如客户端面临断连重连、网络闪断、半包读写、失败缓存、网络拥塞和异常流的处理等等。</li><li>JDK NIO的BUG：例如臭名昭著的Epoll Bug，它会导致Selector空轮询，最终导致CPU 100%。直到JDK1.7版本该问题依旧存在，没有被根本解决。</li></ol><h4 id="Netty高性能架构设计"><a href="#Netty高性能架构设计" class="headerlink" title="Netty高性能架构设计"></a>Netty高性能架构设计</h4><h5 id="线程模型基本介绍"><a href="#线程模型基本介绍" class="headerlink" title="线程模型基本介绍"></a>线程模型基本介绍</h5><ol><li>目前存在的线程模型有：<ul><li>传统的阻塞IO服务模型</li><li>Reactor模式</li></ul></li><li>根据Reactor的数量和处理资源池线程的数量不同，有3种典型的实现<ul><li>单Reactor单线程</li><li>单Reactor多线程</li><li>主从Reactor多线程</li></ul></li><li>Netty线程模式（Netty主要基于主从Reactor多线程模型做了一定的改进，其中主从Reactor多线程模型有多个Reactor）</li></ol><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/17/16344787922814.jpg" alt="16344787922814"></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/17/16344791404243.jpg" alt="16344791404243"><br>说明：<br>    1. Reactor模式，通过一个或多个输入同时传递给服务处理器的模式（基于事件驱动）<br>    2. 服务端程序处理传入的多个请求，并将它们同步分派到相应的处理线程，因此Reactor模式也叫做Dispather模式<br>    3. Reactor模式使用IO复用监听事件，收到事件后，分发给某个线程（进程）。这就是支持高并发的原因</p><h5 id="Reactor模式核心组成"><a href="#Reactor模式核心组成" class="headerlink" title="Reactor模式核心组成"></a>Reactor模式核心组成</h5><ol><li>Reactor：Reactor在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对IO事件做出反应。它就像公司的电话接线员，它接听来自客户的电话并将线路转移到适当的联系人。</li><li>Handlers：处理程序执行IO事件要完成的实际事件，类似于客户想要与之交谈的公司中的实际人员。Reactor通过调度适当的处理程序来响应IO事件，处理程序执行非阻塞操作。</li></ol><h4 id="单Reactor单线程"><a href="#单Reactor单线程" class="headerlink" title="单Reactor单线程"></a>单Reactor单线程</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/18/16345582830238.jpg" alt="16345582830238"></p><ol><li>优点：模型简单，没有多线程、进程通信、竞争的问题，全部都在一个线程中完成</li><li>缺点：性能问题，只有一个线程，无法完全发挥多核CPU的性能。Handler在处理某个连接上的业务时，整个进程无法处理其他连接事件，很容易导致性能瓶颈；可靠性问题，线程意外终止，或者进入死循环，会导致整个系统通信模块不可用，不能接收和处理外部消息，造成节点故障。</li><li>使用场景：客户端数量有限，业务处理非常快速，比如Redis在业务处理的时间复杂度O(1)的情况</li></ol><h4 id="单Reactor多线程"><a href="#单Reactor多线程" class="headerlink" title="单Reactor多线程"></a>单Reactor多线程</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/18/16345609747836.jpg" alt="16345609747836"><br>说明：</p><ol><li>Reactor对象通过select监控客户端请求事件，收到事件后，通过Dispatch进行分发</li><li>如果建立连接请求（accept），则由Accept通过accept处理连接请求，然后创建一个Handler对象处理完成连接后的各种事件</li><li>如果不是连接请求，则由Reactor分发调用连接对应的handler来处理</li><li>handler只负责响应事件，不做具体的业务处理，通过read读取数据后，会分发给后面的worker线程池的某个线程处理业务</li><li>worker线程池会分配独立线程完成真正的业务，并将处理结果返回给handler</li><li>handler收到响应后，通过send方法将结果返回给client<br>优点：可以比较充分利用多核cpu的处理能力<br>缺点： 多线程数据共享和访问比较复杂，Reactor还是单线程的，在高并发下也会出现性能瓶颈</li></ol><h4 id="主从Reactor多线程"><a href="#主从Reactor多线程" class="headerlink" title="主从Reactor多线程"></a>主从Reactor多线程</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/18/16345622839532.jpg" alt="16345622839532"><br>说明：</p><ol><li>Reactor主线程MainReactor对象通过select监听连接事件，收到事件后，通过Acceptor处理连接事件</li><li>当Acceptor处理连接事件后，MainReactor将连接分配给SubReactor</li><li>SubReactor将连接加入到连接队列，并创建handler进行各种事件的处理</li><li>当有新的事件发生时，SubReactor就会调用对应的handler进行处理</li><li>handler通过read读取数据，分发给后面的worker线程处理</li><li>worker线程池分配独立的worker线程进行处理，并返回结果</li><li>handler收到响应后，再通过send将结果返回client</li><li>Reactor主线程可以对应多个Reactor子线程，一个MainReactor对应多个SubReactor<br>优点：父线程与子线程的数据交互简单职责明确，父线程只需要接收新连接，子线程完成后续业务处理；父线程与子线程的数据交互简单，Reactor主线程只需要把新连接传给子线程，子线程无需返回数据<br>缺点：编程复杂度较高<br>结合实例：这种模型在许多项目中广泛使用，包括Nginx主从Reactor多线程模型，Memcached主从多线程，Netty主从多线程模型的支持</li></ol><h4 id="Netty模型"><a href="#Netty模型" class="headerlink" title="Netty模型"></a>Netty模型</h4><h5 id="工作原理示意图1-简单版"><a href="#工作原理示意图1-简单版" class="headerlink" title="工作原理示意图1 - 简单版"></a>工作原理示意图1 - 简单版</h5><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/18/16345655214458.jpg" alt="16345655214458"></p><h5 id="工作原理示意图2-进阶版"><a href="#工作原理示意图2-进阶版" class="headerlink" title="工作原理示意图2 - 进阶版"></a>工作原理示意图2 - 进阶版</h5><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/18/16345656941806.jpg" alt="16345656941806"></p><h5 id="工作原理示意图-详细版"><a href="#工作原理示意图-详细版" class="headerlink" title="工作原理示意图 - 详细版"></a>工作原理示意图 - 详细版</h5><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/18/16345658608160.jpg" alt="16345658608160"></p><ol><li>Netty 抽象出两组线程池：BossGroup 和 WorkerGroup，也可以叫做 BossNioEventLoopGroup 和WorkerNioEventLoopGroup。每个线程池中都有 NioEventLoop 线程。BossGroup 中的线程专门负责和客户端建立连接，WorkerGroup 中的线程专门负责处理连接上的读写。</li><li>BossGroup 和 WorkerGroup 的类型都是 NioEventLoopGroup。</li><li>NioEventLoopGroup 相当于一个事件循环组，这个组中含有多个事件循环，每个事件循环就是一个 NioEventLoop。</li><li>NioEventLoop 表示一个不断循环的执行事件处理的线程，每个 NioEventLoop 都包含一个 Selector，用于监听注册在其上的 Socket 网络连接（Channel）。</li><li>NioEventLoopGroup 可以含有多个线程，即可以含有多个 NioEventLoop。</li><li>每个 BossNioEventLoop 中循环执行以下三个步骤：<ol><li>select：轮询注册在其上的 ServerSocketChannel 的 accept 事件（OP_ACCEPT 事件）</li><li>processSelectedKeys：处理 accept 事件，与客户端建立连接，生成一个 NioSocketChannel，并将其注册到某个 WorkerNioEventLoop 上的 Selector 上</li><li>runAllTasks：再去以此循环处理任务队列中的其他任务</li></ol></li><li>每个 WorkerNioEventLoop 中循环执行以下三个步骤：<ol><li>select：轮训注册在其上的 NioSocketChannel 的 read&#x2F;write 事件（OP_READ&#x2F;OP_WRITE 事件）</li><li>processSelectedKeys：在对应的 NioSocketChannel 上处理 read&#x2F;write 事件</li><li>runAllTasks：再去以此循环处理任务队列中的其他任务</li></ol></li><li>在以上两个processSelectedKeys步骤中，会使用 Pipeline（管道），Pipeline 中引用了 Channel，即通过 Pipeline 可以获取到对应的 Channel，Pipeline 中维护了很多的处理器（拦截处理器、过滤处理器、自定义处理器等）。这里暂时不详细展开讲解 Pipeline。</li></ol><h5 id="任务队列中Task有3种典型的使用场景"><a href="#任务队列中Task有3种典型的使用场景" class="headerlink" title="任务队列中Task有3种典型的使用场景"></a>任务队列中Task有3种典型的使用场景</h5><ol><li>用户自定义的普通任务 -&gt; TaskQueue</li><li>用户自定义定时任务 -&gt; ScheduleTaskQueue</li><li>非当前Reactor线程调用Channel的各种方法<br>例如在推送系统的业务线程里面，根据用户的标识，找到对应的Channel引用，然后调用Write类方法向该用户推送消息，就会进入到这种场景。最终的Write会提交到任务队列中后被异步消费</li></ol><h5 id="异步模型"><a href="#异步模型" class="headerlink" title="异步模型"></a>异步模型</h5><ol><li>异步的概念和同步相对。当一个异步过程调用发出后，调用者不能立刻得到结果。实际处理这个调用的组件在完成后，通过状态、通知和回调来通知调用者。</li><li>Netty中的IO操作是异步的，包括Bind、Write、Connect等操作会简单返回一个ChannelFuture。</li><li>调用者不能立刻获得结果，而是通过Future-Listener机制，用户可以方便的主动获取或者通过通知机制获取IO结果。</li><li>Netty的异步模型是建立在Future和callback之上的。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/10/23/16349582177471.jpg" alt="16349582177471"></li></ol><h4 id="Netty核心模块组件"><a href="#Netty核心模块组件" class="headerlink" title="Netty核心模块组件"></a>Netty核心模块组件</h4><h5 id="BootStrap、ServerBootStrap"><a href="#BootStrap、ServerBootStrap" class="headerlink" title="BootStrap、ServerBootStrap"></a>BootStrap、ServerBootStrap</h5><ol><li>BootStrap意思是引导，一个Netty应用通常由一个BootStrap开始，主要作用是配置整个Netty程序，串联各个组件，Netty中BootStrap类是客户端程序的启动引导类，ServerBootStrap是服务端启动引导类</li><li>常见方法有：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/01/16357740744142.jpg" alt="16357740744142"></li></ol><h5 id="Future、ChannelFuture"><a href="#Future、ChannelFuture" class="headerlink" title="Future、ChannelFuture"></a>Future、ChannelFuture</h5><ol><li>Netty中所有的IO操作都是异步的，不能立刻得知消息是否被正确处理。通过Future和ChannelFuture，它们可以注册一个监听，当操作执行成功或失败时监听会自动触发注册的监听事件</li><li>常见的方法：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/01/16357744624365.jpg" alt="16357744624365"></li></ol><h5 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h5><ol><li>Netty通信的组件，能够用于执行网络IO操作。</li><li>通过Channel可获取当前网络连接的通道的状态。</li><li>通过Channel可获得网络连接的配置参数（例如接收缓冲区大小）</li><li>Channel提供异步的网络IO操作（如建立连接，读写，绑定端口）。异步调用意味着任何IO调用都将立即返回，并且不保证在调用结束时说请求的IO操作完成。</li><li>调用立即返回一个ChannelFuture实例，通过注册监听器到ChannelFuture上，可以IO操作成功、失败或取消时回调通知调用方</li><li>支持关联IO操作与对应的处理程序</li><li>不同协议、不同的阻塞类型都有不同的Channel类型与之对应，常用的Channel类型：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/01/16357750690247.jpg" alt="16357750690247"></li></ol><h5 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h5><ol><li>Netty基于Selector对象实现IO多路复用，通过Selector一个线程可以监听多个连接的Channel事件。</li><li>当向一个Selector中注册Channel后，Selector内部的机制就可以自动不断的查询（select）这些注册的Channel是否有已就绪的IO事件（例如可读，可写，网络连接完成等），这样程序久可以简单的使用一个线程高效的管理多个Channel</li></ol><h5 id="ChannelHandler及其实现类"><a href="#ChannelHandler及其实现类" class="headerlink" title="ChannelHandler及其实现类"></a>ChannelHandler及其实现类</h5><ol><li>ChannelHandler是一个接口，处理IO事件或拦截IO操作，并将其转发到其ChannelPipeline（业务处理链）中的下一个处理程序。</li><li>ChannelHandler本身没有提供很多方法，因为这个接口有许多的方法需要实现，方便使用期间，可以继承它的子类</li><li>ChannelHandler及其实现类：<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/04/16360306395987.jpg" alt="16360306395987"></li></ol><ul><li>ChannelInboundHandler用于处理入站IO事件。</li><li>ChannelOutboundHandler用于处理出站IO操作。</li><li>ChannelDuplexHandler既可以用于处理入站IO，也可以处理出站IO</li></ul><h5 id="Pipeline和ChannelPipeline"><a href="#Pipeline和ChannelPipeline" class="headerlink" title="Pipeline和ChannelPipeline"></a>Pipeline和ChannelPipeline</h5><ol><li>ChannelPipeline是一个Handler的集合，它负责处理和拦截inbound或者outbound的事件和操作，相当于一个贯穿Netty的链。</li><li>ChannelPipeline实现了一种高级形式的拦截过滤器模式，使用户可以完全控制事件的处理方式，以及CHannel中各个的ChannelHandler如何交互</li><li>在Netty中每个Channel都有且仅有一个ChannelPipeline与之对应，它们的组成关系如下<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/11/10/16365493912838.jpg" alt="16365493912838"></li></ol><ul><li>一个Channel包含了一个ChannelPipeline，而ChannelPipeline中又维护了一个有ChannelHandlerContext组成的双向链表，并且每个ChannelHandlerContext又关联着一个ChannelHandler</li><li>入站事件和出站事件在一个双向链表中，入站事件会从链表head往后传递到最后一个入站的handler，出站事件会从链表的tail往前传递到最前一个出站的handler，两种类型的handler互补干扰</li></ul><h5 id="ChannelHandlerContext"><a href="#ChannelHandlerContext" class="headerlink" title="ChannelHandlerContext"></a>ChannelHandlerContext</h5><ol><li>保存Channel相关的所有上下文信息，同时关联一个ChannelHandler对象</li><li>即ChannelHandlerContext中包含一个具体的事件处理器ChannelHandler，同时ChannelHandlerContext中也绑定了对应的pipeline和Channel信息，方便对ChannelHandler进行调用。</li><li>常用方法：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ChannelFuture close(); //关闭通道</span><br><span class="line">ChannelOutBoundInvoker flush(); //刷新</span><br><span class="line">ChannelFuture writeAndFlush(Object msg); //将数据写到ChannelPipeline中当前ChannelHandler的next</span><br></pre></td></tr></table></figure></li></ol><h5 id="ChannelOption"><a href="#ChannelOption" class="headerlink" title="ChannelOption"></a>ChannelOption</h5><ol><li>Netty在创建Channel实例后，一般都需要设置ChannelOption参数。</li><li>ChannelOption参数如下：<ul><li>ChannelOption.SO_BACHLOG：对应TCP&#x2F;IP协议listen函数中的backlog参数，用来初始化服务器可连接队列的大小。服务端处理客户端连接请求是顺序处理的，所以同一时间只能处理一个客户端连接。多个客户端来的时候，服务端将不能处理的客户端连接请求放在队列中等待处理，backlog参数指定了队列的大小。</li><li>ChannelOption.SO_KEEPALIVE：一直保持连接活动状态。</li></ul></li></ol><h5 id="EventLoopGroup和其实现类NioEventLoopGroup"><a href="#EventLoopGroup和其实现类NioEventLoopGroup" class="headerlink" title="EventLoopGroup和其实现类NioEventLoopGroup"></a>EventLoopGroup和其实现类NioEventLoopGroup</h5><ol><li>EventLoopGroup是一组EventLoop的抽象，Netty为了更好的利用多核CPU资源，一般会有多个EventLoop同时工作，每个EventLoop维护着一个Selector实例。</li><li>EventLoopGroup提供next接口，可以从组里面按照一定规则获取其中一个EventLoop来处理任务。在Netty服务端编程中，我们一般都需要提供两个EventLoopGroup，例如：bossEventLoopGroup，workerEventLoopGroup<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/12/07/16388835610980.jpg" alt="16388835610980"></li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Netty&quot;&gt;&lt;a href=&quot;#Netty&quot; class=&quot;headerlink&quot; title=&quot;Netty&quot;&gt;&lt;/a&gt;Netty&lt;/h2&gt;&lt;h3 id=&quot;Netty介绍应用场景&quot;&gt;&lt;a href=&quot;#Netty介绍应用场景&quot; class=&quot;headerlink&quot; title=&quot;Netty介绍应用场景&quot;&gt;&lt;/a&gt;Netty介绍应用场景&lt;/h3&gt;&lt;h4 id=&quot;Netty介绍&quot;&gt;&lt;a href=&quot;#Netty介绍&quot; class=&quot;headerlink&quot; title=&quot;Netty介绍&quot;&gt;&lt;/a&gt;Netty介绍&lt;/h4&gt;&lt;ol&gt;
&lt;li&gt;Netty是Jboss提供的一个开源框架，现为GitHub上的独立项目。&lt;/li&gt;
&lt;li&gt;Netty是异步的、基于事件驱动的网络应用框架，用以快速开发高性能、高可靠性的网络IO程序。&lt;/li&gt;
&lt;li&gt;Netty主要针对在TCP协议下，面向Clients端的高并发应用，或者Peer to Peer场景下的大量数据持续传输的应用。&lt;/li&gt;
&lt;li&gt;Netty本质是NIO框架，适用于服务器通讯相关的多种应用场景。&lt;/li&gt;
&lt;li&gt;要透彻理解Netty，需要先学习NIO，这样我们才能阅读Netty源码。</summary>
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="网络编程" scheme="https://yangh124.github.io/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch</title>
    <link href="https://yangh124.github.io/2021/08/31/ElasticSearch/"/>
    <id>https://yangh124.github.io/2021/08/31/ElasticSearch/</id>
    <published>2021-08-30T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.118Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Elasticsearch是一个基于Lucene的搜索服务器，他提供了一个分布式全文搜索引擎，基于restful web接口。</p><p>Elasticsearch是用Java语言开发的，基于Apache协议的开源项目，是目前最受欢迎的企业搜索引擎。Elasticsearch广泛运用于云计算中，能够达到实时搜索，具有稳定，可靠，快速的特点。</p><span id="more"></span><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Elasticsearch，Kibana，IKAnalyzer中文分词器。版本要一致</p><h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><ol><li>Never Realation（近实时）：Elasticsearch是一个近乎实时的搜索平台，这意味着从索引文档到可搜索文档之间只有轻微的延迟（通常是一秒钟）。</li><li>Cluster（集群）：集群是一个或多个节点的集合，它们一起保存整个数据，并提供所有节点的联合索引和搜索功能。每个集群都有自己的唯一集群名称，节点通过名称加入集群。</li><li>Node（节点）：节点是指属于集群的单个Elasticsearch实例，存储数据并参与集群的索引的搜索功能。可以将节点配置为按集群名称加入特定集群，默认情况下，每个节点都设置为加入一个名为elasticsearch的集群。</li><li><strong>Index（索引）</strong>：索引是一些具有相似特征的文档集合，类似于Mysql中数据库的概念。</li><li><strong>Type（类型）</strong>：类型是索引的逻辑类别分区，通常，为具有一组公共字段的文档类型，类似Mysql中表的概念。（在ES6及之后的版本，一个索引只能包含一个类型，ES7中标记为过时的，ES8中将移除Type）。</li><li><strong>Document（文档）</strong>：文档是可被搜索的基本信息单位，以JSON格式表示，类似于Mysql中的行。</li><li>Shards（分片）：当索引存储大量数据时，可能会超出当个节点的硬件设置，为了解决这个问题，ES提供了将索引细分为分片的概念。分片机制赋予了索引水平扩容的能力、并允许跨分片分发和并行化操作，从而提高性能和吞吐量。</li><li>Replicas（副本）：在可能出现故障的网络的环境中，需要有一个故障切换机制，ES提供了将索引的分片复制为一个或多个副本的功能，副本在某些节点失效的情况下提供高可用性。</li></ol><h2 id="集群状态查看"><a href="#集群状态查看" class="headerlink" title="集群状态查看"></a>集群状态查看</h2><ol><li>查看集群健康状态<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health?v</span><br></pre></td></tr></table></figure></li><li>查看节点状态<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/nodes?v</span><br></pre></td></tr></table></figure></li><li>查看所有索引信息<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices?v</span><br></pre></td></tr></table></figure></li></ol><h2 id="索引操作"><a href="#索引操作" class="headerlink" title="索引操作"></a>索引操作</h2><ol><li>创建索引并查看<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /customer GET /_cat/indices?v</span><br></pre></td></tr></table></figure></li><li>删除索引<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /customer</span><br></pre></td></tr></table></figure></li></ol><h2 id="类型操作"><a href="#类型操作" class="headerlink" title="类型操作"></a>类型操作</h2><ul><li>查看文档的类型<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_mapping</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;bank&quot;: &#123;</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;account&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;account_number&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;address&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;age&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;balance&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;city&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;email&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;employer&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;firstname&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;gender&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;lastname&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;state&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">            &quot;fields&quot;: &#123;</span><br><span class="line">              &quot;keyword&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                &quot;ignore_above&quot;: 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h2><ol start="2"><li>在索引中添加文档<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT /customer/doc/1GET</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;yanghao&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 1,</span><br><span class="line">  &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot;: 3,</span><br><span class="line">  &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>查看索引中的文档<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /customer/doc/1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 2,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;yanghao&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>修改索引中的文档<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/doc/1/_update</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;:&#123;&quot;name&quot;:&quot;yanghao dashuaige&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 2,</span><br><span class="line">  &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot;: 4,</span><br><span class="line">  &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>删除索引中的文档<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /customer/doc/1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 3,</span><br><span class="line">  &quot;result&quot;: &quot;deleted&quot;,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot;: 2,</span><br><span class="line">  &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>对索引中的文档执行批量操作<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/doc/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;xiaohong&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;xiaoming&quot;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 45,</span><br><span class="line">  &quot;errors&quot;: false,</span><br><span class="line">  &quot;items&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot;: &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_version&quot;: 3,</span><br><span class="line">        &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">        &quot;_shards&quot;: &#123;</span><br><span class="line">          &quot;total&quot;: 2,</span><br><span class="line">          &quot;successful&quot;: 1,</span><br><span class="line">          &quot;failed&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_seq_no&quot;: 5,</span><br><span class="line">        &quot;_primary_term&quot;: 1,</span><br><span class="line">        &quot;status&quot;: 200</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot;: &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;customer&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_version&quot;: 1,</span><br><span class="line">        &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">        &quot;_shards&quot;: &#123;</span><br><span class="line">          &quot;total&quot;: 2,</span><br><span class="line">          &quot;successful&quot;: 1,</span><br><span class="line">          &quot;failed&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_seq_no&quot;: 0,</span><br><span class="line">        &quot;_primary_term&quot;: 1,</span><br><span class="line">        &quot;status&quot;: 201</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="数据搜索"><a href="#数据搜索" class="headerlink" title="数据搜索"></a>数据搜索</h2><p>查询表达式（Query DSL）是一种非常灵活又富有表现力的查询语言，ES使用它可以以简单的JSON接口来实现丰富的搜索功能。</p><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><ol><li>首先导入测试数据，数据结构如下&#x2F;<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;account_number&quot;: 0,</span><br><span class="line">    &quot;balance&quot;: 16623,</span><br><span class="line">    &quot;firstname&quot;: &quot;Bradshaw&quot;,</span><br><span class="line">    &quot;lastname&quot;: &quot;Mckenzie&quot;,</span><br><span class="line">    &quot;age&quot;: 29,</span><br><span class="line">    &quot;gender&quot;: &quot;F&quot;,</span><br><span class="line">    &quot;address&quot;: &quot;244 Columbus Place&quot;,</span><br><span class="line">    &quot;employer&quot;: &quot;Euron&quot;,</span><br><span class="line">    &quot;email&quot;: &quot;bradshawmckenzie@euron.com&quot;,</span><br><span class="line">    &quot;city&quot;: &quot;Hobucken&quot;,</span><br><span class="line">    &quot;state&quot;: &quot;CO&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>然后使用批量操作来导入数据（使用Kibana的Dev Tools操作）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /bank/account/_bulk</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index&quot;: &#123;</span><br><span class="line">    &quot;_id&quot;: &quot;1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;account_number&quot;: 1,</span><br><span class="line">  &quot;balance&quot;: 39225,</span><br><span class="line">  &quot;firstname&quot;: &quot;Amber&quot;,</span><br><span class="line">  &quot;lastname&quot;: &quot;Duke&quot;,</span><br><span class="line">  &quot;age&quot;: 32,</span><br><span class="line">  &quot;gender&quot;: &quot;M&quot;,</span><br><span class="line">  &quot;address&quot;: &quot;880 Holmes Lane&quot;,</span><br><span class="line">  &quot;employer&quot;: &quot;Pyrami&quot;,</span><br><span class="line">  &quot;email&quot;: &quot;amberduke@pyrami.com&quot;,</span><br><span class="line">  &quot;city&quot;: &quot;Brogan&quot;,</span><br><span class="line">  &quot;state&quot;: &quot;IL&quot;</span><br><span class="line">&#125;</span><br><span class="line">......省略若干条数据</span><br></pre></td></tr></table></figure></li><li>导入完成查看索引信息，可以发现bank索引中已经创建了1000条文档</li></ol><h3 id="搜索入门"><a href="#搜索入门" class="headerlink" title="搜索入门"></a>搜索入门</h3><ol><li>最简单的搜索<br><code>GET /bank/_search &#123;  &quot;query&quot;:&#123; &quot;match_all&quot;:&#123;&#125; &#125; &#125;</code></li><li>分页搜索<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123; &quot;match_all&quot;:&#123;&#125; &#125;,</span><br><span class="line">    &quot;from&quot;:0,</span><br><span class="line">    &quot;size&quot;:10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>搜索排序，使用sort<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123; &quot;match_all&quot;:&#123;&#125; &#125;,</span><br><span class="line">    &quot;sort&quot;:&#123;&quot;balance&quot;:&#123;&quot;order&quot;:&quot;desc&quot;&#125;&#125; #按照balance字段降序</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>搜索并返回指定字段内容，使用_source 表示<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123; &quot;match_all&quot;:&#123;&#125; &#125;,</span><br><span class="line">    &quot;_source&quot;:[&quot;account_number&quot;,&quot;balance&quot;] #只返回account_number，balance字段</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="条件搜索"><a href="#条件搜索" class="headerlink" title="条件搜索"></a>条件搜索</h3><ol><li><p>条件搜索，使用match表示匹配条件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;account_number&quot;:20</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>文本类型字段的条件搜索，对比上一条可以发现，对于数字类型的字段进行的是精确匹配，而对于文本使用的是模糊匹配</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;mill&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: [</span><br><span class="line">    &quot;address&quot;,</span><br><span class="line">    &quot;account_number&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>短语匹配搜索，使用match_phrase</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;mill lane&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>组合搜索</strong></p></li><li><p>组合搜索，使用bool来进行组合，must表示必须同时满足</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">      #同时包含mill lane</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;lane&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>组合搜索，使用should，表示只要满足其中一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;lane&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>组合搜索，must_not表示必须同时不满足</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;mill&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;address&quot;: &quot;lane&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>组合搜索，组合must和must_not</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;age&quot;: &quot;40&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;state&quot;: &quot;ID&quot; &#125; &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="搜索聚合"><a href="#搜索聚合" class="headerlink" title="搜索聚合"></a>搜索聚合</h3><ol><li>对搜索结果进行聚合，使用aggs表示，类似于Mysql中的group by ，例如对state字段进行聚合，统计出不同state的文档数量。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;:0,</span><br><span class="line">    &quot;aggs&quot;:&#123;</span><br><span class="line">        &quot;group_by_state&quot;:&#123;</span><br><span class="line">            &quot;terms&quot;:&#123;</span><br><span class="line">                &quot;field&quot;:&quot;state.keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>嵌套聚合，例如对state进行聚合，统计出不同state的文档数量，再统计出blance的平均值。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_age&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;avg_blance&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>对聚合结果进行排序，例如按balance的平均值降序排序<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_state&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;state.keyword&quot;,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;average_balance&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;average_balance&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>按字段的范围进行分段聚合，例如分段范围为age字段的[20,30] [30,40] [40,50]，之后按gender统计文档个数和balance的平均值。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 0,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;group_by_age&quot;: &#123;</span><br><span class="line">            &quot;range&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">                &quot;ranges&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;from&quot;: 20,</span><br><span class="line">                        &quot;to&quot;: 30</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;from&quot;: 30,</span><br><span class="line">                        &quot;to&quot;: 40</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;from&quot;: 40,</span><br><span class="line">                        &quot;to&quot;: 50</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;aggs&quot;: &#123;</span><br><span class="line">                &quot;group_by_gender&quot;: &#123;</span><br><span class="line">                    &quot;terms&quot;: &#123;</span><br><span class="line">                        &quot;field&quot;: &quot;gender.keyword&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &quot;aggs&quot;: &#123;</span><br><span class="line">                        &quot;average_balance&quot;: &#123;</span><br><span class="line">                            &quot;avg&quot;: &#123;</span><br><span class="line">                                &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Spring-Boot整合ElasticSearch"><a href="#Spring-Boot整合ElasticSearch" class="headerlink" title="Spring Boot整合ElasticSearch"></a>Spring Boot整合ElasticSearch</h2><p>使用ElasticSearch-Rest-Client对elasticsearch进行操作</p><p>引入依赖：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;7.9.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>因为SpringBoot管理了elasticsearch的依赖版本，所以我们需要指定一下elasticsearch的版本与其一致：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;  </span><br><span class="line">    &lt;elasticsearch.version&gt;7.9.0&lt;/elasticsearch.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure><p>然后编写一个配置类，向容器中注册一个操作elasticsearch的组件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/8/30 20:35</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">@ConfigurationProperties(prefix = &quot;elasticsearch&quot;)</span><br><span class="line">public class EsHostConfig &#123;</span><br><span class="line"></span><br><span class="line">    private String[] hostArr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 定义RestClient Bean</span><br><span class="line"> *</span><br><span class="line"> * @author : yh</span><br><span class="line"> * @date : 2021/8/30 20:32</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class EsRestClientConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private EsHostConfig esHostConfig;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public RestHighLevelClient restHighLevelClient() &#123;</span><br><span class="line">        String[] hostArr = esHostConfig.getHostArr();</span><br><span class="line">        int size = hostArr.length;</span><br><span class="line">        HttpHost[] httpHostArr = new HttpHost[size];</span><br><span class="line">        for (int i = 0; i &lt; size; i++) &#123;</span><br><span class="line">            String[] split = hostArr[i].split(&quot;:&quot;);</span><br><span class="line">            httpHostArr[i] = new HttpHost(split[0], Integer.parseInt(split[1]), &quot;http&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return new RestHighLevelClient(RestClient.builder(httpHostArr));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接下来我们就可以通过它操作 elasticsearch 了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">private RestHighLevelClient client;</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">class User &#123;</span><br><span class="line">    private String name;    </span><br><span class="line">    private Integer age;    </span><br><span class="line">    private String gender;</span><br><span class="line">&#125;</span><br><span class="line">@Test</span><br><span class="line">public void index() throws IOException &#123;    </span><br><span class="line">    IndexRequest indexRequest = new IndexRequest(&quot;users&quot;);    </span><br><span class="line">    indexRequest.id(&quot;1&quot;);    </span><br><span class="line">    // indexRequest.source(&quot;name&quot;,&quot;zhangsan&quot;,&quot;age&quot;,20,&quot;gender&quot;,&quot;男&quot;);    </span><br><span class="line">    User user = new User();    </span><br><span class="line">    user.setName(&quot;zhangsan&quot;);    </span><br><span class="line">    user.setAge(20);    </span><br><span class="line">    user.setGender(&quot;男&quot;);    </span><br><span class="line">    String json = JSON.toJSONString(user);    </span><br><span class="line">    indexRequest.source(json, XContentType.JSON);    </span><br><span class="line">    // 执行保存操作    </span><br><span class="line">    IndexResponse index = client.index(indexRequest, RequestOptions.DEFAULT);    </span><br><span class="line">    // 响应数据    </span><br><span class="line">    System.out.println(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RestHighLevelClient提供了非常多的方式用于保存数据，但比较常用的是通过json数据直接保存，首先需要指定索引， IndexRequest indexRequest &#x3D; new IndexRequest(&quot;users&quot;); 指定了users索引，然后指定数据id，接着指定数据值，最后使用client执行保存操作，然后可以拿到响应数据。</p><p>elasticsearch的其它简单操作，诸如：更新、删除等，都只需要转换一下调用方法即可，如更新操作，就需要使用client调用update方法，接下来我们看看Java程序该如何实现较为复杂的检索操作。</p><p>比如现在想聚合出年龄的分布情况，并求出每个年龄分布人群的平均薪资，就应该这样进行编写：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">    public void aggSearch() throws Exception &#123;</span><br><span class="line">        //创建搜索request</span><br><span class="line">        SearchRequest searchRequest = new SearchRequest(&quot;bank&quot;);</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();</span><br><span class="line">        //查询条件</span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">        //统计各个年龄的平均工资</span><br><span class="line">        searchSourceBuilder.aggregation(AggregationBuilders.terms(&quot;ageAgg&quot;).field(&quot;age&quot;).subAggregation(AggregationBuilders.avg(&quot;balanceAvgAgg&quot;).field(&quot;balance&quot;)));</span><br><span class="line">        //所有人平均工资</span><br><span class="line">        searchSourceBuilder.aggregation(AggregationBuilders.avg(&quot;allBalanceAvgAgg&quot;).field(&quot;balance&quot;));</span><br><span class="line">        //构建request</span><br><span class="line">        SearchRequest request = searchRequest.source(searchSourceBuilder);</span><br><span class="line">        //search</span><br><span class="line">        SearchResponse searchResponse = restHighLevelClient.search(request, RequestOptions.DEFAULT);</span><br><span class="line">        //Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        //Aggregation接口有很多实现类  Avg（平均值）</span><br><span class="line">//        Avg avg = aggregations.get(&quot;balanceAgg&quot;);</span><br><span class="line">//        System.out.println(avg.getValue());</span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        Terms ageAgg = aggregations.get(&quot;ageAgg&quot;);</span><br><span class="line">        List&lt;? extends Terms.Bucket&gt; buckets = ageAgg.getBuckets();</span><br><span class="line">        for (Terms.Bucket bucket : buckets) &#123;//只查出了10条数据</span><br><span class="line">            System.out.println(&quot;年龄:&quot; + bucket.getKey());</span><br><span class="line">            System.out.println(&quot;人数:&quot; + bucket.getDocCount());</span><br><span class="line">            Avg avg = bucket.getAggregations().get(&quot;balanceAvgAgg&quot;);</span><br><span class="line">            System.out.println(&quot;平均工资:&quot; + avg.getValue());</span><br><span class="line">            System.out.println(&quot;=================================&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Avg avg = aggregations.get(&quot;allBalanceAvgAgg&quot;);</span><br><span class="line">        System.out.println(&quot;所有人平均工资:&quot; + avg.getValue());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>最终输出结果<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">年龄:31</span><br><span class="line">人数:61</span><br><span class="line">平均工资:28312.918032786885</span><br><span class="line">=================================</span><br><span class="line">年龄:39</span><br><span class="line">人数:60</span><br><span class="line">平均工资:25269.583333333332</span><br><span class="line">=================================</span><br><span class="line">年龄:26</span><br><span class="line">人数:59</span><br><span class="line">平均工资:23194.813559322032</span><br><span class="line">=================================</span><br><span class="line">年龄:32</span><br><span class="line">人数:52</span><br><span class="line">平均工资:23951.346153846152</span><br><span class="line">=================================</span><br><span class="line">年龄:35</span><br><span class="line">人数:52</span><br><span class="line">平均工资:22136.69230769231</span><br><span class="line">=================================</span><br><span class="line">年龄:36</span><br><span class="line">人数:52</span><br><span class="line">平均工资:22174.71153846154</span><br><span class="line">=================================</span><br><span class="line">年龄:22</span><br><span class="line">人数:51</span><br><span class="line">平均工资:24731.07843137255</span><br><span class="line">=================================</span><br><span class="line">年龄:28</span><br><span class="line">人数:51</span><br><span class="line">平均工资:28273.882352941175</span><br><span class="line">=================================</span><br><span class="line">年龄:33</span><br><span class="line">人数:50</span><br><span class="line">平均工资:25093.94</span><br><span class="line">=================================</span><br><span class="line">年龄:34</span><br><span class="line">人数:49</span><br><span class="line">平均工资:26809.95918367347</span><br><span class="line">=================================</span><br><span class="line">所有人平均工资:25714.837</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;Elasticsearch是一个基于Lucene的搜索服务器，他提供了一个分布式全文搜索引擎，基于restful web接口。&lt;/p&gt;
&lt;p&gt;Elasticsearch是用Java语言开发的，基于Apache协议的开源项目，是目前最受欢迎的企业搜索引擎。Elasticsearch广泛运用于云计算中，能够达到实时搜索，具有稳定，可靠，快速的特点。&lt;/p&gt;</summary>
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="elastic search" scheme="https://yangh124.github.io/tags/elastic-search/"/>
    
  </entry>
  
  <entry>
    <title>Dubbo</title>
    <link href="https://yangh124.github.io/2021/08/03/Dubbo/"/>
    <id>https://yangh124.github.io/2021/08/03/Dubbo/</id>
    <published>2021-08-02T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.117Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="分布式基础理论"><a href="#分布式基础理论" class="headerlink" title="分布式基础理论"></a>分布式基础理论</h3><h4 id="什么是分布式系统"><a href="#什么是分布式系统" class="headerlink" title="什么是分布式系统"></a>什么是分布式系统</h4><p>《分布式系统原理和与范例》定义：分布式系统是若干个独立计算机的集合，这些计算机对于用户来说就像单个相关系统。分布式系统（distributed system）是建立在网络之上的软件系统。</p><p>随着互联网的发展，网络应用的规模不断扩大，常规的垂直架构已无法应对，分布式服务架构以及流动计算机架构势在必行，急需一个治理系统确保架构有条不紊的演进。</p><h4 id="发展演变"><a href="#发展演变" class="headerlink" title="发展演变"></a>发展演变</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/03/16279957380049.jpg"></p><h4 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h4><h5 id="什么是RPC"><a href="#什么是RPC" class="headerlink" title="什么是RPC"></a>什么是RPC</h5><p>RPC（remote procedure call）是指远程过程调用，是一种进程间通信方式，它是一种技术的思想，而不是规范。它允许程序调用另一个地址空间（通常是共享网络的另一台机器上）的过程或函数，而不用显示的编码这个远程调用的细节。即程序员无论是调用本地的还是远程的函数，本质上编写的代码基本相同。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/03/16279967265162.jpg"></p><p>一次完整的RPC调用流程（同步调用，异步另说）如下：<br>    1. 服务消费者（client）调用以本地调用方式调用服务；<br>    2. client stub接收到调用后负责将方法、参数等组装成能够进行网络传输的消息体；<br>    3. client stub找到消息服务地址，并将消息发送到服务端；<br>    4. server stub找到消息后进行解码；<br>    5. server stub根据解码结果调用本地服务；<br>    6. 本地服务执行并将结果返回给server stub；<br>    7. server stub将返回结果打包成消息并发送至消费方；<br>    8. client stub接收消息，并进行解码；<br>    9. 服务消费方得到最终结果。<br>RPC框架的目的就是将2～8这些步骤都封装起来，这些细节对用户来说是不可见的。</p><h3 id="netty通信原理"><a href="#netty通信原理" class="headerlink" title="netty通信原理"></a>netty通信原理</h3><p>Netty是一个异步事件驱动的网络应用程序框架。用于快速开发可维护的高性能协议服务器和客户端。它极大的简化了TCP和UDP套接字服务器等网络编程。</p><ul><li>BIO<br>  <img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/11/16286904434850.jpg"></li><li>NIO（Non-Blocking IO）<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/11/16286910957505.jpg" alt="16286910957505"><br>  Selector一般称为选择器，也可以翻译为多路复用器；<br>  Connect（连接就绪）、Accept（接受就绪）、Read（读就绪）、Write（写就绪）</li></ul><h3 id="Netty基本原理"><a href="#Netty基本原理" class="headerlink" title="Netty基本原理"></a>Netty基本原理</h3><h3 id="Dubbo原理"><a href="#Dubbo原理" class="headerlink" title="Dubbo原理"></a>Dubbo原理</h3><h4 id="框架设计"><a href="#框架设计" class="headerlink" title="框架设计"></a>框架设计</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291190919038.jpg" alt="16291190919038"></p><h4 id="启动解析、加载配置"><a href="#启动解析、加载配置" class="headerlink" title="启动解析、加载配置"></a>启动解析、加载配置</h4><h4 id="服务暴露"><a href="#服务暴露" class="headerlink" title="服务暴露"></a>服务暴露</h4><h4 id="服务引用"><a href="#服务引用" class="headerlink" title="服务引用"></a>服务引用</h4><h4 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h4>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基础知识&quot;&gt;&lt;a href=&quot;#基础知识&quot; class=&quot;headerlink&quot; title=&quot;基础知识&quot;&gt;&lt;/a&gt;基础知识&lt;/h2&gt;&lt;h3 id=&quot;分布式基础理论&quot;&gt;&lt;a href=&quot;#分布式基础理论&quot; class=&quot;headerlink&quot; title=&quot;分布式</summary>
      
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="微服务" scheme="https://yangh124.github.io/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>Docker常用命令</title>
    <link href="https://yangh124.github.io/2021/07/31/Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>https://yangh124.github.io/2021/07/31/Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</id>
    <published>2021-07-30T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.116Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Docker简介"><a href="#Docker简介" class="headerlink" title="Docker简介"></a>Docker简介</h2><pre><code>Docker是一个开源的应用容器引擎，让开发者可以打包应用及依赖包到一个可移植的镜像中，然后发布到任何流行的Linux或Windows机器上。使用Docker可以更方便地打包、测试以及部署应用程序。</code></pre><span id="more"></span><h2 id="Docker环境安装（Linux）"><a href="#Docker环境安装（Linux）" class="headerlink" title="Docker环境安装（Linux）"></a>Docker环境安装（Linux）</h2><h3 id="1-安装yum-utils；"><a href="#1-安装yum-utils；" class="headerlink" title="1. 安装yum-utils；"></a>1. 安装yum-utils；</h3><pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2</code></pre><h3 id="2-为yum源添加docker仓库位置；"><a href="#2-为yum源添加docker仓库位置；" class="headerlink" title="2. 为yum源添加docker仓库位置；"></a>2. 为yum源添加docker仓库位置；</h3><pre><code>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</code></pre><h3 id="3-安装dokcer服务；"><a href="#3-安装dokcer服务；" class="headerlink" title="3. 安装dokcer服务；"></a>3. 安装dokcer服务；</h3><pre><code>yum install docker-ce</code></pre><h3 id="4-启动docker服务；"><a href="#4-启动docker服务；" class="headerlink" title="4. 启动docker服务；"></a>4. 启动docker服务；</h3><pre><code>systemctl start docker</code></pre><h2 id="Docker常用镜像命令"><a href="#Docker常用镜像命令" class="headerlink" title="Docker常用镜像命令"></a>Docker常用镜像命令</h2><h3 id="搜索镜像"><a href="#搜索镜像" class="headerlink" title="搜索镜像"></a>搜索镜像</h3><pre><code>docker search xxx</code></pre><h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><pre><code>dockr pull xxx</code></pre><h3 id="查看镜像版本"><a href="#查看镜像版本" class="headerlink" title="查看镜像版本"></a>查看镜像版本</h3><pre><code>由于docker search命令只能查找出是否有该镜像，不能找到该镜像支持的版本，所以我们需要通过Docker Hub来搜索支持的版本。进入Docker Hub的官网，地址：[https://hub.docker.com](https://hub.docker.com/)</code></pre><h3 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h3><p>docker images</p><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><h4 id="1-指定名称删除镜像"><a href="#1-指定名称删除镜像" class="headerlink" title="1. 指定名称删除镜像"></a>1. 指定名称删除镜像</h4><pre><code>docker rmi java:8.0</code></pre><h4 id="2-指定名称强制删除镜像"><a href="#2-指定名称强制删除镜像" class="headerlink" title="2. 指定名称强制删除镜像"></a>2. 指定名称强制删除镜像</h4><pre><code>docker rmi -f java:8.0</code></pre><h4 id="3-删除所有没有引用的镜像"><a href="#3-删除所有没有引用的镜像" class="headerlink" title="3. 删除所有没有引用的镜像"></a>3. 删除所有没有引用的镜像</h4><pre><code>docker rmi `docker images | grep none | awk  &#39;&#123;print $3&#125;&#39;`</code></pre><h4 id="4-强制删除所有镜像"><a href="#4-强制删除所有镜像" class="headerlink" title="4. 强制删除所有镜像"></a>4. 强制删除所有镜像</h4><pre><code>docker rmi -f $(docker images)</code></pre><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><pre><code>-t 表示指定镜像仓库名称/镜像名称:镜像标签 .表示使用当前目录下的Dockerfile文件 docker build -t yh124/test-porject:1.0-SNAPSHOT .</code></pre><h2 id="Docker容器常用命令"><a href="#Docker容器常用命令" class="headerlink" title="Docker容器常用命令"></a>Docker容器常用命令</h2><h3 id="新建并启动容器"><a href="#新建并启动容器" class="headerlink" title="新建并启动容器"></a>新建并启动容器</h3><pre><code>docker run -p 80:80 --name nginx \ -e TZ=&quot;Asia/Shanghai&quot; \ -v /mydata/nginx/html:/usr/share/nginx/html \ -d nginx:1.17.01. -p：将宿主机和容器端口进行映射，格式为：宿主机端口:容器端口。2. --name：自定义容器名称，之后可以通过容器名称进行操作。3. -e：设置容器的环境变量，这里设置的时区。4. -v：将宿主机的文件挂载到容器中，格式为：宿主机文件目录:容器文件目录。5. -d：表示容器以后台方式运行</code></pre><h3 id="列出容器"><a href="#列出容器" class="headerlink" title="列出容器"></a>列出容器</h3><h4 id="1-列出运行中的所有容器"><a href="#1-列出运行中的所有容器" class="headerlink" title="1. 列出运行中的所有容器"></a>1. 列出运行中的所有容器</h4><pre><code>docker ps</code></pre><h4 id="2-列出所有容器"><a href="#2-列出所有容器" class="headerlink" title="2. 列出所有容器"></a>2. 列出所有容器</h4><pre><code>docker ps -a</code></pre><h3 id="停止容器"><a href="#停止容器" class="headerlink" title="停止容器"></a>停止容器</h3><pre><code>docker stop \$containerName(or \$containerID)</code></pre><h3 id="强制停止容器"><a href="#强制停止容器" class="headerlink" title="强制停止容器"></a>强制停止容器</h3><pre><code>docker kill xxx</code></pre><h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><pre><code>docker start xxx</code></pre><h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><h4 id="1-先查出容器pid"><a href="#1-先查出容器pid" class="headerlink" title="1. 先查出容器pid"></a>1. 先查出容器pid</h4><pre><code>docker inspect --format &quot;&#123;&#123;.State.Pid&#125;&#125;&quot; $ContainerName</code></pre><h4 id="2-根据容器pid进入容器"><a href="#2-根据容器pid进入容器" class="headerlink" title="2. 根据容器pid进入容器"></a>2. 根据容器pid进入容器</h4><pre><code>nsenter --target &quot;$pid&quot; --mount --uts --ipc --net --pid</code></pre><h3 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h3><h4 id="1-删除指定容器"><a href="#1-删除指定容器" class="headerlink" title="1. 删除指定容器"></a>1. 删除指定容器</h4><pre><code>docker rm $ContainerName</code></pre><h4 id="2-按名称通配符删除容器，比如删除以名称test-开头的容器"><a href="#2-按名称通配符删除容器，比如删除以名称test-开头的容器" class="headerlink" title="2. 按名称通配符删除容器，比如删除以名称test-开头的容器"></a>2. 按名称通配符删除容器，比如删除以名称test-开头的容器</h4><pre><code>docker rm &#39;docker ps -a | grep test-* | awk &#123;print $1&#125;&#39;</code></pre><h4 id="3-强制删除所有容器"><a href="#3-强制删除所有容器" class="headerlink" title="3. 强制删除所有容器"></a>3. 强制删除所有容器</h4><pre><code>docker rm -f $(docker ps -a -q)</code></pre><h3 id="查看容器日志"><a href="#查看容器日志" class="headerlink" title="查看容器日志"></a>查看容器日志</h3><h4 id="1-查看容器产生的全部日志"><a href="#1-查看容器产生的全部日志" class="headerlink" title="1. 查看容器产生的全部日志"></a>1. 查看容器产生的全部日志</h4><pre><code>docker logs $ContainerName</code></pre><h4 id="2-动态查看日志"><a href="#2-动态查看日志" class="headerlink" title="2. 动态查看日志"></a>2. 动态查看日志</h4><pre><code>docker logs -f -t --tail=100 $ContainerName</code></pre><h3 id="查看容器的IP地址"><a href="#查看容器的IP地址" class="headerlink" title="查看容器的IP地址"></a>查看容器的IP地址</h3><pre><code>docker inspect --format &#39;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#39; $ContainerName</code></pre><h3 id="修改容器的启动方式"><a href="#修改容器的启动方式" class="headerlink" title="修改容器的启动方式"></a>修改容器的启动方式</h3><h4 id="1-将容器启动方式改为always"><a href="#1-将容器启动方式改为always" class="headerlink" title="1. 将容器启动方式改为always"></a>1. 将容器启动方式改为always</h4><pre><code>    docker container update --restart=always $ContainerName </code></pre><h4 id="2-关闭自动重启"><a href="#2-关闭自动重启" class="headerlink" title="2. 关闭自动重启"></a>2. 关闭自动重启</h4><pre><code>    docker container update --restart=no $ContainerName</code></pre><h3 id="同步宿主机时间到容器"><a href="#同步宿主机时间到容器" class="headerlink" title="同步宿主机时间到容器"></a>同步宿主机时间到容器</h3><pre><code>docker cp /etc/localtime $ContainerName:/etc</code></pre><h3 id="指定容器时区"><a href="#指定容器时区" class="headerlink" title="指定容器时区"></a>指定容器时区</h3><pre><code>docker run -p 80:80 --name nginx \ -e TZ=&quot;Asia/Shanghai&quot; \ -d nginx:1.17.0</code></pre><h3 id="查看容器资源占用状况"><a href="#查看容器资源占用状况" class="headerlink" title="查看容器资源占用状况"></a>查看容器资源占用状况</h3><h4 id="1-查看指定容器资源占用状况，比如cpu，网络，内存，IO状态"><a href="#1-查看指定容器资源占用状况，比如cpu，网络，内存，IO状态" class="headerlink" title="1. 查看指定容器资源占用状况，比如cpu，网络，内存，IO状态"></a>1. 查看指定容器资源占用状况，比如cpu，网络，内存，IO状态</h4><pre><code>docker stats $ContainerName</code></pre><h4 id="2-查看所有容器医院占用情况"><a href="#2-查看所有容器医院占用情况" class="headerlink" title="2. 查看所有容器医院占用情况"></a>2. 查看所有容器医院占用情况</h4><pre><code>docker stats -a</code></pre><h3 id="查看磁盘使用情况"><a href="#查看磁盘使用情况" class="headerlink" title="查看磁盘使用情况"></a>查看磁盘使用情况</h3><pre><code>docker system df</code></pre><h3 id="执行容器内部命令（进入容器）"><a href="#执行容器内部命令（进入容器）" class="headerlink" title="执行容器内部命令（进入容器）"></a>执行容器内部命令（进入容器）</h3><pre><code>docker exec -it $ContainerName /bin/bash</code></pre><h3 id="指定账号进入容器内部"><a href="#指定账号进入容器内部" class="headerlink" title="指定账号进入容器内部"></a>指定账号进入容器内部</h3><pre><code>使用root账号进入容器内部 docker exec -it --user root $ContainerName /bin/bash</code></pre><h3 id="查看所有网络"><a href="#查看所有网络" class="headerlink" title="查看所有网络"></a>查看所有网络</h3><pre><code>docker network ls</code></pre><h3 id="创建外部网络"><a href="#创建外部网络" class="headerlink" title="创建外部网络"></a>创建外部网络</h3><pre><code>docker network create -d bridge my-bridge-network</code></pre><h3 id="指定容器网络"><a href="#指定容器网络" class="headerlink" title="指定容器网络"></a>指定容器网络</h3><pre><code>docker run -p 80:80 --name nginx \ --network my-bridge-network \ -d nginx:1.17.0</code></pre><h3 id="修改镜像的存放位置"><a href="#修改镜像的存放位置" class="headerlink" title="修改镜像的存放位置"></a>修改镜像的存放位置</h3><h4 id="1-查看镜像的存放位置"><a href="#1-查看镜像的存放位置" class="headerlink" title="1. 查看镜像的存放位置"></a>1. 查看镜像的存放位置</h4><pre><code>docker info | grep &quot;Docker Root Dir&quot;</code></pre><h4 id="2-关闭docker-服务"><a href="#2-关闭docker-服务" class="headerlink" title="2. 关闭docker 服务"></a>2. 关闭docker 服务</h4><pre><code>systemctl stop docker</code></pre><h4 id="3-先将原镜像目录移动到目标目录"><a href="#3-先将原镜像目录移动到目标目录" class="headerlink" title="3. 先将原镜像目录移动到目标目录"></a>3. 先将原镜像目录移动到目标目录</h4><pre><code>mv /var/lib/docker /mydata/docker</code></pre><h4 id="4-建立软连接"><a href="#4-建立软连接" class="headerlink" title="4. 建立软连接"></a>4. 建立软连接</h4><pre><code>ln -s /mydata/docker /var/lib/docker</code></pre><h3 id="Docker容器清理"><a href="#Docker容器清理" class="headerlink" title="Docker容器清理"></a>Docker容器清理</h3><h4 id="1-查看Docker占用磁盘空间"><a href="#1-查看Docker占用磁盘空间" class="headerlink" title="1. 查看Docker占用磁盘空间"></a>1. 查看Docker占用磁盘空间</h4><pre><code>docker system df</code></pre><h4 id="2-删除所有关闭的容器"><a href="#2-删除所有关闭的容器" class="headerlink" title="2. 删除所有关闭的容器"></a>2. 删除所有关闭的容器</h4><pre><code>docker ps -a | grep Exit | cut -d &#39; &#39; -f 1 | xargs docker rm</code></pre><h4 id="3-删除所有dangling镜像（没有Tag的镜像）"><a href="#3-删除所有dangling镜像（没有Tag的镜像）" class="headerlink" title="3. 删除所有dangling镜像（没有Tag的镜像）"></a>3. 删除所有dangling镜像（没有Tag的镜像）</h4><pre><code>docker rmi $(docker images | grep &quot;^&lt;none&gt;&quot; | awk &quot;&#123;print $3&#125;&quot;)</code></pre><h4 id="4-删除所有dangling-数据卷（即无用的volume）"><a href="#4-删除所有dangling-数据卷（即无用的volume）" class="headerlink" title="4. 删除所有dangling 数据卷（即无用的volume）"></a>4. 删除所有dangling 数据卷（即无用的volume）</h4><pre><code>docker volume rm $(docker volume ls -qf dangling=true)</code></pre><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="构建、创建、启动相关容器"><a href="#构建、创建、启动相关容器" class="headerlink" title="构建、创建、启动相关容器"></a>构建、创建、启动相关容器</h4><pre><code>docker-compose up -d #指定yaml文件 -f 指定文件(file) -d 后台运行 docker-compose -f docker-compose.yml up -d</code></pre><h4 id="停止所有相关容器"><a href="#停止所有相关容器" class="headerlink" title="停止所有相关容器"></a>停止所有相关容器</h4><pre><code>docker-compose stop</code></pre><h4 id="列出所有容器信息"><a href="#列出所有容器信息" class="headerlink" title="列出所有容器信息"></a>列出所有容器信息</h4><pre><code>docker-compose ps</code></pre>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Docker简介&quot;&gt;&lt;a href=&quot;#Docker简介&quot; class=&quot;headerlink&quot; title=&quot;Docker简介&quot;&gt;&lt;/a&gt;Docker简介&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;Docker是一个开源的应用容器引擎，让开发者可以打包应用及依赖包到一个可移植的镜像中，然后发布到任何流行的Linux或Windows机器上。使用Docker可以更方便地打包、测试以及部署应用程序。
&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="运维" scheme="https://yangh124.github.io/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="Docker" scheme="https://yangh124.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>MySQL</title>
    <link href="https://yangh124.github.io/2021/07/31/MySQL/"/>
    <id>https://yangh124.github.io/2021/07/31/MySQL/</id>
    <published>2021-07-30T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.121Z</updated>
    
    <content type="html"><![CDATA[<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><pre><code>一个数据库事务通常包含对数据库进行读或写的一个操作序列。它的存在包含有以下两个目的：    1. 为数据库操作提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态下仍能保持一致性的方法。    2. 当多个应用程序在并发访问数据库时，可以在这些应用程序之间提供一个隔离方法，以防止彼此的操作互相干扰。</code></pre><span id="more"></span><h3 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h3><ul><li>原子性（Atomicity）：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。</li><li>一致性（Consistency）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。</li><li>隔离性（Isolation）：多个事务并发执行时，一个事务的执行不应影响其他事务的执行。</li><li>持久性（Durability）：一个事务一旦提交，他对数据库的修改应该永久保存在数据库中。</li></ul><h3 id="数据库的读现象浅析"><a href="#数据库的读现象浅析" class="headerlink" title="数据库的读现象浅析"></a>数据库的读现象浅析</h3><pre><code>&quot;读现象&quot;是多个事务并发执行时，在读取数据方面可能碰到的状况。</code></pre><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278197683280.jpg"></p><h4 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h4><p>脏读又称无效数据的读出，是指在数据库访问中，事务T1将某一值修改，然后事务T2读取该值，此后T1因为某种原因撤销对该值的修改，这就导致了T2所读取到的数据是无效的。</p><p>事务一读取到事务二未提交数据。</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278197917060.jpg"></p><h4 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h4><p>在一个事务内，多次读同一个数据。在这个事务还没有结束时，另一个事务也访问该同一数据。那么，在第一个事务的两次读数据之间。由于第二个事务的修改，那么第一个事务读到的数据可能不一样，这样就发生了在一个事务内两次读到的数据是不一样的，因此称为不可重复读，即原始读取不可重复。</p><p>在事务二提交之前，事务一不可重复读。</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278198089221.jpg"></p><h4 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a>幻读</h4><p>第一个事务对一个表中的数据进行了修改，比如这种修改涉及到表中的”全部数据行”。同时，第二个事务也修改这个表中的数据，这种修改是向表中插入”一行新数据”。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象发生了幻觉一样.一般解决幻读的方法是增加范围锁RangeS，锁定检锁范围为只读，这样就避免了幻读。</p><p>返回数据变多，幻读。</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278198223940.jpg"></p><p>“幻读(phantom read)”是不可重复读(Non-repeatablereads)的一种特殊场景：当事务没有获取范围锁的情况下执行SELECT ... WHERE操作可能会发生”幻影读(phantom read)”。</p><h2 id="Mysql中的行级锁、表级锁、页级锁"><a href="#Mysql中的行级锁、表级锁、页级锁" class="headerlink" title="Mysql中的行级锁、表级锁、页级锁"></a>Mysql中的行级锁、表级锁、页级锁</h2><h3 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h3><p>行级锁是Mysql中锁粒度最细的锁，表示只针对当前操作的行为加锁。行级锁能大大减少数据库操作的冲突。其加锁粒度最小，但加锁的开销也最大。行级锁分为共享锁和排他锁。</p><p>特点：开销大，加锁慢；会出现死锁；锁粒度最小，发生锁冲突的概率最低，并发度也最高。</p><p>Innodb默认使用行级锁</p><ul><li>读锁（read lock）：也叫共享锁（shared lock），允许一个事务去读一行，阻止其他事务获得相同数据集的排他锁</li><li>写锁（write lock）：也叫排他锁（exclusive lock），允许获得排他锁的事务更新数据，阻止其他事务取得相同数据集的共享锁和排他锁</li></ul><h4 id="行锁的实现算法"><a href="#行锁的实现算法" class="headerlink" title="行锁的实现算法"></a>行锁的实现算法</h4><ol><li><p><strong>Record Lock 锁</strong></p><p>单个行记录上的锁Record<br>Lock总是会去锁住索引记录，如果InnoDB存储引擎表建立的时候没有设置任何一个索引，这时InnoDB存储引擎会使用隐式的主键来进行锁定</p></li><li><p><strong>Gap Lock 锁</strong></p><p> 当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引加锁，对于键值在条件范围内但并不存在的记录。<br> 优点：解决了事务并发的幻读问题不足：因为query执行过程中通过范围查找的话，他会锁定争个范围内所有的索引键值，即使这个键值并不存在。<br> 间隙锁有一个致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成锁定的时候无法插入锁定键值范围内任何数据。在某些场景下这可能会对性能造成很大的危害。</p></li><li><p><strong>Next-key Lock 锁</strong></p><p> 同时锁住数据+间隙锁(1+2),在Repeatable Read隔离级别下，Next-key Lock</p></li></ol><p>算法是默认的行记录锁定算法。</p><h3 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h3><p>表级锁是MySQL中锁定粒度最大的一种锁，表示对当前操作的整张表加锁，它实现简单，资源消耗较少，被大部分MySQL引擎支持。最常使用的MYISAM与INNODB都支持表级锁定。表级锁定分为<strong>表共享读锁（共享锁）</strong>与<strong>表独占写锁（排他锁）</strong>。</p><p>特点：开销小，加锁快；不会出现死锁；锁定粒度大，发出锁冲突的概率最高，并发度最低。</p><p>MyISAM默认使用表级锁</p><ul><li><p>读锁（read lock），也叫共享锁（shared lock）针对同一份数据，多个读操作可以同时进行而不会互相影响（select）</p></li><li><p>写锁（write lock），也叫排他锁（exclusive lock）当前操作没完成之前，会阻塞其它读和写操作（update、insert、delete）</p></li><li><p>意向共享锁（IS）：一个事务给一个数据行加共享锁时，必须先获得表的IS锁</p></li><li><p>意向排它锁（IX）：一个事务给一个数据行加排他锁时，必须先获得该表的IX锁</p></li></ul><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278200896050.jpg"></p><p>读锁会阻塞写，但不会阻塞读。而写锁则会把读和写都阻塞。</p><h4 id="表锁分析："><a href="#表锁分析：" class="headerlink" title="表锁分析："></a>表锁分析：</h4><p>查看哪些表被锁了：show open tables;</p><p>分析表锁定：show status like &#39;table%&#39;;</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278201278425.jpg"></p><h3 id="页锁"><a href="#页锁" class="headerlink" title="页锁"></a>页锁</h3><p>开销和加锁时间介于行锁和表锁之间，会出现死锁，锁定粒度介于行锁和表锁之间，并发度一般。</p><h3 id="Innodb中的行锁与表锁"><a href="#Innodb中的行锁与表锁" class="headerlink" title="Innodb中的行锁与表锁"></a>Innodb中的行锁与表锁</h3><p>InnoDB行锁是通过给索引上的索引项加锁来实现的，所以只有通过索引条件检索数据，InnoDB才使用行级锁，否则，InnoDB将使用表锁！(索引失效，行锁变表锁)</p><p>当两个事务同时执行，一个锁住了主键索引在等待其他相关索引，一个锁定了非主键索引，在等待主键索引。这样就会发生死锁。</p><p>发生死锁后，InnoDB一般都可以检测到，并使一个事务释放锁回退，另一个获取锁完成事务。</p><p><strong>有多种方法可以避免死锁，这里只介绍常见的三种</strong></p><pre><code>1. 如果不同程序会并发存取多个表，尽量约定以相同的顺序访问表，可以大大降低死锁机会。2. 在同一个事务中，尽可能做到一次锁定所需要的所有资源，减少死锁产生概率；3. 对于非常容易产生死锁的业务部分，可以尝试使用升级锁定颗粒度，通过表级锁定来减少死锁产生的概率；</code></pre><h3 id="MySQL中的共享锁与排他锁"><a href="#MySQL中的共享锁与排他锁" class="headerlink" title="MySQL中的共享锁与排他锁"></a>MySQL中的共享锁与排他锁</h3><h4 id="共享锁-Share-Lock"><a href="#共享锁-Share-Lock" class="headerlink" title="共享锁(Share Lock)"></a>共享锁(Share Lock)</h4><p>共享锁又称为读锁，是读取操作创建的锁。其他用户可以并发读取数据，但任何事物都不能对数据进行修改，直到已释放所有共享锁。</p><ul><li>显式加锁 锁行：SELECT ... LOCK IN SHARE MODE; 锁表：LOCK TABLE XXX READ;(解锁UNLOCK TABLES)</li></ul><h4 id="排他锁（Exclusive-Lock）"><a href="#排他锁（Exclusive-Lock）" class="headerlink" title="排他锁（Exclusive Lock）"></a>排他锁（Exclusive Lock）</h4><p>排他锁又称写锁，如果事务T对数据A加上排他锁后，则其他事务不能再对A加任任何类型的读写。获准排他锁的事务既能读数据，又能修改数据。</p><ul><li>显式加锁 锁行：SELECT ... FOR UPDATE; 锁表：LOCK TABLE XXX WRITE;(解锁UNLOCK TABLES)</li></ul><h3 id="InnoDB的间隙锁："><a href="#InnoDB的间隙锁：" class="headerlink" title="InnoDB的间隙锁："></a>InnoDB的间隙锁：</h3><ul><li>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做”间隙（GAP)”，InnoDB也会对这个”间隙”加锁，这种锁机制就是所谓的间隙锁（Next-Key锁）。</li></ul><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278202632410.jpg"></p><h3 id="深入理解乐观锁与悲观锁"><a href="#深入理解乐观锁与悲观锁" class="headerlink" title="深入理解乐观锁与悲观锁"></a>深入理解乐观锁与悲观锁</h3><pre><code>乐观并发控制(乐观锁)和悲观并发控制（悲观锁）是并发控制主要采用的技术手段。</code></pre><h4 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h4><p>通过开启排他锁的方式实现了悲观锁</p><h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><p>实现数据版本有两种方式，第一种是使用版本号，第二种是使用时间戳。</p><h3 id="深入分析事务的隔离级别"><a href="#深入分析事务的隔离级别" class="headerlink" title="深入分析事务的隔离级别"></a>深入分析事务的隔离级别</h3><h4 id="未提交读-Read-uncommitted"><a href="#未提交读-Read-uncommitted" class="headerlink" title="未提交读(Read uncommitted)"></a>未提交读(Read uncommitted)</h4><p>读未提交是最低级的隔离级别。在这种事物隔离级别下，一个事务可以读到另一个事务未提交数据。</p><h4 id="未提交读会导致脏读"><a href="#未提交读会导致脏读" class="headerlink" title="未提交读会导致脏读"></a>未提交读会导致脏读</h4><p>未提交读的数据库锁情况（实现原理） 事务在读数据的时候并未对数据加锁。<br>事务在修改数据的时候只对数据增加行级共享锁。</p><h4 id="提交读-Read-committed"><a href="#提交读-Read-committed" class="headerlink" title="提交读(Read committed)"></a>提交读(Read committed)</h4><p>在一个事务修改数据过程中，如果事务还没提交，其他事务不能读该数据。</p><p><strong>提交读不能解决不可重复读的读现象（重复读数据会变化）</strong></p><p><strong>提交读的数据库锁情况</strong> 事务对当前被读取的数据加行级共享锁（当读到时才加锁），一旦读完该行，立即释放该行级共享锁；<br>事务在更新某数据的瞬间（就是发生更新的瞬间），必须先对其加行级排他锁，直到事务结束才释放。</p><h4 id="可重复读-Repeatable-reads"><a href="#可重复读-Repeatable-reads" class="headerlink" title="可重复读(Repeatable reads)"></a>可重复读(Repeatable reads)</h4><p>这种隔离级别就叫可重复读（mysql默认隔离级别）</p><p><strong>可重复读不能解决幻读</strong></p><h5 id="MySQL如何解决幻读？"><a href="#MySQL如何解决幻读？" class="headerlink" title="MySQL如何解决幻读？"></a>MySQL如何解决幻读？</h5><p>SERIALIZABLE 串行化</p><p>MVCC + Next-Key Lock</p><p><strong>可重复读的数据库锁情况</strong><br>事务在读取某数据的瞬间（就是开始读取的瞬间），必须先对其加行级共享锁，直到事务结束才释放；<br>事务在更新某数据的瞬间（就是发生更新的瞬间），必须先对其加行级排他锁，直到事务结束才释放。</p><h4 id="可序列化-Serializable"><a href="#可序列化-Serializable" class="headerlink" title="可序列化(Serializable)"></a>可序列化(Serializable)</h4><p>可序列化(Serializable)是最高的隔离级别，前面提到的所有的隔离级别都无法解决的幻读，在可序列化的隔离级别中可以解决。</p><p><strong>可序列化的数据库锁情况</strong><br>事务在读取数据时，必须先对其加 表级共享锁，直到事务结束才释放； 事务在更新数据时，必须先对其加 表级排他锁，直到事务结束才释放。</p><h2 id="MySQL性能优化"><a href="#MySQL性能优化" class="headerlink" title="MySQL性能优化"></a>MySQL性能优化</h2><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278204036880.jpg"></p><h3 id="单条SQL运行慢"><a href="#单条SQL运行慢" class="headerlink" title="单条SQL运行慢"></a>单条SQL运行慢</h3><h4 id="创建并正确使用索引"><a href="#创建并正确使用索引" class="headerlink" title="创建并正确使用索引"></a>创建并正确使用索引</h4><h4 id="数据拆分"><a href="#数据拆分" class="headerlink" title="数据拆分"></a>数据拆分</h4><ol><li><p>垂直拆分：常用字段、不常用字段拆分</p></li><li><p>水平拆分：一张表的数据拆分成多张表存放</p></li></ol><h3 id="部分SQL运行慢"><a href="#部分SQL运行慢" class="headerlink" title="部分SQL运行慢"></a>部分SQL运行慢</h3><h4 id="慢查询分析：开启慢查询日志，分析日志进行优化"><a href="#慢查询分析：开启慢查询日志，分析日志进行优化" class="headerlink" title="慢查询分析：开启慢查询日志，分析日志进行优化"></a>慢查询分析：开启慢查询日志，分析日志进行优化</h4><ul><li>查询是否开启慢查询日志 SHOW VARIABLES LIKE &quot;%slow_query_log%&quot;;</li><li>开启慢查询日志(重启失效) SET GLOBAL slow_query_log&#x3D;1;</li><li>查询慢查询时间阈值 show VARIABLES LIKE &quot;%long_query_time%&quot;;</li><li>设置慢查询时间阈值(重启失效，需要重新开启一个会话才生效) SET GLOBAL long_query_time&#x3D;3; </li><li>慢查询次数 show GLOBAL STATUS LIKE &#39;%Slow_queries%&#39;;</li></ul><h4 id="使用mysqldumpslow做日志分析："><a href="#使用mysqldumpslow做日志分析：" class="headerlink" title="使用mysqldumpslow做日志分析："></a>使用mysqldumpslow做日志分析：</h4><ul><li><p>s：是表示按照何种顺序排序</p></li><li><p>c：访问次数</p></li><li><p>l：锁定时间</p></li><li><p>r：返回记录</p></li><li><p>t：查询时间</p></li><li><p>al：平均锁定时间</p></li><li><p>ar：平均返回记录数</p></li><li><p>at：平均查询时间</p></li><li><p>t：即为返回前面多少条数据</p></li><li><p>g：后边搭配正则表达式，大小写不敏感</p><ol><li>得到返回记录集最多的10个SQL mysqldumpslow -s r -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;xxx-slow.log </li><li>得到访问次数最多的10个SQL mysqldumpslow -s c -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;xxx-slow.log</li><li>得到按照时间排序的前10条里面含有左连接的查询语句 mysqldumpslow -s t -t 10 -g &quot;left join&quot; &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;xxx-slow.log</li><li>另外建议在使用这些命令时结合 | more使用，避免有太多数据 mysqldumpslow -s r -t 10 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F;xxx-slow.log | more</li></ol></li></ul><h4 id="使用show-profile分析SQL："><a href="#使用show-profile分析SQL：" class="headerlink" title="使用show profile分析SQL："></a>使用show profile分析SQL：</h4><ul><li>查询是否开启 SHOW VARIABLES LIKE &#39;profiling&#39;; #开启 SET profiling&#x3D;on;</li><li>查询最近执行sql语句(查询) show PROFILES; #查询某一条sql执行过程 show PROFILE cpu,block io for query 26;</li></ul><h4 id="全局日志查询："><a href="#全局日志查询：" class="headerlink" title="全局日志查询："></a>全局日志查询：</h4><pre><code>开启全局日志 SET GLOBAL general_log=1; 记录在表中 SET GLOBAL log_output=\&#39;TABLE\&#39;; 查询日志 SELECT \* FROM mysql.general_log;</code></pre><h3 id="整个SQL运行慢"><a href="#整个SQL运行慢" class="headerlink" title="整个SQL运行慢"></a>整个SQL运行慢</h3><h4 id="读写分离："><a href="#读写分离：" class="headerlink" title="读写分离："></a>读写分离：</h4><ol><li><p>应用层解决方案：通过应用层对数据源做路由来实现读写分离。</p></li><li><p>中间件解决方案：通过 MySQL 的中间件做主从集群。</p></li></ol><h4 id="EXPLAIN命令："><a href="#EXPLAIN命令：" class="headerlink" title="EXPLAIN命令："></a>EXPLAIN命令：</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278230182764.jpg"></p><ul><li><p><strong>id：相同按顺序执行，不同id越大优先级越高，越先执行</strong></p></li><li><p><strong>select_type:</strong></p><ul><li><p><strong>SIMPLE：简单的select查询，查询中不包含子查询或者union</strong></p></li><li><p><strong>PRIMARY：查询中若包含任何复杂的子部分，最外层查询则被标记为PRIMARY</strong></p></li><li><p><strong>SUBQUERY：在select或where列表中包含了子查询</strong></p></li><li><p><strong>DERIVED：在from列表中包含子查询被标记为derived（衍生），MySQL会递归执行这些子查询，把结果放在临时表中</strong></p></li><li><p><strong>UNION：使用了UNION，第二个select则被标记为UNION，若UNION包含在FROM子查询中，外层SELECT将被标记为：DERIVED</strong></p></li><li><p><strong>UNION RESULT：使用UNION获取结果的查询</strong></p></li></ul></li></ul><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278230552996.jpg"></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278230650553.jpg"></p><ul><li><p><strong>table：表名</strong></p></li><li><p><strong>partitions：表分区</strong></p></li><li><p><strong>type：表示查询类型，从最好到最差：system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL</strong></p><ul><li><p><strong>system：表示只有一行记录（等于系统表），这是const类型的特例，平时不会出现，这个可以忽略不计</strong></p></li><li><p><strong>const：表示通过索引一次就找到了，const出现在primary key或者unique索引，因为只匹配一条数据，所以很快，如将主键置于WHERE条件中查询，MYSQL就能将改查询转换为一个常量</strong></p></li><li><p><strong>eq_ref：唯一性索引扫描，常见于主键或唯一索引扫描</strong></p></li><li><p><strong>ref：非唯一性索引扫描，返回匹配某个单独值的所有行</strong></p></li><li><p><strong>range：检索指定范围的行，使用一个索引来选择行。key列显示使用了哪个索引，一般出现在where中使用between,&lt;,&gt;,in等范围查询</strong></p></li><li><p><strong>index：全索引扫描，index和all的区别为index类型只遍历索引树。这通常比all快，因为索引文件通常比数据文件小。</strong></p></li><li><p><strong>all：全表扫描，性能最差</strong></p></li></ul></li><li><p><strong>possible_key：可能使用的索引</strong></p></li><li><p><strong>key：实际使用的索引，查询中若使用了覆盖索引，则该索引仅出现在key列表中。（覆盖索引：查询的是索引字段）</strong></p></li><li><p><strong>key_len：表示索引中使用的字节数，长度越短越好</strong></p></li><li><p><strong>ref：显示索引的哪一列被使用了，列与索引的比较</strong></p></li><li><p><strong>rows：根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数</strong></p></li><li><p><strong>Extra：额外信息</strong></p><ul><li><p><strong>Using filesort：说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MYSQL中无法利用索引完成的排序操作称为”文件排序”。</strong></p></li><li><p>**Using temporary：使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于排序order</p></li></ul></li></ul><p>by和分组查询group by**</p><pre><code>* **Using Index：表示相应的select操作中使用了覆盖索引（Covering Index），避免访问了表的数据行，效率不错,如果同时出现了using where，表明索引被用来执行索引键值查找。如果没有同时出现using where，表明索引用来读取数据而非执行查找动作。*** **Using where：使用where子句*** **Using join buffer： 使用了连接缓存*** **Using impossible where：表示where子句总是false，查询不到任何数据*** **select tables optimized away：在没有group by子句的情况下基于索引优化MIN/MAX；对于MYISAM储存引擎优化COUNT(\*)操作，不必等到执行阶段再计算，查询执行计划生成的阶段即完成优化。*** **distinct：优化distinct操作，在找到第一匹配的元组后即停止查找同样值的动作**</code></pre><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278232895825.jpg"></p><h2 id="高频面试题"><a href="#高频面试题" class="headerlink" title="高频面试题"></a>高频面试题</h2><h3 id="什么是索引"><a href="#什么是索引" class="headerlink" title="什么是索引"></a>什么是索引</h3><p>索引是一种数据结构，可以帮助我们快速进行数据查找。</p><h3 id="索引是个什么样的数据结构"><a href="#索引是个什么样的数据结构" class="headerlink" title="索引是个什么样的数据结构"></a>索引是个什么样的数据结构</h3><p>索引的数据结构和具有储存引擎的实现有关，在MySQL中使用较多的索引有Hash索引，B+树索引等，而我们经常使用的InnoDB存储引擎的默认索引实现为：B+树索引。</p><h3 id="Hash索引和B-树索引有什么区别或者说优劣"><a href="#Hash索引和B-树索引有什么区别或者说优劣" class="headerlink" title="Hash索引和B+树索引有什么区别或者说优劣"></a>Hash索引和B+树索引有什么区别或者说优劣</h3><p>hash索引底层就是hash表，进行查找时，调用一次hash函数就可以获取到相应的键值，之后进行回表查询获得实际数据；</p><p>B+的底层现实是多路平衡查找树，对于每一次查询都是从根节点出发，查找叶子节点方可以获取的所查键值，然后根据查询判断是否需要回表查询数据。</p><h4 id="不同："><a href="#不同：" class="headerlink" title="不同："></a>不同：</h4><p>hash索引进行等值查询(where xx&#x3D;xx)更快（一般情况下），但是却无法进行范围查询(模糊查询...)。</p><p>因为在hash索引中经过hash函数建立索引之后，索引的顺序与原顺序无法保持一致，不能支持范围查询，而B+树的所有节点皆遵循（左节点小于父节点，右节点大于父节点，多叉树也类似），天然支持范围查询。</p><p>hash索引不支持使用索引排序，原理同上。</p><p>hash索引不支持模糊查询以及多列索引的最左前缀原则，原理也是因为hash函数的不可预测AAAA和AAAAB的索引没有相关性。</p><p>hash索引任何时候都避免不了回表查询数据，而B+树索引在符合某些条件下(聚簇索引，覆盖索引等)的时候可以只通过索引完成查询。</p><p>hash索引在等值查询上较快，但是不稳定，性能不可预测，当某个键值存在大量重复的时候，发生hash碰撞，此时效率可能极差，而B+树的查询比较稳定，对于所有查询都是从根节点到叶子节点，而树的高度较低。</p><p><strong>因此，在大多数情况下，直接使用B+树索引可以获得稳定且较好的查询速度，而不需要使用hash索引。</strong></p><h3 id="什么是聚簇索引"><a href="#什么是聚簇索引" class="headerlink" title="什么是聚簇索引"></a>什么是聚簇索引</h3><p>在B+树的索引中，叶子节点可能存储了当前的key值，也可能存储了当前的key值以及整行数据，这就是聚簇索引和非聚簇索引。</p><p>在InnoDB中，只有主键索引是聚簇索引，如果没有主键，则挑选一个唯一键建立聚簇索引，如果没有唯一键，则隐式的生成一个键来建立聚簇索引。</p><p><strong>当查询使用聚簇索引时，在对应的叶子节点，可以获取整行数据，因此不用再次进行回表查询。</strong></p><h3 id="非聚簇索引一定要回表查询？"><a href="#非聚簇索引一定要回表查询？" class="headerlink" title="非聚簇索引一定要回表查询？"></a>非聚簇索引一定要回表查询？</h3><p>不一定，这涉及到查询语句所要求的字段是否全部命中了索引，那么就不必再进行回表查询。</p><p>select age from employee where age &lt;<br>20;在age字段建立索引，查询age，无需回表查询，在索引的叶子节点上，已经包含了age信息。</p><h3 id="在建立索引的时候，都需要考虑哪些因素"><a href="#在建立索引的时候，都需要考虑哪些因素" class="headerlink" title="在建立索引的时候，都需要考虑哪些因素"></a>在建立索引的时候，都需要考虑哪些因素</h3><p>字段使用的频率。经常作为条件进行查询的字段比较合适，如果需要建立联合索引的话，还需要考虑联合索引的顺序。</p><h3 id="联合索引是什么？为什么需要注意联合索引中的顺序？"><a href="#联合索引是什么？为什么需要注意联合索引中的顺序？" class="headerlink" title="联合索引是什么？为什么需要注意联合索引中的顺序？"></a>联合索引是什么？为什么需要注意联合索引中的顺序？</h3><p>mysql可以使用多个字段同时建立一个索引，叫做联合索引，在联合索引中，如果想要命中索引，需要按照建立索引时的顺序挨个使用，否则无法命中索引。</p><h3 id="怎么知道索引是否被使用？或者说怎么才能知道sql执行慢的原因？"><a href="#怎么知道索引是否被使用？或者说怎么才能知道sql执行慢的原因？" class="headerlink" title="怎么知道索引是否被使用？或者说怎么才能知道sql执行慢的原因？"></a>怎么知道索引是否被使用？或者说怎么才能知道sql执行慢的原因？</h3><p>explain查看执行计划。</p><h3 id="什么时候索引会失效"><a href="#什么时候索引会失效" class="headerlink" title="什么时候索引会失效"></a>什么时候索引会失效</h3><ol><li><p>使用不等号查询</p></li><li><p>列参与了数学运算或者函数</p></li><li><p>like &#39;%xxx&#39;</p></li><li><p>当mysql分析全表扫描比使用索引快的时候</p></li><li><p>当使⽤联合索引,前⾯⼀个条件为范围查询,后⾯的即使符合最左前缀原则,也⽆法使⽤索引</p></li></ol><h3 id="索引有什么劣势"><a href="#索引有什么劣势" class="headerlink" title="索引有什么劣势"></a>索引有什么劣势</h3><ol><li><p>实际上索引也是张表，该表保存了主键和索引字段，并指向实体表记录，所以索引也是要占用空间的。</p></li><li><p>虽然索引大大的提高查询速度，如对表进行INSERT、UPDATE和DELETE。因为更新表时，MYSQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引类的字段，都会调整因为更新所带来的键值变化后的索引信息。</p></li></ol><h4 id="表结构设计"><a href="#表结构设计" class="headerlink" title="表结构设计"></a>表结构设计</h4><p><strong>尽量设置一个主键</strong></p><p><strong>主键使用自增ID</strong></p><p><strong>字段不要定义为null</strong></p><p><strong>存储密码使用char而不是使用varchar</strong></p><h3 id="存储引擎相关"><a href="#存储引擎相关" class="headerlink" title="存储引擎相关"></a>存储引擎相关</h3><h4 id="MySQL支持哪些存储引擎"><a href="#MySQL支持哪些存储引擎" class="headerlink" title="MySQL支持哪些存储引擎"></a>MySQL支持哪些存储引擎</h4><p>InnoDB、MyISAM等等。</p><h4 id="InnoDB和MyISAM的区别"><a href="#InnoDB和MyISAM的区别" class="headerlink" title="InnoDB和MyISAM的区别"></a>InnoDB和MyISAM的区别</h4><ol><li><p>InnoDB支持事务MyISAM不支持。</p></li><li><p>InnoDB支持行级锁，而MyISAM只支持表级锁</p></li><li><p>InnoDB支持MVCC，MyISAM不支持</p></li><li><p>InnoDB支持外键，MyISAM不支持</p></li><li><p>InnoDB不支持全文索引，而MyISAM支持</p></li></ol><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278234762821.jpg"></p><h3 id="零散问题"><a href="#零散问题" class="headerlink" title="零散问题"></a>零散问题</h3><h4 id="MySQL中varchar和char的区别"><a href="#MySQL中varchar和char的区别" class="headerlink" title="MySQL中varchar和char的区别"></a>MySQL中varchar和char的区别</h4><p>char是一个定长字段，假如申请了char(10)的空间，那么无论实际存储多少内容，该字段都占用10个字符；</p><p>而varchar是变长的，也就是说申请的只是最大长度，占用空间为实际字符长度+1，最后一个字符存储使用了多长空间</p><p>在检索效率上，char&gt;varchar，所以如果确定某个字段是定长的，可以使用char，否则尽量使用varchar。例如MD5密码，则应该使用char。</p><h4 id="varchar-10-和int-10-的区别"><a href="#varchar-10-和int-10-的区别" class="headerlink" title="varchar(10)和int(10)的区别"></a>varchar(10)和int(10)的区别</h4><p>varchar的10代表了申请的空间⻓度,也是可以存储的数据的最⼤⻓度,⽽int的10只是代表了展⽰的⻓度,不⾜10位以0填充。</p><p>也就是说,int(1)和int(10)所能存储的数字⼤⼩以及占⽤的空间都是相同的,只是在展⽰时按照⻓度展⽰。</p><h4 id="MySQL的binlog有几种录入格式？"><a href="#MySQL的binlog有几种录入格式？" class="headerlink" title="MySQL的binlog有几种录入格式？"></a>MySQL的binlog有几种录入格式？</h4><p>1）statement：</p><p>2）row：</p><p>3）mixed：</p><h4 id="超大分页怎么处理？"><a href="#超大分页怎么处理？" class="headerlink" title="超大分页怎么处理？"></a>超大分页怎么处理？</h4><p>select * from table where age &gt; 20 limit 1000000,10</p><p>select * from table where id in (select id from table where age &gt; 20<br>limit 1000000,10)</p><p>同时如果ID连续的好,我们还可以 select * from table where id &gt; 1000000<br>limit 10</p><h4 id="数据库三大范式"><a href="#数据库三大范式" class="headerlink" title="数据库三大范式"></a>数据库三大范式</h4><ul><li><p>第一范式：每个列都不可拆分。</p></li><li><p>第二范式：非主键列完全依赖于主键，而不能是依赖于主键的一部分。</p></li><li><p>第三范式：非主键只依赖于主键，不依赖于其他非主键。</p></li></ul><p><strong>在设计数据库结构式，要尽量遵守三范式，如果不遵守，必须有足够的理由。</strong></p><h2 id="MySQL读写分离"><a href="#MySQL读写分离" class="headerlink" title="MySQL读写分离"></a>MySQL读写分离</h2><h3 id="如何实现MySQL的读写分离"><a href="#如何实现MySQL的读写分离" class="headerlink" title="如何实现MySQL的读写分离"></a>如何实现MySQL的读写分离</h3><p>一个主库，多个从库。在主库写，然后主库会自动把数据同步到从库。</p><h3 id="MySQL主从复制的原理"><a href="#MySQL主从复制的原理" class="headerlink" title="MySQL主从复制的原理"></a>MySQL主从复制的原理</h3><p>主库将变更写入binlog日志，然后从库连接主库后，从库有一个IO线程，将主库的binlog日志拷贝到自己本地，写入一个relay中继日志中。接着从库中有一个SQL线程会从中继日志中读取binlog，然后执行binlog日志中的内容，也就是在自己本地执行一遍SQL，</p><p>这样就可以保证主从一致。</p><h3 id="从库执行SQL是串行的，高并发下会有延迟问题"><a href="#从库执行SQL是串行的，高并发下会有延迟问题" class="headerlink" title="从库执行SQL是串行的，高并发下会有延迟问题"></a>从库执行SQL是串行的，高并发下会有延迟问题</h3><p><strong>MySQL主从同步延时问题</strong></p><ol><li><p>分库，将一个主库拆分为多个从库。</p></li><li><p>打开MySQL支持的并行复制。</p></li><li><p>重写代码，不要在写入之后马上查询。</p></li><li><p>如果必须要写入之后马上查询，对这个查询设置直连数据库。</p></li></ol><h2 id="MySQL优化"><a href="#MySQL优化" class="headerlink" title="MySQL优化"></a>MySQL优化</h2><p>【优化总结口诀】</p><p>全值匹配我最爱，最左前缀要遵守；</p><p>带头大哥不能死，中间兄弟不能断；</p><p>索引列上少计算，范围之后全失效；</p><p>Like百分写最右，覆盖索引不写星；</p><p>不等空值还有or，索引失效要少用；</p><p>VARCHAR引号不可丢，SQL高级也不难！</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278235835760.jpg"></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278235919541.jpg"></p><p> EXPLAIN</p><ol><li><p>SQL语句中IN包含的值不应过多</p></li><li><p>SELECT语句务必指明字段名称</p></li><li><p>当只需要一条数据的时候，使用limit 1</p></li><li><p>如果排序字段没有用到索引，就尽量少排序</p></li><li><p>如果限制条件中其他字段没有索引，尽量少用or</p></li><li><p>尽量用union all代替union</p></li><li><p>区分in和exists、not in和not exists(小表驱动大表)</p></li><li><p>B为小表：select * from 表A where id in (select id from 表B)</p><p>A为小表：select * from 表A where exists(select * from 表B where 表B.id&#x3D;表A.id)</p></li><li><p>使用合理的分页方式以提高分页效率</p><p> select id,name from product limit 866613, 20;</p><p> 优化方法：可以将上一页排序字段最大值作为下一页的起点。</p><p> select id,name from product where id&gt; 866612 limit 20;</p></li><li><p>分段查询</p><p>分段查询，最终合并输出。</p></li><li><p>避免在where子句中进行null值判断</p></li><li><p>不建议使用%前缀模糊查询</p><p>例如 LIKE &#39;%name%&#39;</p></li></ol><p> <strong>解决办法：</strong></p><pre><code>1. 使用全文索引:    创建全文索引SQL：ALTER TABLE \`dynamic_201606\` ADD FULLTEXT INDEX \`idx_user_name\` (\`user_name\`);    使用全文索引SQL：select id,fnum,fdst from dynamic_201606 where match(user_name) against(\&#39;zhangsan\&#39; in boolean mode);2. 使用覆盖索引：查询的字段建立索引</code></pre><ol start="13"><li><p>避免在where子句中对字段进行表达式操作</p></li><li><p>避免进行隐式转换（字符串不加单引号导致索引失效）</p><p>SELECT * FROM table WHERE type&#x3D;1;（type为varchar）</p></li><li><p>对于联合索引，要遵守最左前缀原则</p><p>举例来说联合索引含有字段id,name,school，可以直接用id字段，也可以id,name这样的顺序，name,school无法使用这个索引,id,school只能使用id索引。（必须是连续的，中间不能断，WHERE子句中MYSQL优化器会优化顺序）。</p></li><li><p>注意范围查询语句</p><p>对于联合索引，如果存在范围查询，比如between、&gt;、&lt;等条件，会造成后面索引字段失效。</p></li><li><p>关于join优化</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278239298268.jpg"></p><p>1）MySQL没有full join,可以使用union来实现。</p><p>2）尽量使用inner join，因为inner join会自动选择小表作为驱动表。</p><p>3）合理运用索引</p><p>4）利用小表去驱动大表。</p><p>5）巧用STRAIGHT_JOIN：只能在inner join下使用,STRAIGHT_JOIN左边表为驱动表。</p></li><li><p>ORDER BY优化：（MYSQL支持两种排序方式，filesort和Index）</p><ul><li><p>ORDER BY子句，尽量使用INDEX（索引）方式排序，避免使用filesort方式排序</p></li><li><p>尽可能在索引列上完成排序操作，遵循索引的最左前缀原则</p></li><li><p>ORDER BY子句的列满足索引最左前缀原则</p></li><li><p>WHERE子句列和ORDER BY子句列满足索引最左前缀原则</p></li><li><p>无法使用INDEX，FileSort有两种算法：</p><p>  双路排序</p><p>  单路排序</p></li></ul></li></ol><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278240457240.jpg"></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278240554561.jpg"></p><ol start="19"><li><p>GROUP BY优化：（和order by几乎相同）</p><p>group by的实质是先排序后分组，遵循索引最左前缀原则</p><p>当无法使用索引列，增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数设置</p><p>where优先级高于having，能在where限定的条件就不要用having了</p></li></ol><h2 id="MySQL日志"><a href="#MySQL日志" class="headerlink" title="MySQL日志"></a>MySQL日志</h2><h3 id="MySQL逻辑架构"><a href="#MySQL逻辑架构" class="headerlink" title="MySQL逻辑架构"></a>MySQL逻辑架构</h3><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/01/16278241125637.jpg"></p><h4 id="MySQL逻辑架构-1"><a href="#MySQL逻辑架构-1" class="headerlink" title="MySQL逻辑架构"></a>MySQL逻辑架构</h4><p>MySQL的逻辑架构大致可分为三层：</p><p>第一层：处理客户端连接，授权认证，安全校验。</p><p>第二层：服务端server层，负责对SQL解释、分析、优化、执行操作引擎等。</p><p>第三层：存储引擎，负责MySQL中数据的存储和提取。</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/02/16279033382808.jpg" alt="MySQL数据更新流程"></p><h3 id="MySQL日志-1"><a href="#MySQL日志-1" class="headerlink" title="MySQL日志"></a>MySQL日志</h3><h4 id="redo-log（重做日志）"><a href="#redo-log（重做日志）" class="headerlink" title="redo log（重做日志）"></a>redo log（重做日志）</h4><p><strong>redo log</strong>属于MySQL存储引擎<strong>innoDB</strong>的事务日志。</p><p>MySQL的数据是存放在磁盘中的，每次读写数据都需要做磁盘IO操作，如果并发场景下性能就会很差。为此MySQL提供一个优化手段，引入缓存<strong>buffer pool</strong>。这个缓存中包含了磁盘中部分数据页（<strong>page</strong>）的映射，以此来缓解数据库的磁盘压力。</p><p>当从数据库读数据时，首先从缓存中读取，如果缓存中没有，则从磁盘读取后放入缓存；当向数据库写数据时，先向缓存写入，此时缓存中的数据页变更，这个数据页称为<strong>脏页，buff pool</strong>中修改完数据后会按照设定的更新策略，定期刷到磁盘中，这个过程称为<strong>刷脏页</strong>。</p><h5 id="MySQL宕机"><a href="#MySQL宕机" class="headerlink" title="MySQL宕机"></a>MySQL宕机</h5><p>如果刷脏页还未完成，可MySQL由于某些原因宕机重启，此时<strong>buffer pool</strong>中修改的数据还没有来得及刷到磁盘中，就会导致数据丢失，无法保证事务的持久性。</p><p>为了解决这个问题引入了<strong>redo log</strong>，redo Log如其名侧重于重做！它记录的是数据库中每个页的修改，而不是某一行或某几行修改成怎样，可以用来恢复提交后的物理数据页，且只能恢复到最后一次提交的位置。</p><p><strong>redo log</strong>用到了<strong>WAL（Write-Ahead Logging）</strong>技术，这个技术的核心就在于修改记录前，一定要先写日志，并保证日志先落盘，才能算事务提交完成。</p><p>有了redo log再修改数据时，InnoDB引擎会把更新记录先写在redo log中，在修改<strong>Buffer Pool</strong>中的数据，当提交事务时，调用<strong>fsync</strong>把redo log刷入磁盘。至于缓存中更新的数据文件何时刷入磁盘，则由后台线程异步处理。</p><p><strong>注意：</strong>此时redo log的事务状态为prepare，还未真正提交成功。要等到<strong>bin log</strong>日志写入磁盘完成才变更为<strong>commit</strong>，事务才算真正提交完成。</p><p>这样一来即使刷脏页之前MySQL意外宕机也没关系，只要在重启时解析redo log中更改记录进行重放，重新刷盘即可。</p><p><strong>大小固定</strong></p><p>redo log采用固定大小，循环写入的格式，当redo log写满之后，重新从头开始如此循环写，形成一个环状。</p><p>如此设计的原因：</p><p>因为redo log记录的是数据页上的修改，如果<strong>Buffer Pool</strong>中数据页已经刷磁盘了，那么这些日志记录就失效了，新日志会将这些失效的记录进行覆盖擦除。</p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/02/16279035166872.jpg"></p><ul><li>图中的<strong>write pos</strong>表示redo log当前记录的日志序列号<strong>LSN</strong>(log sequence number)，写入还未刷盘，循环往后递增；<strong>check point</strong>表示redo log中修改记录已刷入磁盘后的LSN，循环往后递增，这个LSN之前的数据已经全落盘。</li><li><strong>write pos</strong>到<strong>check point</strong>之间的部分是redo log空余的部分（绿色），用来记录新的日志；<strong>check point</strong>到<strong>write pos</strong>之间是redo log已经记录的数据页修改数据，此时数据页还未刷回磁盘的部分。当<strong>write pos</strong>追上<strong>check point</strong>时，会先推动<strong>check point</strong>向前移动，空出位置（刷盘）再记录新的日志。</li></ul><p><strong>注意：</strong><br>redo log日志满了，在擦除之前，需要确保这些要被擦除记录对应在内存中的数据页都已经刷到磁盘中了。擦除旧记录腾出新空间这段期间，是不能再接收新的更新请求的，此刻MySQL的性能会下降。所以在并发量大的情况下，合理调整redo log的文件大小非常重要。</p><blockquote><p>crash-safe<br>因为redo log的存在使得Innodb引擎具有了crash-safe的能力，即MySQL宕机重启，系统会自动去检查redo log，将修改还未写入磁盘的数据从redo log恢复到MySQL中。</p></blockquote><p>MySQL启动时，不管上次是正常关闭还是异常关闭，总是会进行恢复操作。会先检查数据页中的LSN，如果这个LSN 小于 redo log 中的LSN，即write pos位置，说明在redo log上记录着数据页上尚未完成的操作，接着就会从最近的一个check point出发，开始同步数据。</p><p>简单理解，比如：redo log的LSN是500，数据页的LSN是300，表明重启前有部分数据未完全刷入到磁盘中，那么系统则将redo log中LSN序号300到500的记录进行重放刷盘。</p><h4 id="undo-log（回滚日志）"><a href="#undo-log（回滚日志）" class="headerlink" title="undo log（回滚日志）"></a>undo log（回滚日志）</h4><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/02/16279037077440.jpg"></p><p>undo log</p><p><strong>undo log</strong>也是属于MySQL存储引擎InnoDB的事务日志。</p><p>undo log属于逻辑日志，如其名主要起到回滚的作用，它是保证事务原子性的关键。记录的是数据修改前的状态，在数据修改的流程中，同时会记录一条与当前操作相反的逻辑日志到undo log中。<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/02/16279037334256.jpg"></p><p>同一个事物内的一条记录被多次修改，不会把每次数据修改前的状态都写入undo log；undo log只负责记录事务开始前要修改数据的原始版本，当我们再次对这行数据进行修改，所产生的修改记录会写入到redo log，undo log负责完成回滚，redo log负责完成前滚。</p><p>回滚</p><p>未提交的事务，即事务未执行commit。但该事务内修改的脏页中，可能有一部分脏块已经刷盘。如果此时数据库实例宕机重启，就需要用回滚来将先前那部分已经刷盘的脏块从磁盘上撤销。</p><p>前滚</p><p>未完全提交的事务，即事务已经执行commit，但该事务内修改的脏页中只有一部分数据被刷盘，另外一部分还在buffer pool缓存上，如果此时数据库实例宕机重启，就需要用前滚来完成未完全提交的事务。将先前那部分由于宕机在内存上的未来得及刷盘数据，从redo log中恢复出来并刷入磁盘。</p><p><strong>数据库实例恢复时，先做前滚，后做回滚。</strong></p><h4 id="bin-log（归档日志）"><a href="#bin-log（归档日志）" class="headerlink" title="bin log（归档日志）"></a>bin log（归档日志）</h4><p><strong>bin log</strong>是一种数据库Server层（和什么引擎无关），以二进制形式存储在磁盘中的逻辑日志。bin log记录了数据库所有DDL和DML操作（不包含 SELECT 和 SHOW等命令，因为这类操作对数据本身并没有修改）。</p><p>默认情况下，二进制日志功能是关闭的。可以通过以下命令查看二进制日志是否开启：</p><p>SHOW VARIABLES LIKE &#39;log_bin&#39;;</p><p>bin log也被叫做归档日志，因为它不会像redo log那样循环写擦除之前的记录，而是会一直记录日志。一个bin log日志文件默认最大容量1G（也可以通过max_binlog_size参数修改），单个日志超过最大值，则会新创建一个文件继续写。</p><p>show binary logs;</p><p>bin log日志的内容格式其实就是执行SQL命令的反向逻辑，这点和undo log有点类似。一般来说开启bin log都会给日志文件设置过期时间（expire_logs_days参数，默认永久保存），要不然日志的体量会非常庞大。</p><p>show variables like &#39;expire_logs_days&#39;;</p><p>bin log主要应用于MySQL主从模式（master-slave）中，主从节点间的数据同步；以及基于时间点的数据还原。</p><p><strong>bin log和redo log的区别</strong></p><ul><li><p>层次不同：redo log 是InnoDB存储引擎实现的，bin log是MySQL的服务器层实现的，但MySQL数据库中的任何存储引擎对于数据库的更改都会产生bin log。</p></li><li><p>作用不同：redo log 用于碰撞恢复（crash recovery），保证MySQL宕机也不会影响持久性；bin log用于时间点恢复（point-in-time recovery），保证服务器可以基于时间点恢复数据和主从复制。</p></li><li><p>内容不同：redo log 是物理日志，内容基于磁盘的页Page；bin log的内容是二进制，可以根据binlog_format参数自行设置。</p></li><li><p>写入方式不同：redo log 采用循环写的方式记录；binlog 通过追加的方式记录，当文件大小大于给定值后，后续的日志会记录到新的文件上。</p></li><li><p>刷盘时机不同：bin log在事务提交时写入；redo log 在事务开始时即开始写入。</p></li></ul><p><strong>bin log 与 redo log功能并不冲突而是起到相辅相成的作用，需要二者同时记录，才能保证当数据库发生宕机重启时，数据不会丢失。</strong></p><p><strong>relay log（中继日志）</strong></p><p>relay log日志文件具有与bin log日志文件相同的格式，从上边MySQL主从复制的流程可以看出，relay log起到一个中转的作用，slave先从主库master读取二进制日志数据，写入从库本地，后续再异步由SQL线程读取解析relay log为对应的SQL命令执行。</p><h4 id="slow-query-log"><a href="#slow-query-log" class="headerlink" title="slow query log"></a>slow query log</h4><p>慢查询日志（slow query log）: 用来记录在 MySQL中执行时间超过指定时间的查询语句，在 SQL<br>优化过程中会经常使用到。通过慢查询日志，我们可以查找出哪些查询语句的执行效率低，耗时严重。</p><p>出于性能方面的考虑，一般只有在排查慢SQL、调试参数时才会开启，默认情况下，慢查询日志功能是关闭的。可以通过以下命令查看是否开启慢查询日志：</p><p>SHOW VARIABLES LIKE &#39;slow_query%&#39;;</p><h4 id="general-query-log"><a href="#general-query-log" class="headerlink" title="general query log"></a>general query log</h4><p>一般查询日志（general query log）：用来记录用户的所有操作，包括客户端何时连接了服务器、客户端发送的所有SQL以及其他事件，比如MySQL服务启动和关闭等等。MySQL服务器会按照它接收到语句的先后顺序写入日志文件。</p><p>由于一般查询日志记录的内容过于详细，开启后 Log文件的体量会非常庞大，所以出于对性能的考虑，默认情况下，该日志功能是关闭的，通常会在排查故障需获得详细日志的时候才会临时开启。</p><p>show variables like &#39;general_log&#39;;</p><h4 id="error-log"><a href="#error-log" class="headerlink" title="error log"></a>error log</h4><p>错误日志（error log）: 应该是 MySQL 中最好理解的一种日志，主要记录 MySQL服务器每次启动和停止的时间以及诊断和出错信息。</p><p>默认情况下，该日志功能是开启的，通过如下命令查找错误日志文件的存放路径。</p><p>SHOW VARIABLES LIKE &#39;log_error&#39;;</p><p><strong>注意：</strong>错误日志中记录的可并非全是错误信息，像 MySQL 如何启动 InnoDB的表空间文件、如何初始化自己的存储引擎，初始化 buffer pool等等，这些也记录在错误日志文件中。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;事务&quot;&gt;&lt;a href=&quot;#事务&quot; class=&quot;headerlink&quot; title=&quot;事务&quot;&gt;&lt;/a&gt;事务&lt;/h2&gt;&lt;h3 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h3&gt;&lt;pre&gt;&lt;code&gt;一个数据库事务通常包含对数据库进行读或写的一个操作序列。它的存在包含有以下两个目的：
    1. 为数据库操作提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态下仍能保持一致性的方法。
    2. 当多个应用程序在并发访问数据库时，可以在这些应用程序之间提供一个隔离方法，以防止彼此的操作互相干扰。
&lt;/code&gt;&lt;/pre&gt;</summary>
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="MySQL" scheme="https://yangh124.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>RabbitMQ</title>
    <link href="https://yangh124.github.io/2021/07/31/RabbitMQ/"/>
    <id>https://yangh124.github.io/2021/07/31/RabbitMQ/</id>
    <published>2021-07-30T16:00:00.000Z</published>
    <updated>2024-10-06T04:17:44.123Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>RabbitMQ是最受欢迎的开源消息中间件之一，在全球范围内被广泛应用。RabbitMQ是轻量级且易于部署的，能支持多种消息协议。RabbitMQ可以部署在分布式系统中，以满足大规模、高可用的要求。</p><span id="more"></span><h2 id="安装及配置"><a href="#安装及配置" class="headerlink" title="安装及配置"></a>安装及配置</h2><h3 id="Linux安装："><a href="#Linux安装：" class="headerlink" title="Linux安装："></a>Linux安装：</h3><p>下载docker镜像</p><pre><code>docker pull rabbitmq:3.7.15</code></pre><p>使用docker命令启动服务</p><pre><code>docker run -d -p 5672:5672 -p 15672:15672 --name rabbitmq rabbitmq:3.7.15</code></pre><p>进入容器并开启管理功能</p><pre><code>docker exec -it rabbitmq /bin/bash rabbitmq-plugins enable rabbitmq_management</code></pre><p>开启防火墙便于外网访问</p><h3 id="访问及配置"><a href="#访问及配置" class="headerlink" title="访问及配置"></a>访问及配置</h3><ol><li>访问RabbitMQ管理页面地址，查看是否安装成功（Linux下使用服务器IP访问即可）：<a href="http://localhost:15672/">http://localhost:15672</a></li><li>输入账号密码并登录，这里使用默认账号密码登录：guest guest</li><li>创建帐号并设置其角色为管理员：yh yh<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291220880322.jpg" alt="16291220880322"></li><li>创建一个新的虚拟host为：&#x2F;yh<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291221215137.jpg" alt="16291221215137"></li><li>点击yh用户，给yh用户配置该虚拟host的权限；<br><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291221501459.jpg" alt="16291221501459"></li><li>至此，RabbitMQ的配置完成。</li></ol><h2 id="RabbitMQ简介"><a href="#RabbitMQ简介" class="headerlink" title="RabbitMQ简介"></a>RabbitMQ简介</h2><p>RabbitMQ是一个由erlang开发的AMQP(Advanced Message Queue Protocol)的开源实现。</p><h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><blockquote><p>消息，消息是不具名的，它由消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括routing-key（路由键）、priority（相对于其他消息的优先权）、delivery-mode（指出该消息可能需要持久性储存）等。</p></blockquote><h4 id="Publish"><a href="#Publish" class="headerlink" title="Publish"></a>Publish</h4><blockquote><p>消息的生产者，也是一个向交换器发布消息的客户端应用程序。</p></blockquote><h4 id="Exchange"><a href="#Exchange" class="headerlink" title="Exchange"></a>Exchange</h4><blockquote><p>交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。Exchange有4种类型：direct（默认），fanout，topic和headers，不同类型的Exchange转发消息的策略有所区别</p></blockquote><h4 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h4><blockquote><p>消息队列，用来保存消息直到发送给消费者，它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里面，等待消费者连接到这个队列将其取走。</p></blockquote><h4 id="Binding"><a href="#Binding" class="headerlink" title="Binding"></a>Binding</h4><blockquote><p>绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交换器理解为一个由绑定构成的路由表。Exchange和Queue的绑定可以是多对多的关系。</p></blockquote><h4 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h4><blockquote><p>网络连接，比如一个TCP连接。</p></blockquote><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><blockquote><p>信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内的虚拟连接，AMQP命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些都是通过信道完成的。因为对于操作系统来说建立和销毁TCP都是非常昂贵的开销，所以引入信道的概念，以复用一条TCP连接。</p></blockquote><h4 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h4><blockquote><p>消息的消费者，表示一个从消息队列中取得消息的客户端应用程序。</p></blockquote><h4 id="Virtual-Host"><a href="#Virtual-Host" class="headerlink" title="Virtual Host"></a>Virtual Host</h4><blockquote><p>虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同身份认证和加密环境的独立服务器域。每个vhost本质上就是一个mini版的RabbitMQ服务器，拥有自己的队列、交换器、绑定和权限机制。vhost是AMQP概念的基础，必须在连接时指定，默认的vhost是&#x2F;。</p></blockquote><h4 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h4><blockquote><p>表示消息队列服务器实体</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291223199643.jpg" alt="16291223199643"></p><h3 id="5种消息模式"><a href="#5种消息模式" class="headerlink" title="5种消息模式"></a>5种消息模式</h3><h4 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a>简单模式</h4><blockquote><p>简单模式是最简单的消息模式，它包含一个生产者、一个消费者和一个队列。生产者向队列里发送消息，消费者从队列中获取消息并消费。</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291223509014.jpg" alt="16291223509014"></p><h4 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h4><blockquote><p>工作模式是指向多个互相竞争的消费者发送消息的模式，它包含一个生产者、两个消费者和一个队列。两个消费者同时绑定到一个队列上去，当消费者获取消息处理耗时任务时，空闲的消费者从队列中获取并消费消息。</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291223898130.jpg" alt="16291223898130"></p><h4 id="发布-订阅模式（fanout）"><a href="#发布-订阅模式（fanout）" class="headerlink" title="发布&#x2F;订阅模式（fanout）"></a>发布&#x2F;订阅模式（fanout）</h4><blockquote><p>发布&#x2F;订阅模式是指同时向多个消费者发送消息的模式（类似广播的形式），它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列绑定到交换机上去，生产者通过发送消息到交换机，所有消费者接收并消费消息。</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291224068875.jpg" alt="16291224068875"></p><h4 id="路由模式（direct）"><a href="#路由模式（direct）" class="headerlink" title="路由模式（direct）"></a>路由模式（direct）</h4><blockquote><p>路由模式是可以根据路由键选择性给多个消费者发送消息的模式，它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列通过路由键绑定到交换机上去，生产者发送消息到交换机，交换机通过路由键转发到不同队列，队列绑定的消费者接收并消费消息。</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291224228449.jpg" alt="16291224228449"></p><h4 id="通配符模式（topic）"><a href="#通配符模式（topic）" class="headerlink" title="通配符模式（topic）"></a>通配符模式（topic）</h4><blockquote><p>通配符模式是可以根据路由键匹配规则选择性给多个消费者发送消息的模式，它包含一个生产者、两个消费者、两个队列和一个交换机。两个消费者同时绑定到不同的队列上去，两个队列通过路由键匹配规则绑定到交换机上去，生产者发送消息到交换机，交换机通过路由键匹配规则转发到不同队列，队列绑定的消费者接收并消费消息。</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291224454336.jpg" alt="16291224454336"></p><h4 id="header模式（header）"><a href="#header模式（header）" class="headerlink" title="header模式（header）"></a>header模式（header）</h4><p>header模式与routing不同的地方在于，header模式取消routingkey，使用header中的<br>key&#x2F;value（键值对）匹配队列。</p><h4 id="RPC模式（direct）"><a href="#RPC模式（direct）" class="headerlink" title="RPC模式（direct）"></a>RPC模式（direct）</h4><blockquote><p>1、客户端即是生产者就是消费者，向RPC请求队列发送RPC调用消息，同时监听RPC响应队列。</p><p>2、服务端监听RPC请求队列的消息，收到消息后执行服务端的方法，得到方法返回的结果。</p><p>3、服务端将RPC方法 的结果发送到RPC响应队列。</p><p>4、客户端（RPC调用方）监听RPC响应队列，接收到RPC调用结果。</p></blockquote><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291225166457.jpg" alt="16291225166457"></p><h2 id="消息确认机制-可靠抵达"><a href="#消息确认机制-可靠抵达" class="headerlink" title="消息确认机制-可靠抵达"></a>消息确认机制-可靠抵达</h2><blockquote><p>保证消息不丢失，可靠抵达，可以使用事务消息，性能下降250倍，为此引入确认机制</p></blockquote><ul><li><p><strong>publish</strong> cornfirmCallback确认模式</p></li><li><p><strong>publish</strong> returnCallback未投递到queue退回模式</p></li><li><p><strong>consumer</strong> ack机制</p></li></ul><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291226024394.jpg" alt="16291226024394"></p><p><img src="https://yh-blog-files.oss-cn-hangzhou.aliyuncs.com/2021/08/16/16291226225999.jpg" alt="16291226225999"></p><h2 id="如何保证消息可靠性-消息丢失"><a href="#如何保证消息可靠性-消息丢失" class="headerlink" title="如何保证消息可靠性-消息丢失"></a>如何保证消息可靠性-消息丢失</h2><h3 id="1-消息丢失"><a href="#1-消息丢失" class="headerlink" title="1.消息丢失"></a>1.消息丢失</h3><blockquote><p>消息发送出去，由于网络原因未到达服务器</p></blockquote><ul><li><p>做好容错方法，发送消息可能会网络失败，失败后要去重试机制，可记录到数据库，定期重发</p></li><li><p>做好日志记录，每个消息状态是否被服务器收到都应该记录</p></li><li><p>做好定期重发，如果消息发送成功，定期去数据库扫描未成功发送的消息进行重发</p></li></ul><blockquote><p>消息抵达Broker，Broker要将消息持久化才算成功。此时如果宕机，消息持久化未完成</p></blockquote><ul><li>publisher也必须加入确认回调机制，确认成功的消息，修改数据库消息状态</li></ul><blockquote><p>自动ack的状态下。消费者收到消息，但没来得及处理消息，宕机</p></blockquote><ul><li>开启手动ack，消费成功才移除，消费失败就noack并重新入队</li></ul><h3 id="2-消息重复"><a href="#2-消息重复" class="headerlink" title="2.消息重复"></a>2.消息重复</h3><blockquote><p>消息消费成功，但是手动ack时宕机，导致ack失败，消息被发送给其他消费者</p></blockquote><blockquote><p>消息消费失败，由于重试机制，自动又将消息发出去</p></blockquote><ul><li><p>保证消费业务接口幂等性，处理过了就不处理了</p></li><li><p>rabbitmq的每一个消息都有redelivered字段，可以获取是否被重新投递过来的，而不是第一次投递</p></li></ul><h3 id="3-消息积压"><a href="#3-消息积压" class="headerlink" title="3.消息积压"></a>3.消息积压</h3><blockquote><p>消费者宕机</p></blockquote><blockquote><p>消费者消费能力不足</p></blockquote><blockquote><p>发送者发送流量过大</p></blockquote><ul><li><p>上线更多消费者</p></li><li><p>先将消息记录到数据库，再慢慢处理</p></li></ul><h3 id="RabbitMQ延时队列（实现定时任务）"><a href="#RabbitMQ延时队列（实现定时任务）" class="headerlink" title="RabbitMQ延时队列（实现定时任务）"></a>RabbitMQ延时队列（实现定时任务）</h3><blockquote><p>场景：比如未付款订单，超时一定时间后，系统自动取消订单并释放库存。</p></blockquote><h4 id="常用解决方案："><a href="#常用解决方案：" class="headerlink" title="常用解决方案："></a>常用解决方案：</h4><p>spring Schedule定时任务轮询数据库</p><p><strong>缺点：</strong></p><p>消耗系统内存，增加数据库压力，存在时间误差</p><p><strong>解决：RabbitMQ的消息ttl和死信Exchange结合</strong></p><h4 id="消息的TTL（Time-To-Live）"><a href="#消息的TTL（Time-To-Live）" class="headerlink" title="消息的TTL（Time To Live）"></a>消息的TTL（Time To Live）</h4><ul><li><p>消息TTL就是消息的存活时间</p></li><li><p>RabbitMQ可以对队列和消息分别设置TTL</p></li><li><p>对队列设置就是队列没有消费者连着的保留时间，也可以对每个单独的消息做单独的设置。超过这个时间，我们认为消息死了，称之为死信。</p></li><li><p>如果队列设置了。消息也设置了，那么会取小的。所以一个消息如果被路由到不同的队列，这个消息的死亡的时间可能不一样（不同队列设置）。这里单讲单个消息的TTL因为它才是实现延迟任务的关键。可以通过设置消息expiration字段或者x-message-ttl属性来设置时间，两者是一样的效果。</p></li></ul><h4 id="Dead-Letter-Exchanges-DLX"><a href="#Dead-Letter-Exchanges-DLX" class="headerlink" title="Dead Letter Exchanges(DLX)"></a>Dead Letter Exchanges(DLX)</h4><ul><li><p>一个消息在满足如下条件下，会进入死信路由，记住这里是路由不是队列，一个路由可以应对很多队列。（什么是死信）</p></li><li><p>一个消息被消费者拒收了，并且reject方法的参数是requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。（basicNack&#x2F;basicReject）requeue&#x3D;false</p></li><li><p>上面的消息ttl到了，消息过期</p></li><li><p>队列的长度限制满了。排在前面的消息会被丢弃或扔到死信路由</p></li><li><p>Dead Letter Exchange其实就是一个普通的exchange，和创建其他exchange没两样。只是在某一个设置Dead<br>Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p></li><li><p>我们既可以控制消息在一段时间后变成死信，又可以控制变成死信的消息被路由到某一个指定的exchange，结合二者，就可以实现一个延迟队列。</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;RabbitMQ是最受欢迎的开源消息中间件之一，在全球范围内被广泛应用。RabbitMQ是轻量级且易于部署的，能支持多种消息协议。RabbitMQ可以部署在分布式系统中，以满足大规模、高可用的要求。&lt;/p&gt;</summary>
    
    
    
    <category term="后端" scheme="https://yangh124.github.io/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
    <category term="消息队列" scheme="https://yangh124.github.io/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
  </entry>
  
</feed>
